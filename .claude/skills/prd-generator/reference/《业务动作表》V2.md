# 标准版-业务动作表

本文档整合了开票相关的9个核心功能v2版本，包括：开具发票、同步税局发票、打印发票、交付发票文件、下载发票文件至本地、导出发票数据、预览发票文件、作废发票、红冲发票。

---

## 开具发票

| 参数名称           | 参数说明                                    | 示例内容                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| -------------- | --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 动作ID           | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成            | **[优化]** INVOICE_ISSUE_BLUE（蓝票开具）<br>INVOICE_ISSUE_RED（红票开具）<br>**[依据]** 产品建议1.1，需补充符合业务场景+动作类型命名规范的唯一标识                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 动作名称           | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义        | **[优化]** Issue_Blue_Invoice (开具蓝字发票)<br>Issue_Red_Invoice (开具红字发票)<br>**[依据]** 产品建议2.1，需按开票类型细化动作名称，体现更精准的动作核心操作                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 目标对象类型         | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致        | **[优化]** OutputInvoice（销项发票）<br>**[依据]** 需与数据模型中实体定义完全一致                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 动作目的与描述        | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果         | 用户在开具发票页面填写完整的发票信息（购方信息、销方信息、商品明细等）后，提交开票请求，系统调用税控设备或托管服务完成发票开具，并将发票数据保存到数据库，同时生成电子发票文件。支持蓝票和红票两种开票类型，蓝票用于正常销售开票，红票用于冲红原发票。开票成功后自动生成发票流水号（20位唯一标识），并根据企业配置自动发送邮件/短信通知。                                                                                                                                                                                                                                                                                                                                                                                          |
| 输入参数           | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 1. invoiceType（发票类型）：必填<br>2. kplx（开票类型）：必填，**固定取值0=蓝票或1=红票**<br>3. ghf_mc（购方名称）：必填<br>4. ghf_nsrsbh（购方纳税人识别号）：专票必填<br>5. ghf_dzdh（购方地址电话）：专票必填<br>6. ghf_yhzh（购方开户行及账号）：专票必填<br>7. ghf_sj（购方手机号）：可选<br>8. email（购方邮箱）：可选<br>9. items（发票明细行数组）：必填，**合计金额必须>0**<br>10. hsbz（含税标志）：必填<br>11. xhf_mc（销方名称）：必填<br>12. xhf_nsrsbh（销方纳税人识别号）：必填<br>13. xhf_dzdh（销方地址电话）：必填<br>14. xhf_yhzh（销方开户行及账号）：必填<br>15. kpy（开票员）：必填<br>16. sky（收款人）：必填<br>17. fhr（复核人）：必填<br>18. bz（备注）：可选<br>19. taxDiskNo（税盘号）：必填<br>**[依据]** 产品建议3.1-3.2，需明确kplx固定取值、补充items合计金额约束 |
| 输入约束           | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值            | **[优化]** 1. invoiceType：枚举值（1=电子普票, 2=纸质专票, 3=纸质普票, 4=纸质专票卷票, 26=数电普票, 27=数电专票）<br>2. kplx：**强制取值0（蓝票）或1（红票）**<br>3. ghf_mc：必填，长度不超过100字节，**不能包含特殊字符（如<>等）**<br>4. ghf_nsrsbh：专票必填，长度15-20位<br>5. ghf_dzdh：专票必填，长度不超过100字节<br>6. ghf_yhzh：专票必填，长度不超过100字节<br>7. items：必填，至少包含1行明细，每行必须包含xmmc（项目名称）、ssflbm（税收分类编码）、sl（税率），**合计金额必须>0**<br>8. hsbz：枚举值（0=不含税, 1=含税）<br>9. kpy、sky、fhr：必填，长度不超过50字节<br>10. taxDiskNo：必填，关联企业已配置的税盘设备<br>**[依据]** 产品建议4.1-4.3，需补充购方名称特殊字符约束、kplx强制取值、items合计金额>0约束                                                                  |
| 提交准则           | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 1. 专票必须填写购方"纳税人识别号"、"地址电话"、"开户行及账号"<br>2. 发票明细行的金额=数量×单价（允许±0.01尾差）<br>3. 发票明细行的税额计算正确（允许±0.06尾差）<br>4. 合计金额=所有明细行金额之和<br>5. 合计税额=所有明细行税额之和<br>6. 价税合计=合计金额+合计税额<br>7. **合计金额必须大于0**<br>8. 企业必须已配置税控设备或开通托管服务<br>9. 税盘状态正常且有可用发票余量<br>10. 手机号码格式正确（如有填写）<br>11. 邮箱地址格式正确（如有填写）<br>12. 购方名称不能包含特殊字符（如<>等）<br>13. 每行明细的税收分类编码必须有效<br>**[依据]** 产品建议5.1，需补充合计金额>0的硬性条件                                                                                                                                                                                     |
| 输出参数（属性修改逻辑）   | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"   | **[优化]** 1. 发票状态：'待开票' → '已开票'<br>2. 发票代码（fpdm）：写入税控设备或托管平台返回的发票代码<br>3. 发票号码（fphm）：写入税控设备或托管平台返回的发票号码<br>4. 开票时间（kprq）：写入服务器当前时间<br>5. 发票流水号（fpqqlsh）：生成唯一流水号（20位：税控类型1位+时间戳13位+随机数6位），**蓝票和红票使用相同生成规则**<br>6. PDF文件地址（pdfUrl）：电子发票生成PDF后写入文件地址<br>7. OFD文件地址（ofdUrl）：数电发票生成OFD后写入文件地址<br>8. 订单状态：如为订单开票，更新订单状态为"已开票"<br>**[依据]** 产品建议7.1-7.2，需明确发票流水号生成规则不区分开票类型、发票代码号码写入来源包含平台返回                                                                                                                                                                             |
| 输出参数（执行结果/返回值） | 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型         | 1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. invoiceCode：String（发票代码）<br>4. invoiceNo：String（发票号码）<br>5. serialNo：String（发票流水号，20位）<br>6. pdfUrl：String（PDF文件下载地址，电子发票）<br>7. ofdUrl：String（OFD文件下载地址，数电发票）<br>8. invoiceDate：String（开票日期，格式：YYYY-MM-DD）<br>9. qrCode：String（二维码内容）                                                                                                                                                                                                                                             |

---

## 同步税局发票

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_SYNC_TAX<br>**[依据]** 产品建议1.1-1.2，需补充系统唯一标识 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Sync_Tax_Invoice (同步税局发票)                                          |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice（销项发票）<br>**[依据]** 产品建议2.1-2.2，需与数据模型中OutputInvoice实体定义一致 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | 用户在开票查询页面选择同步时间范围或指定发票代码号码，系统从税局端（联云托管平台或本地税控设备）同步发票数据到系统数据库，确保系统发票数据与税局端保持一致。同步操作会更新已存在的发票数据，新增不存在的发票数据，保持与税局端数据一致。仅支持联云托管（depositType=8）的税盘进行同步，其他类型税盘不支持通过此功能同步。 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 1. startDate（开始日期）：必填<br>2. endDate（结束日期）：必填<br>3. invoiceType（发票类型）：**必填**<br>4. invoiceCode（发票代码）：可选<br>5. invoiceNo（发票号码）：可选<br>6. taxDiskNo（税盘号）：必填<br>7. companyId（企业ID）：必填<br>**[依据]** 产品建议3.1-3.2，需明确invoiceType必填性、补充companyId参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | **[优化]** 1. startDate：必填，日期格式YYYY-MM-DD<br>2. endDate：必填，日期格式YYYY-MM-DD，结束日期不能早于开始日期<br>3. 日期范围：最大跨度31天<br>4. invoiceType：必填，枚举值（1=电子普票, 2=电子专票, 3=纸质普票, 4=纸质专票），多个用逗号分隔<br>5. invoiceCode：可选，当填写发票号码时必填，长度10-12位<br>6. invoiceNo：可选，当填写发票代码时必填，长度8位<br>7. taxDiskNo：必填，关联企业已配置的税盘设备<br>8. companyId：**必填，必须存在于系统中且用户有权限访问**<br>9. 仅支持联云托管（depositType=8）的税盘进行同步<br>**[依据]** 产品建议4.1-4.2，需补充companyId有效性约束、明确前端如何结合企业配置计算托管类型 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 1. 企业必须已配置联云托管税盘（depositType=8）<br>2. 税盘状态正常且可访问<br>3. 开始日期和结束日期必须有效<br>4. 日期范围不超过31天<br>5. 如填写发票代码和号码，必须同时填写且格式正确<br>6. 如填写发票代码和号码，必须选择发票类型<br>7. 当前时间段未在同步中（避免重复同步）<br>8. **当前用户必须具备对应企业的操作权限**<br>9. **排除非托管模式（如本地盘）的同步限制，仅支持联云托管模式**<br>**[依据]** 产品建议5.1-5.2，需补充用户权限校验、明确仅支持联云托管模式的完整约束 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | **[优化]** 1. 发票数据：从税局端同步到invoice_success表<br>2. 发票明细：从税局端同步到invoice_itemssuccess表<br>3. 同步记录：写入reconciliation_record表，记录同步时间、同步数量、企业ID<br>4. 已存在的发票数据：**更新为税局端最新数据（包括发票状态、购买方信息、金额税额等核心字段）**<br>5. 新增的发票数据：插入到数据库<br>6. **发票状态更新规则**：同步税局端状态（如已作废status=2、已红冲status=3等）<br>**[依据]** 产品建议6.1-6.2，需明确发票状态更新规则、补充发票核心字段同步规则 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 1. errcode：String（0000=成功，0001=下载中，0002=处理中，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Object（结构化数据对象）<br>   - syncCount：Integer（同步更新的发票数量）<br>   - taskId：String（异步任务ID，当errcode=0001/0002时返回）<br>**[依据]** 产品建议7.1-7.2，需补充返回数据完整性、明确各错误码对应的业务场景 |

---

## 打印发票

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_PRINT_ELECTRONIC（电票打印）、INVOICE_PRINT_PAPER（纸票打印）<br>**[依据]** 产品建议1.1，需区分电票/纸票不同场景 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Print_Invoice (打印发票)                                                  |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice（销项发票）、OutputInvoiceFileModel（发票文件模型）<br>**[依据]** 产品建议3.1-3.2，需精准定义业务实体 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在发票列表中选择已开具的发票，调用打印接口将发票内容打印输出。支持两类打印场景：<br>1. **电子发票打印**：批量获取电票版式文件（PDF/OFD）下载链接，前端打开浏览器窗口或触发下载，用户通过浏览器打印功能完成打印<br>2. **纸质发票打印**：支持4种打印方式（A9打印、本地打印、云打印套打、联云打印），通过税控设备或托管平台将发票内容打印到纸质发票上，打印成功后更新发票打印状态，防止跳号<br>**[依据]** 产品建议4.1-4.2，需补充电票打印场景描述 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 电子发票打印参数：<br>1. serialNoList（发票流水号列表）：必填，批量打印时传入多个流水号<br>2. invoiceType（发票类型）：枚举值（1=电子普票, 2=电子专票, 26=数电普票, 27=数电专票）<br><br>纸质发票打印参数：<br>1. serialNo（发票流水号）：必填，20位<br>2. invoiceCode（发票代码）：必填，12位<br>3. invoiceNo（发票号码）：必填，8位<br>4. printType（打印类型）：枚举值（1=A9打印, 2=本地打印, 3=云打印套打, 4=联云打印）<br>5. taxDiskNo（税盘号）：必填<br>6. invoiceType（发票类型）：枚举值（3=纸质普票, 4=纸质专票, 5=纸质卷票）<br>7. printNum（打印份数）：默认1<br>8. dyjmc（打印机名称）：本地打印时可选<br>9. dyjtop（上边距）：本地打印时可选，单位mm<br>10. dyjleft（左边距）：本地打印时可选，单位mm<br>**[依据]** 产品建议5.1-5.3，需补充电票流水号列表和纸票打印机参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | **[优化]** 电子发票打印约束：<br>1. serialNoList：必填，非空数组<br>2. invoiceType：必填，仅支持电子发票类型（1/2/26/27）<br>3. 发票状态必须为"已开票"（status=0）<br>4. 版式文件必须已生成（kdOrgPdfUrl不为空）<br><br>纸质发票打印约束：<br>1. serialNo：必填，20位发票流水号<br>2. invoiceCode：必填，12位发票代码<br>3. invoiceNo：必填，8位发票号码<br>4. printType：枚举值（1/2/3/4）<br>5. taxDiskNo：必填，关联企业已配置的税盘设备<br>6. invoiceType：仅支持纸质发票类型（3/4/5）<br>7. printNum：整数，范围1-99<br>8. 发票状态必须为"已开票"（status=0）<br>9. 联云打印只支持托管类型为8的税盘<br>10. 本地打印需要C++组件服务正常运行（端口61624）<br>11. 打印机参数（dyjmc/dyjtop/dyjleft）仅在本地打印时有效<br>**[依据]** 产品建议6.1-6.3，需明确电票/纸票接口的类型约束和客户端组件要求 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 电子发票打印准则：<br>1. 发票必须已开具成功（status=0）<br>2. 发票类型必须为电子发票（invoiceType=1/2/26/27）<br>3. 版式文件必须已生成（kdOrgPdfUrl不为空）<br>4. 用户必须有查看发票的权限<br><br>纸质发票打印准则：<br>1. 发票必须已开具成功（status=0）<br>2. 发票类型必须为纸质发票（invoiceType=3/4/5）<br>3. 发票未被标记为"禁止打印"（如已作废）<br>4. 税盘设备状态正常且已初始化<br>5. 发票数据完整性校验通过（发票代码、号码、金额等字段不为空）<br>6. 联云打印需要税盘托管类型为8<br>7. 本地打印需要C++组件服务正常运行（端口61624）<br>8. 云打印需要企业已配置云打印服务<br>9. 打印份数不超过99份<br>10. 防跳号检查：如果发票号码不连续，提示用户确认<br>**[依据]** 产品建议7.1-7.2，需补充电票版式文件生成状态和纸票禁止打印标识的校验 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | **[优化]** 电子发票打印：<br>1. 无属性修改（电票打印仅返回文件地址，不修改发票数据）<br><br>纸质发票打印：<br>1. 打印状态（printStatus）：'未打印' → '已打印'<br>2. 打印时间（printTime）：写入服务器当前时间<br>3. 打印次数（printCount）：累加1<br>4. 打印人（printUser）：写入当前操作用户<br>5. 打印方式（printMethod）：写入打印类型（1/2/3/4）<br>6. 联云打印成功后，发票状态更新为"已打印"（通过联云平台API回写）<br>**[依据]** 产品建议8.1，需补充电票文件地址返回逻辑 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 电子发票打印返回值：<br>1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Array（文件地址列表）<br>   - kdcloudUrl：String（云端PDF/OFD文件地址）<br>   - snapshotUrl：String（快照图片地址）<br>   - localUrl：String（本地存储地址）<br>   - invoiceCode：String（发票代码）<br>   - invoiceNo：String（发票号码）<br>   - serialNo：String（发票流水号）<br><br>纸质发票打印返回值：<br>1. errcode：String（0000=成功，6011=C++组件打印成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. printResult：Boolean（true=打印成功, false=打印失败）<br>4. printTime：String（打印时间，格式：YYYY-MM-DD HH:mm:ss）<br>5. invoiceCode：String（发票代码）<br>6. invoiceNo：String（发票号码）<br>7. printMethod：String（打印方式：A9/本地/云打印/联云）<br>**[依据]** 产品建议9.1-9.2，需补充电票云端地址、快照地址、本地存储地址等返回参数 |

---

## 交付发票文件

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_DELIVER_FILE<br>**[依据]** 产品建议1.1，补充明确的动作唯一标识 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Deliver_Invoice_File (交付发票文件)<br>**[说明]** 统一使用"交付"概念，涵盖首次发送和重发场景 |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice (销项发票)<br>**[依据]** 产品建议3.1，与数据模型实体定义一致 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在发票列表中选择已开具的电子发票，通过邮件或短信方式发送发票文件给购方。系统自动查询购方联系方式，验证邮箱或手机号格式，调用邮件或短信服务发送发票PDF/OFD文件。支持批量发送，包含邮件重试机制避免重复发送。如用户输入新的联系方式，系统将更新发票记录中的购方手机号或邮箱<br>**[依据]** 产品建议4.1-4.2，补充更新联系方式逻辑和修改联系方式后重发场景 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 1. serialNo（发票流水号，必填）<br>2. sendType（发送类型：1=邮件, 2=短信，必填）<br>3. email（邮箱地址，邮件发送时必填，与mobile不能同时为空）<br>4. mobile（手机号，短信发送时必填，与email不能同时为空）<br>5. buyerName（购方名称）<br>6. buyerTaxNo（购方税号）<br>7. invoiceCode（发票代码）<br>8. invoiceNo（发票号码）<br>9. pdfUrl（PDF文件地址）<br>10. ofdUrl（OFD文件地址，数电票）<br>**[依据]** 产品建议5.1-5.3，精简参数并明确email和mobile不能同时为空的约束 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | 1. serialNo：必填，20位发票流水号<br>2. sendType：枚举值（1=邮件, 2=短信）<br>**[优化]** 3. email和mobile：不能同时为空，至少填写一个<br>4. email：邮件发送时必填，格式必须符合邮箱规范（包含@符号）<br>5. mobile：短信发送时必填，格式必须为11位手机号<br>6. buyerName：必填，购方名称<br>7. buyerTaxNo：必填，购方税号<br>8. invoiceCode：必填，发票代码<br>9. invoiceNo：必填，发票号码<br>10. pdfUrl或ofdUrl：至少一个不为空<br>11. 只能发送电子发票（invoiceType=1/2/26/27）<br>12. 发票状态必须为"已开票"（status=0）<br>**[优化]** 13. 企业配置：邮件服务已配置开启（email=2）或短信服务已配置开启（isSms=2）<br>**[依据]** 产品建议6.1-6.2，明确email和mobile不能同时为空，简化企业配置描述 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | 1. 发票必须已开具成功（status=0）<br>2. 发票类型必须为电子发票（invoiceType=1/2/26/27）<br>3. 邮件发送：邮箱地址格式正确，企业已配置邮件服务（email=2）<br>4. 短信发送：手机号格式正确（11位），企业已配置短信服务（isSms=2）<br>**[优化]** 5. 企业至少配置了邮件或短信服务之一，否则拒绝执行<br>6. 发票文件必须存在（pdfUrl或ofdUrl不为空）<br>7. 购方名称和税号不为空<br>8. 邮件重试机制：检查Redis缓存，避免1小时内重复发送<br>9. 短信重试机制：检查发送记录，避免重复发送<br>**[依据]** 产品建议7.1-7.2，补充企业未配置任何推送功能时拒绝执行的规则 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | 1. 邮件发送状态（emailStatus）：'未发送' → '已发送'<br>2. 邮件发送时间（emailSendTime）：写入服务器当前时间<br>3. 邮件发送次数（emailSendCount）：累加1<br>4. 短信发送状态（smsStatus）：'未发送' → '已发送'<br>5. 短信发送时间（smsSendTime）：写入服务器当前时间<br>6. 短信发送次数（smsSendCount）：累加1<br>7. 邮件发送记录：写入Redis缓存，key=email:serialNo，过期时间1小时<br>8. 短信发送记录：写入invoice_sms_send表<br>**[优化]** 9. 购方联系方式更新：输入新联系方式时，更新发票记录中的购方手机号（ghf_sj）或邮箱（email）<br>**[依据]** 产品建议8.1，补充输入新联系方式时更新发票记录的逻辑 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>**[说明]** 执行成功后无具体数据返回，仅返回状态码和描述<br>**[依据]** 产品建议9.1-9.2，精简返回字段，明确成功后无具体数据返回 |

---

## 下载发票文件至本地

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_DOWNLOAD_FILE<br>**[依据]** 产品建议1.1，根据接口路径/portal/platform/file/download定义 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Download_Invoice_File (下载发票文件至本地)                                |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice (销项发票), InvoiceFile (发票文件), ZipFile (压缩包)<br>**[依据]** 产品建议3.1，细化目标对象类型 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在发票列表中选择已开具的电子发票，下载PDF或OFD版式文件到本地。支持单张下载和批量下载，数电发票可选择下载PDF或OFD格式。批量下载时打包为ZIP文件，数据量大时（超过100张）使用密码保护，通过多线程异步下载并缓存到Redis。系统自动校验发票类型（仅电子发票）、发票状态（已开票）、文件存在性（pdfUrl或ofdUrl不为空），URL失效时自动补全链接。下载失败的发票生成失败列表文件一并打包<br>**[依据]** 产品建议4.1-4.4，补充校验逻辑、失败处理、URL补全等核心环节 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | 1. serialNo（发票流水号，单张下载）<br>2. serialNos（发票流水号数组，批量下载）<br>3. fileType（文件类型：pdf/ofd，数电发票可选）<br>4. downloadType（下载类型：single=单张, batch=批量）<br>5. invoiceCode（发票代码）<br>6. invoiceNo（发票号码）<br>7. pdfUrl（PDF文件地址）<br>8. ofdUrl（OFD文件地址）<br>9. buyerName（购方名称）<br>10. totalAmount（价税合计）<br>**[优化]** 11. idList（组织ID列表，权限过滤）<br>**[优化]** 12. searchOpt（查询条件，全量下载时使用）<br>**[依据]** 产品建议5.1-5.2，补充企业ID、筛选条件参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | 1. serialNo：单张下载时必填，20位发票流水号<br>2. serialNos：批量下载时必填，数组长度1-500<br>3. fileType：枚举值（pdf/ofd），数电发票可选，默认pdf<br>4. downloadType：枚举值（single=单张, batch=批量）<br>5. invoiceCode：必填，发票代码<br>6. invoiceNo：必填，发票号码<br>7. pdfUrl或ofdUrl：至少一个不为空<br>8. 只能下载电子发票（invoiceType=1/2/26/27）<br>9. 发票状态必须为"已开票"（status=0）<br>10. 批量下载数量不超过500张<br>**[优化]** 11. URL有效性校验：检查URL返回200状态码，失效时调用补全接口<br>**[依据]** 产品建议6.2，补充URL有效性校验说明 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | 1. 发票必须已开具成功（status=0）<br>2. 发票类型必须为电子发票（invoiceType=1/2/26/27）<br>3. 发票文件必须存在（pdfUrl或ofdUrl不为空）<br>4. 文件URL必须可访问（返回200状态码）<br>5. 批量下载：数量不超过500张<br>6. 批量下载：总文件大小不超过500MB<br>7. 大数据下载（超过100张）：使用密码保护，密码为6位随机数字<br>8. 下载超时时间：单张30秒，批量300秒<br>**[优化]** 9. 至少有一张发票满足下载条件<br>**[依据]** 产品建议7.1，补充硬性门槛 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | 1. 下载状态（downloadStatus）：'未下载' → '已下载'<br>2. 下载时间（downloadTime）：写入服务器当前时间<br>3. 下载次数（downloadCount）：累加1<br>4. 下载人（downloadUser）：写入当前操作用户<br>5. 批量下载：生成ZIP文件，文件名格式：发票_{时间戳}.zip<br>6. 大数据下载：Redis缓存下载任务，key=download:{taskId}，过期时间30分钟<br>**[优化]** 7. 临时文件缓存：存储在临时目录，下载完成后清除<br>**[依据]** 产品建议8.1，补充文件缓存逻辑 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | 1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. downloadUrl：String（下载地址，单张下载直接返回文件URL，批量下载返回ZIP文件URL）<br>4. fileName：String（文件名）<br>5. fileSize：Number（文件大小，单位：字节）<br>6. fileType：String（文件类型：pdf/ofd/zip）<br>7. password：String（ZIP文件密码，大数据下载时返回）<br>8. taskId：String（下载任务ID，大数据下载时返回）<br>9. downloadTime：String（下载时间，格式：YYYY-MM-DD HH:mm:ss）<br>**[优化]** 10. failedList：String（失败发票列表文件名，格式：获取失败的发票代码号码.txt）<br>**[优化]** 11. contentType：String（文件流类型：application/zip）<br>**[依据]** 产品建议9.1-9.2，补充失败说明文件和文件流类型 |

---

## 导出发票数据

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_EXPORT_DATA<br>**[依据]** 产品建议1.1-1.2，需补充系统唯一标识 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Export_Invoice_Data (导出发票数据)                                       |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice（销项发票）、Excel File（Excel文件）<br>**[依据]** 产品建议2.1-2.2，需补充OutputInvoice、Excel File等精准表述 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在开票查询页面选择发票记录或设置查询条件后，点击"导出Excel"按钮，系统将发票数据按发票类型分组导出为Excel文件（**.xlsx格式**），支持汇总模式（每张发票一行）和明细模式（每个商品明细一行）。**导出的Excel文件包含发票基本信息、购销方信息、金额税额信息以及商品明细信息等全量数据**。导出操作不修改发票数据，只读取数据生成Excel文件。<br>**[依据]** 产品建议3.1-3.2，需补充导出文件格式（.xlsx）、数据覆盖范围说明 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 1. idList（组织ID列表）：必填<br>2. **shopIdList（门店编号列表）**：可选<br>3. serialNums（发票流水号列表）：可选<br>4. excelType（Excel类型）：必填，0=明细/1=汇总<br>5. startTime（开始日期）：必填<br>6. endTime（结束日期）：必填<br>7. type（发票类型）：可选，0=蓝票/1=红票<br>8. status（发票状态）：可选<br>9. invoiceType（发票种类）：可选<br>10. invoiceCode（发票代码）：可选<br>11. invoiceNum（发票号码）：可选<br>12. buyerName（购方名称）：可选<br>13. **companyId（企业ID）**：必填<br>**[依据]** 产品建议4.1-4.3，需补充企业ID、门店编号列表等核心权限相关参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | **[优化]** 1. idList：必填，至少包含1个组织ID<br>2. serialNums：可选，如有选中发票则只导出选中的发票<br>3. excelType：必填，枚举值（0=明细模式，1=汇总模式）<br>4. startTime：必填，日期格式YYYY-MM-DD<br>5. endTime：必填，日期格式YYYY-MM-DD<br>6. type：可选，枚举值（0=蓝票，1=红票）<br>7. status：可选，发票状态值<br>8. invoiceType：可选，发票类型值<br>9. invoiceCode：可选，长度10-12位<br>10. invoiceNum：可选，长度8位<br>11. buyerName：可选，长度不超过100字节<br>12. **导出数据量限制**：<br>   - 汇总模式：单次不超过4000条<br>   - 明细模式：单次不超过10000条<br>   - 勾选导出：不超过100张<br>13. **权限校验**：通过shopIdList/storeNumList过滤数据，确保用户只能导出有权限的发票<br>**[依据]** 产品建议5.1-5.2，需补充导出数据量限制、权限校验依据 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 1. 组织ID列表不能为空<br>2. 开始日期和结束日期必须有效<br>3. 结束日期不能早于开始日期<br>4. Excel类型必须为0或1<br>5. 如果选中了发票，流水号列表不能为空<br>6. 用户必须有导出发票数据的权限<br>7. 查询条件下必须有符合条件的发票数据<br>8. **数据量不超过限制**：<br>   - 汇总模式≤4000条<br>   - 明细模式≤10000条<br>   - 勾选导出≤100张<br>   - 超限时抛出EXPORT_EXCEL_ONLY_COUNT异常<br>**[依据]** 产品建议6.1-6.2，需补充数据量超限异常标识 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | 无（导出操作不修改发票数据，只读取数据生成Excel文件） |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 1. errcode：String（0000=成功，1376/1377/1378=数据量大需设置密码，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. fileName：String（生成的Excel文件名，格式：invoiceList_流水号.xlsx）<br>4. **fileStream：Binary（文件流，Content-Type: application/vnd.ms-excel）**<br>5. **fileUrl：String（文件下载地址，存储在Redis中，有效期24小时）**<br>**[依据]** 产品建议7.1-7.2，需补充文件流类型、文件下载地址说明 |

---

## 预览发票文件

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识,按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_FILE_PREVIEW<br>**[依据]** 产品建议1.1-1.2，需补充明确的动作唯一标识 |
| 动作名称                  | 采用"动词+名词"结构,清晰体现动作核心操作,括号内补充中文释义             | Preview_Invoice_File (预览发票文件)                                      |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称,需与数据模型中的实体定义一致         | **[优化]** OutputInvoice（销项发票）、OutputInvoiceFileModel（发票文件模型）<br>**[依据]** 产品建议3.1-3.2，需补充与数据模型中一致的实体名称 |
| 动作目的与描述            | 语义清晰的文本描述,明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在开票查询页面点击发票列表中的"查看"链接，系统根据发票流水号调用第三方接口获取文件地址并返回前端展示。这是一个只读操作，无持久化文件下载，仅在线浏览。系统根据发票类型和文件格式自动选择合适的预览方式：OFD文件使用快照预览，PDF文件根据清单标志选择快照或PDF预览。<br>**[依据]** 产品建议4.1-4.2，需明确动作核心为"根据发票流水号调用第三方接口获取文件地址并返回前端展示"，补充"无持久化文件下载，仅在线浏览"的业务特征 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项,需关联业务对象属性或数据字典,明确参数名称 | **[优化]** 1. serialNo（发票流水号）：必填，20位，唯一标识发票<br>**[依据]** 产品建议5.1-5.2，需简化输入参数列表，聚焦核心必填参数serialNo，避免罗列非核心可选参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件,枚举类参数需明确允许值                 | **[优化]** 1. serialNo：必填，长度20位，唯一标识发票<br>2. 发票必须已开具成功（status=0）<br>3. 发票类型需支持电子版式或已生成快照的纸票（invoiceType=1/2/3/4/26/27）<br>4. 用户必须有查看发票的权限<br>**[依据]** 产品建议6.1-6.2，需补充"发票类型需支持电子版式或已生成快照的纸票"约束，仅保留与serialNo直接相关的核心约束 |
| 提交准则                  | 动作执行的硬性门槛,基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 1. 发票流水号必须有效且存在<br>2. 发票必须已开具成功（status=0）<br>3. 用户必须有查看发票的权限<br>4. 对应的版式文件或快照已在第三方系统生成<br>**[依据]** 产品建议7.1-7.2，需补充"对应的版式文件或快照已在第三方系统生成"核心准则，删减与提交准则无关的细节 |
| 输出参数（属性修改逻辑）  | 动作执行后,目标对象核心属性的变更规则,明确"原状态→新状态""赋值规则"     | **[优化]** 只读操作，无业务属性修改<br>**[依据]** 产品建议8.1-8.2，需明确"只读操作，无属性修改"的核心结论，删减关于快照URL写入的非核心内容 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Object（结构化数据对象）<br>   - snapshotUrl：String（快照URL）<br>   - kdcloudUrl：String（云端PDF/OFD文件URL）<br>   - localUrl：String（本地存储地址）<br>   - invoiceCode：String（发票代码）<br>   - invoiceNo：String（发票号码）<br>   - serialNo：String（发票流水号）<br>**[依据]** 产品建议9.1-9.3，需补充kdcloudUrl、localUrl、invoiceCode、invoiceNo等核心返回参数，简化错误码相关表述 |

---

## 作废发票

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识，按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_INVALID<br>**[依据]** 产品建议1.1-1.2，需补充明确的动作唯一标识 |
| 动作名称                  | 采用"动词+名词"结构，清晰体现动作核心操作，括号内补充中文释义             | Invalid_Invoice (作废发票)                                               |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称，需与数据模型中的实体定义一致         | **[优化]** OutputInvoice（销项发票）<br>**[依据]** 产品建议3.1-3.2，需与数据模型中实体定义完全一致 |
| 动作目的与描述            | 语义清晰的文本描述，明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户在作废发票页面查询到需要作废的纸质发票后，点击"作废"按钮，系统调用税控设备或联云托管平台完成发票作废操作，并将发票状态更新为"作废"（status=2）。**作废操作不可逆**，一旦作废无法恢复。只能作废状态为"正常"（0）或"红冲"（3）的纸质发票，不支持电子发票作废。根据税盘类型不同，分为联云作废和本地C++组件作废两种方式。**跨月发票作废需特殊处理**，需在税局端完成作废操作后才能在系统中更新状态。作废操作会影响税局端发票状态，确保系统与税局数据一致。<br>**[依据]** 产品建议4.1-4.3，需补充作废操作的不可逆性、跨月发票作废特殊处理规则、税局端发票状态影响说明 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项，需关联业务对象属性或数据字典，明确参数名称 | **[优化]** 1. invoiceCode（发票代码）：必填<br>2. invoiceNo（发票号码）：必填<br>3. taxDiskNo（税盘编号）：必填<br>4. invoiceType（发票类型）：必填<br>5. machineNo（设备编号）：必填<br>6. serialNo（发票流水号）：可选<br>7. zflx（作废类型）：可选，枚举值（1=正常作废, 2=强制作废）<br>8. zfyy（作废原因）：可选，文本描述<br>**[依据]** 产品建议5.1-5.3，需补充作废类型、作废原因等可选参数 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件，枚举类参数需明确允许值                 | **[优化]** 1. invoiceCode：必填，长度10-12位<br>2. invoiceNo：必填，长度8位<br>3. taxDiskNo：必填，关联企业已配置的税盘设备<br>4. invoiceType：必填，枚举值（3=纸质普票, 4=纸质专票, 5=纸质卷票）<br>5. machineNo：必填，设备编号<br>6. 发票状态必须为"正常"（0）或"红冲"（3）<br>7. 只支持纸质发票作废，不支持电子发票<br>8. 税盘设备必须已初始化完成<br>9. 发票必须属于当前企业（通过销方税号校验）<br>10. 发票作废时间限制：建议当月开具的发票当月作废<br>11. 税控设备/服务必须在线且状态正常<br>**[依据]** 产品建议6.1-6.4，需补充发票归属约束、时间限制、设备在线状态约束 |
| 提交准则                  | 动作执行的硬性门槛，基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 1. 发票代码和号码必须有效且存在<br>2. 发票状态必须为"正常"（0）或"红冲"（3）<br>3. 发票类型必须为纸质发票（3/4/5）<br>4. 税盘设备已初始化完成<br>5. 用户必须有作废发票的权限<br>6. 发票未被作废过（status≠2）<br>7. 发票未失控（status≠1）<br>8. 发票未异常（status≠4）<br>9. 发票未被部分/全额红冲（或已红冲但允许作废）<br>10. 发票归属当前企业（销方税号匹配）<br>11. 发票在税局端验真通过<br>**[依据]** 产品建议7.1-7.3，需补充发票未被红冲、归属校验、税局验真等前提条件 |
| 输出参数（属性修改逻辑）  | 动作执行后，目标对象核心属性的变更规则，明确"原状态→新状态""赋值规则"     | **[优化]** 1. 发票状态（fstatus）：0或3 → 2（作废）<br>2. 作废日期（finvaliddate）：null → 作废时间<br>   - 联云作废：解析返回的dqsj（格式yyyyMMddHHmmss）<br>   - C++组件作废：写入服务器当前时间<br>3. 作废人（invalidUser）：写入当前操作用户ID和姓名<br>4. C++组件作废不会自动更新数据库，需要后续同步<br>**[依据]** 产品建议8.1-8.3，需补充作废人字段记录规则、统一作废时间赋值标准 |
| 输出参数（执行结果/返回值）| 动作执行后的返回数据，包含执行状态、业务关键标识，明确数据类型           | **[优化]** 1. errcode：String（联云：0000=成功，C++组件：6011=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Object（结构化数据对象）<br>   - successList：Array（成功作废的发票列表）<br>     - invoiceCode：String（发票代码）<br>     - invoiceNo：String（发票号码）<br>     - invalidDate：String（作废时间）<br>   - failedList：Array（失败作废的发票列表）<br>     - invoiceCode：String（发票代码）<br>     - invoiceNo：String（发票号码）<br>     - errorMsg：String（失败原因）<br>**[依据]** 产品建议9.1-9.3，需补充成功/失败发票列表、统一错误码体系、明确返回值字段属性 |

---

## 红冲发票

| 参数名称                  | 参数说明                                                                 | 示例内容                                                                 |
|---------------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| 动作ID                    | 系统定义的动作唯一标识,按业务场景+动作类型命名规范生成                   | **[优化]** INVOICE_RED_INFO_APPLY（申请红字信息表）、INVOICE_RED_ISSUE（开具红字发票）<br>**[依据]** 产品建议1.1-1.2，需区分申请和开票两个细分动作 |
| 动作名称                  | 采用"动词+名词"结构,清晰体现动作核心操作,括号内补充中文释义             | **[优化]** Apply_Red_Info_Sheet（申请红字信息表）、Issue_Red_Invoice（开具红字发票）<br>**[依据]** 产品建议2.1-2.2，需区分专票/普票不同流程的精准命名 |
| 目标对象类型              | 该动作直接操作并修改的业务实体名称,需与数据模型中的实体定义一致         | **[优化]** 申请红字信息表：InvoiceRedApply（红字信息表申请单）<br>开具红字发票：OutputInvoice（销项发票）<br>**[依据]** 产品建议3.1-3.2，专票红冲场景下直接操作的实体为红字信息表申请单 |
| 动作目的与描述            | 语义清晰的文本描述,明确动作的业务场景、执行主体及最终业务后果           | **[优化]** 用户对已开具的蓝字发票进行红冲操作,开具负数金额的红字发票用于冲销原发票。红冲发票分为两个主要步骤：<br><br>**1. 申请红字信息表（专票必须）**：<br>- 用户填写红字信息表申请单，选择申请方（销方/购方已抵扣/购方未抵扣）<br>- 系统将申请单提交至税局端校验<br>- 税局审核通过后返回红字信息编码（hzxxbm）和申请单号（sqdh）<br>- 红字信息编码是后续开具红字发票的必要参数<br><br>**2. 开具红字发票**：<br>- 普票：直接开具红字发票，无需申请红字信息表<br>- 专票：根据红字信息表编码开具红字发票<br>- 系统将原发票的所有金额和数量转为负数，处理折扣行合并，然后调用开票接口完成红字发票开具<br>- 开票成功后更新原发票状态为"红冲"，红字信息表状态更新为"已开票"<br><br>**红冲原因**：系统记录红冲原因，用于审计追溯<br>**金额限制**：红冲金额不能超过蓝票剩余可红冲金额<br>**[依据]** 产品建议4.1-4.3，需补充专票红字信息表申请需提交至税局端校验、红冲原因、金额限制的说明 |
| 输入参数                  | 动作执行前需录入/选择的核心数据项,需关联业务对象属性或数据字典,明确参数名称 | **[优化]** 申请红字信息表参数：<br>1. yfpdm（原发票代码）：必填<br>2. yfphm（原发票号码）：必填<br>3. sqsm（申请方）：必填，枚举值（2=销方申请, 0=购方已抵扣, 1=购方未抵扣）<br>4. hcyy（红冲原因）：必填，文本描述<br>5. ghf_mc（购方名称）：必填<br>6. ghf_nsrsbh（购方税号）：必填<br>7. xhf_mc（销方名称）：必填<br>8. xhf_nsrsbh（销方税号）：必填<br>9. hjbhsje（合计不含税金额）：必填，负数<br>10. kphjse（合计税额）：必填，负数<br>11. jshjje（价税合计）：必填，负数<br>12. items（发票明细）：必填，负数<br><br>开具红字发票参数：<br>1. kplx（开票类型）：固定为"1"（红字发票）<br>2. hzxxbm（红字信息编码）：专票必填，普票不需要<br>3. yfpdm（原发票代码）：必填<br>4. yfphm（原发票号码）：必填<br>5. 其他参数同蓝字发票开票参数<br>**[依据]** 产品建议5.1-5.4，需补充红冲原因参数，统一蓝票代码/号码参数命名 |
| 输入约束                  | 输入参数的取值限制、对象筛选条件,枚举类参数需明确允许值                 | **[优化]** 申请红字信息表约束：<br>1. yfpdm：必填，长度10-12位<br>2. yfphm：必填，长度8位<br>3. sqsm：必填，枚举值（2=销方申请, 0=购方已抵扣, 1=购方未抵扣）<br>4. 原发票必须为蓝字发票（type=0）<br>5. 原发票类型必须为增值税专用发票（invoiceType=2或4）<br>6. 红冲金额不能超过蓝票剩余可红冲金额<br>7. 销方申请需原发票未认证或认证未通过<br>8. 购方申请需原发票已抵扣（sqsm=0）或未抵扣（sqsm=1）<br>9. 同一张蓝票不能重复申请有效红字信息表<br>10. 所有金额和数量必须为负数<br><br>开具红字发票约束：<br>1. kplx：必填，固定为"1"（红字发票）<br>2. hzxxbm：专票必填，普票不需要<br>3. 原发票必须为蓝字发票（type=0）<br>4. 所有金额和数量必须为负数<br>5. 专票需先申请红字信息表，获得hzxxbm后才能开票<br>6. 普票可直接开具红字发票<br>7. 明细行税收编码不能为空<br>8. 明细行物品名称长度不超过71个字符（含简称）<br>9. 规格型号长度不超过40个字符<br>10. 单位长度不超过20个字符<br>**[依据]** 产品建议6.1-6.4，需补充蓝票剩余可红冲金额限制、专票申请方与发票认证状态关联约束、同一张蓝票不能重复申请约束、增值税专用发票枚举值范围 |
| 提交准则                  | 动作执行的硬性门槛,基于业务合规性、数据一致性制定的必须满足的条件       | **[优化]** 申请红字信息表准则：<br>1. 原发票代码和号码必须有效且存在<br>2. 原发票必须为蓝字发票（type=0）<br>3. 原发票类型必须为增值税专用发票（invoiceType=2或4）<br>4. 红字发票不能再次红冲<br>5. 蓝票可查询性校验通过（调用checkInvoiceRedApply函数）<br>6. 红冲金额不能超过蓝票剩余可红冲金额<br>7. 同一张蓝票不能重复申请有效红字信息表<br>8. 企业已配置税控设备或托管服务，且与税局连接正常<br>9. 申请方与发票认证状态匹配<br>10. 所有金额和数量必须为负数<br><br>开具红字发票准则：<br>1. 专票必须先申请红字信息表并获得hzxxbm<br>2. 红字信息表状态必须为"未开票"（applyStatus=3）<br>3. 明细行税收编码不能为空<br>4. 明细行物品名称长度不超过71个字符（含简称）<br>5. 规格型号长度不超过40个字符<br>6. 单位长度不超过20个字符<br>7. 销方名称长度不超过100个字符<br>8. 销方税号长度不超过20个字符<br>**[依据]** 产品建议7.1-7.3，需补充红冲条件校验函数、蓝票可查询性、企业配置税控设备/托管服务与税局连接的明确要求 |
| 输出参数(属性修改逻辑)  | 动作执行后,目标对象核心属性的变更规则,明确"原状态→新状态""赋值规则"     | **[优化]** 申请红字信息表属性修改：<br>1. 红字信息表状态（applyStatus）：1（未提交/审核中） → 3（未开票，申请成功） 或 2（申请失败）<br>2. 红字信息编码（hzxxbm）：申请成功后写入税局返回的编码<br>3. 申请单号（sqdh）：申请成功后写入税局返回的单号<br>4. 申请单流水号（reqSerialNo）：系统生成并回写<br>5. 蓝票状态（status）：保持不变（申请阶段不修改蓝票状态），可能存在"冲销中"中间状态<br><br>开具红字发票属性修改：<br>1. 红字信息表状态（applyStatus）：3（未开票） → 4（已开票）<br>2. 原发票状态（status）：0（正常） → 3（红冲）<br>3. 红字发票数据：新增一条type=1的发票记录，所有金额和数量为负数<br>4. 红字发票流水号（serialNo）：系统生成20位流水号<br>5. 红字发票代码（invoiceCode）：税控系统返回<br>6. 红字发票号码（invoiceNo）：税控系统返回<br>**[依据]** 产品建议8.1-8.3，需补充红字信息表申请单初始状态、蓝票"冲销中"中间状态、申请单流水号回写规则、申请单创建的字段完整性 |
| 输出参数(执行结果/返回值)| 动作执行后的返回数据,包含执行状态、业务关键标识,明确数据类型           | **[优化]** 申请红字信息表返回值：<br>1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Object（结构化数据对象）<br>   - fid：String（申请单ID）<br>   - applyStatus：String（申请状态：1=未提交/审核中, 2=申请失败, 3=未开票）<br>   - hzxxbm：String（红字信息编码，申请成功后返回）<br>   - sqdh：String（申请单号，申请成功后返回）<br>   - reqSerialNo：String（申请单流水号）<br><br>开具红字发票返回值：<br>1. errcode：String（0000=成功，其他=失败错误码）<br>2. description：String（操作结果描述信息）<br>3. data：Object（结构化数据对象）<br>   - invoiceCode：String（红字发票代码）<br>   - invoiceNo：String（红字发票号码）<br>   - serialNo：String（红字发票流水号）<br>   - pdfUrl：String（红字发票PDF文件地址）<br>   - ofdUrl：String（红字发票OFD文件地址）<br>**[依据]** 产品建议9.1-9.3，需补充申请单ID、申请状态作为返回参数，返回数据需包含结构化的data对象，区分"提交审核"和"申请成功"不同状态 |

---

**文档生成时间**: 2026-01-09  
**文档版本**: v2  
**文档说明**: 本文档整合了9个开票核心功能的v2版本表格内容，所有优化点均基于产品建议和代码逻辑验证生成。
