## 为何要做事后对账，而不是事前就避免重开？
根本原因：金税四期电子税局系统还不稳定表现

1）rpa开票，电子税局偶尔会返回“未知异常”等不明确是否成功的报错 

2）出现这类报错的一段时间内（按经验半小时到半天不等），都查不出这张票，但之后又能查出 

3）电子税局没有基于开票流水号去重的接口和逻辑



## 全流程防重开票方案：
**1）事前预警：**

    - 业务系统唯一流水号，系统开票根据开票提交状态和回写结果锁定开票单据；
    - 业务防重：根据发票票面信息比对一段时间内是否相同进行二次确认
    - ![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1707032560154-cd61aa55-9d35-461d-8f4c-d1124f136f37.png)



**2）事中校验：** 

    - 开票过程中获取税局返回的异常报错，及时对请求进行加锁，并通过查询校验功能确认发票是否实际开出。
    - 出现错误时锁定半小时，之后仍在电子税局查不到此票，则发起再次开票申请



**3）事后对账：**

    - 每天拉取税局发票数据，与本地保存数据进行比对，以报表的形式展示差异点，然后开票员做红冲等差异处理

![](https://cdn.nlark.com/yuque/0/2024/png/647520/1707030929732-b9e393fd-e0ed-43a9-9a19-e6b8adca9e26.png)

