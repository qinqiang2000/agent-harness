文档适用范围：星空旗舰版开票

## 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1 | 2025.11.03 |  | 初稿发布 |  |


## 负数单据特殊处理操作路径及所属模块编码
操作路径：【发票服务】→【开票管理】→【单据开票】→【负数开票申请单】

所属模块编码：F17005

所属模块名称：负数开票申请单

## 负数单据特殊处理功能设计理念概述
### 用户痛点
1、升级金税四期后，发票红冲规则非常复杂，例如红冲必须关联原蓝票、及原蓝票明细等，同时，企业逆向流程包括返利、退货等场景同样复杂，部分逆向业务数据无法关联到原蓝票信息，企业复杂的业务和税局复杂的红冲规则产生冲突，导致企业红冲发票变得极为困难。

更多税局红冲规则见：[https://jdpiaozone.yuque.com/nbklz3/dn5ehb/edhu9lhwt2kq46sv](https://jdpiaozone.yuque.com/nbklz3/dn5ehb/edhu9lhwt2kq46sv)

### 特性亮点
1. 灵活的配置负数单据匹配原蓝票的规则，包括可匹配的原蓝票时间、票种等信息。
2. 可配置多套负数匹配原蓝票规则，匹配时自定义选择。

### 整体架构
负数匹配原蓝票规则：

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1712913728316-d37872f5-fd32-40b1-8097-967620acaaaf.png)

## 负数单据特殊处理功能详解
### 负数单据特殊处理专业术语说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">字段名称*</font>** | **<font style="color:rgb(26, 26, 26);">业务含义*</font>** | **<font style="color:rgb(26, 26, 26);">字段规则*</font>** | **<font style="color:rgb(26, 26, 26);">其他属性说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 销方名称 | <font style="color:rgb(26, 26, 26);">开票企业名称</font> | 系统自动生成或自定义，文本类型，字段必填 |  |
| 2 | 购方地址 | 开票购方地址 | 手工填写或开票抬头列表选择，文本类型，字段非必填 |  |
| 3 | 匹配状态 | 标记开票申请单匹配蓝字发票后的结果状态 | 包括：待处理、零匹配、部分匹配、全部匹配 |  |
| 4 | 下推状态 | 标记对已匹配到的数据是否已下推生成下游数据，例如：当开票申请单开具数电票时，匹配到蓝字发票，下推生成红字确认单 |  |  |
| 5 | 匹配类型 | 标记匹配结果是通过系统自动匹配，还是用户手动匹配。 | 包含自动匹配、手动匹配 |  |
| 6 | 匹配数据 | 标记开票申请单是匹配蓝票后生成红字确认单开具红票，还是匹配已有红字确认单后开具红票 | 包含匹配蓝票、匹配红字确认单 |  |


### 负数单据特殊处理功能按钮说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">按钮名称*</font>** | **<font style="color:rgb(26, 26, 26);">功能描述*</font>** | **<font style="color:rgb(26, 26, 26);">使用条件</font>** | **<font style="color:rgb(26, 26, 26);">其他说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | <font style="color:rgb(0, 0, 0);">自动匹配</font> | <font style="color:rgb(0, 0, 0);">根据负数开票申请单的明细信息自动匹配原蓝票</font> |  |  |
| 2 | 取消匹配 | <font style="color:rgb(0, 0, 0);">取消负数开票申请单，当前已经匹配到的结果</font> | 已下推的匹配结果不支持取消 |  |
| 3 | <font style="color:rgb(0, 0, 0);">红冲</font> | <font style="color:rgb(0, 0, 0);">针对已经匹配成功或者部分匹配成功的负数开票申请单，点击红冲生成红字确认单</font> | 已匹配到的开票申请单可点击红冲 |  |
| 4 | <font style="color:rgb(0, 0, 0);">下查</font> | <font style="color:rgb(0, 0, 0);">查询开票申请单下游的数据，当已下推红字确认单未开具发票时，下查到红字确认单；如已开具发票，可下查到发票。</font> | 存在下游数据可下查 |  |




### 负数单据特殊处理主要操作流程
##### 自动匹配
自动匹配是根据基本规则（<font style="color:rgb(0, 0, 0);">销方税号、购方税号、发票种类，明细是商品编码、税收分类编码、税率、剩余可红冲金额，单价按偏差值</font>）将负数单据的信息跟蓝字发票进行比对，满足条件的蓝字发票即匹配成功或者部分匹配成功

当负数单据的金额大于所有符合条件的蓝字发票金额时负数单据的匹配状态就是部分匹配成功，

当负数单据的金额小于或等于所有符合条件的蓝字发票金额时负数单据的匹配状态就是匹配成功

当负数开票申请单的匹配状态是待处理时点击单据编号查看到的负数开票申请单，当负数开票申请单的匹配状态是匹配成功、匹配失败、部分匹配成功时点击单据编号查看到的就是匹配单据详情

1. 点击自动匹配

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412644636-449275c8-c552-4260-ba4c-36f50e8ad42f.png)

匹配成功后，负数开票申请单的匹配状态就是匹配成功

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412687024-15c12534-5d58-4a9f-bcbb-4b9331719bc5.png)

点击负数开票申请单单据编号查看到的是匹配结果单据

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412732627-008a8077-3eeb-43bd-918c-192cbf3797df.png)

##### 红冲
+ 点击红冲按钮会将匹配到蓝字发票的负数开票申请单下推生成红字确认单，部分匹配成功的也可以红冲根据匹配到的蓝字发票生成红字确认单

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412757056-a4f99dbd-8e7a-4cc6-8d53-d8ccf079ba02.png)

+ 点击列表的下查按钮可以查到红字确认单，通过负数单据自动匹配下推生成的红字确认单数据来源是“匹配结果推送”

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412783108-917ad640-e78c-4356-afc7-3b7a5653f5fb.png)

+ 红字确认单开完发票后回写负数单据的开票状态，如果是部分匹配成功则不会回写，只有当负数单据是匹配成功并且所有匹配成功的都下推生成红字确认单并开完票了才会回写成开票结束

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748412809912-801dbb8c-f0e4-4991-b556-3f51fffef6d6.png)

## 负数单据特殊处理相关配置说明
1. 负数匹配原蓝票设置：[负数匹配原蓝票设置](https://jdpiaozone.yuque.com/nbklz3/tadboa/xyyvtryr2qvoi0bo)
2. 负数匹配确认单设置：[负数匹配确认单设置](https://jdpiaozone.yuque.com/nbklz3/tadboa/pahd1yao8quro8wr)

## 负数单据特殊处理相关接口说明
1. 同开票申请单接口，推送负数数据。[所有开票申请单 (yuque.com)](https://jdpiaozone.yuque.com/nbklz3/tadboa/bwru1faim8g40bu7)
2. 匹配蓝票相关接口

（1）匹配蓝票接口：[1.1.08 创建负数单匹配任务 - 发票云(旗舰版)API文档](https://piaozone-ultimate.apifox.cn/api-194841116)

（2）查询匹配结果接口：[1.1.09 查询负数单匹配任务结果 - 发票云(旗舰版)API文档](https://piaozone-ultimate.apifox.cn/api-194893206)

