文档适用范围：星空旗舰版开票

## 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1.0 | 2025.11.05 |  | 初稿发布 |  |




## 自动开票方案操作路径及所属模块编码
操作路径：【发票服务】→【基础资料】→【开票参数设置】→【自动化方案设置】→【自动开票方案】

所属模块编码：F17025

所属模块名称：开票参数设置

## 自动开票方案功能设计理念概述
<font style="color:rgb(6, 6, 7);">我们的自动开票方案提供了灵活的自定义配置功能，允许用户根据具体需求设定自动开票的数据范围和开票频率等关键参数。这一方案不仅提高了开票流程的自动化程度，也充分满足了客户对于高效、个性化开票流程的需求。</font>

## 自动开票方案功能详解
### 自动开票方案关键字段说明
| **<font style="color:rgb(26,26,26);">字段名称</font>** | **<font style="color:rgb(26,26,26);">业务含义</font>** | **<font style="color:rgb(26,26,26);">字段规则说明</font>** | **<font style="color:rgb(26,26,26);">其他说明</font>** |
| --- | --- | --- | --- |
| 开票频率 | 自动开票方案的执行频率 | 可选月（每月的第几天、支持多选）；星期（星期几、支持多选）；天（每天） |  |
| 时间范围 | 自动开票方案的时间范围 | hh:mm:ss~hh:mm:ss |  |
| 可开票单据性质 | 本次执行开票的单据性质 | 枚举值：正数、负数。<br/>默认勾选正数，历史数据默认为正数。 |  |
| 待开负数发票未关联蓝票/红字确认单处理 | 当开具负数发票（包含负数单据开负数发票，或正负合并后开具负数发票）的单据，如果未关联蓝字发票或红字确认单时的处理方式 | 当可开票单据性质为负数时展示。<br/>枚举值：默认展示（2）：<br/>（1）自动匹配蓝票：对该类数据只匹配蓝票；<br/>（2）自动匹配红字确认单或蓝票：对该类数据先匹配红字确认单，未匹配到时再匹配蓝票。<br/>设置说明：<br/>①本配置用于设置，当负数单据未关联蓝票或者红字确认单时，是否由系统自动匹配红字确认单或蓝票信息后，开具红票。<br/>②匹配时，将按照“发票服务>基础资料>开票参数设置>负数匹配原蓝票设置”的规则自动匹配。<br/>③如果开启单据合并、明细合并，负数单据将优先配置进行合并，未被合并或合并为负数时，开具负数发票。 |  |
| 是否合并 | 可开票的单据中，是否需要合并后执行开票 | 枚举值：不合并，单据合并，明细合并，单据、明细合并。 |  |
| 下推类型 | 开票申请自动开票执行的节点，保存到待开或者直接开票。 | 枚举值：<br/>①生成红字确认单数据不录入税局（仅适用负数发票）——当可开票单据性质为负数时展示。如进行负数单据自动匹配蓝票，仅执行到匹配蓝票并预生成红字确认单，但不录入税局。<br/>②生成红字确认单数据并录入税局（仅适用负数发票）——当可开票单据性质为负数时展示，如进行负数单据自动匹配蓝票，仅执行到匹配蓝票并预生成红字确认单，且录入税局。<br/>③保存至待开——将单据下推到开票过程监控列表暂存，不直接开出发票，后续可到开票过程监控列表手工操作开票。<br/>④直接开票——直接开出发票。 |  |
|  |  |  |  |
|  |  |  |  |




### 自动开票方案按钮说明
| **按钮名称*** | **功能描述*** | **使用条件** | **其他说明** |
| --- | --- | --- | --- |
| 新增/复制 | 新增/复制一条自动开票方案 |  |  |
| 删除 | 删除自动开票方案 |  |  |
| 启用/禁用 | 启用：将一条或多条自动开票方案设置为可用<br/>禁用：将一条或多条自动开票方案设置为无效 |  |  |
|  |  |  |  |
|  |  |  |  |
|  |  |  |  |


### 自动开票方案主要操作说明
#### 自动开票方案配置
**步骤1：**新增自动开票方案

点击新增，添加自动开票的规则，定时任务会根据此处方案配置的条件将满足条件的开票申请单下推开票或者保存至待开等操作。

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748914939254-f3d67780-f4aa-46d7-8a8d-cc55e0426a1d.png)

**步骤2：**填写自<font style="color:rgb(33, 33, 33);">动开票基础信息</font> ：当定时任务执行的时间满足此处配置的时间时才会执行自动开票。

选择：开票频率、时间范围、可开票单据性质、待开负数发票未关联蓝票/红字确认单处理、是否合并、下推类型、优先级。

字段的详细说明详见本文3.2节。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1756100987430-225bd68c-a3c5-455d-ad45-f4008b60355a.png)

举例说明：若按照下图配置，则实现效果为：星期日-星期三的00:15:00～20:16:15的时间范围内，正数开票申请单将会跟着【开票申请单自动开票调度计划】不执行合并、直接下推单据开出发票。

![](https://cdn.nlark.com/yuque/0/2025/png/647520/1759049869967-46220a3b-edbc-4621-9062-a6d56eeb4434.png)

**步骤3：**填写使用此自动方案的匹配条件。

只有满足查询条件的单据才会按照此条配置进行自动开票。可以根据单据的数据来源、购方名称、纳税人识别号(购方)、发票种类等字段进行匹配。

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748914966716-489c1b54-8f19-42ad-93af-544b585a65b7.png)

**执行逻辑如下：**

（1）开票申请单的申请状态为未申请、单据状态为正常、审核状态为已审核/无需审批、关闭状态为未关闭时，可执行当月的单据自动开票。

（2）当上一个匹配任务未执行完成，本次不执行匹配。

（３）开票人写入同正数单据自动开票。记录自动开票行为，是否自动开票 ，对应待开【开票操作人】字段，通过自动开票任务下推开票申请单生成的待开，待开的【开票操作人】赋值为定时任务的执行用户。若待开开具失败，在待开手工重新发起开票时，【开票操作人】则重新赋值为实际操作人，如通过待开自动重开，则不覆盖。

（４）开具负数发票匹配原蓝票，获取匹蓝规则时支持匹配条件：

+ 匹配蓝票规则下方增加匹配项面板，先获取本组织可用的匹蓝规则（包含所有控制策略），判断其中符合单据红冲原因的匹配规则中，单据是否有符合匹配项面板配置的匹蓝规则：
    1. 如果无符合的匹配项，则将所有匹配蓝票规则，按照私有＞自由分配＞逐级分配＞管控范围内共享＞全局共享顺序，依次匹配可用的匹配规则，如果某管控策略有多条，则获取修改时间最新的匹配规则
    2. 如果有符合的匹配项，则将符合匹配项的匹配蓝票规则，按照私有＞自由分配＞逐级分配＞管控范围内共享＞全局共享顺序，依次匹配可用的匹配规则，如果某管控策略有多条，则获取修改时间最新的匹配规则
+ 可选开票申请单表头字段：购方税号、购方名称、~~客户.名称~~、数据来源、数据来源系统、发票种类、标准扩展字段、二开字段
+ 范围：自动开具负数发票时获取匹蓝规则，匹蓝接口获取匹蓝规则、负数开票申请单自动匹配的弹窗、匹配结果页自动匹配弹窗

![](https://cdn.nlark.com/yuque/0/2025/png/12881570/1753625805761-ba559487-7502-40a9-bee4-63506bb98c1f.png)

（５）开具负数发票匹配原蓝票，获取匹红字确认单规则时支持匹配条件：

+ 匹配红字确认单规则下方增加匹配项面板，获取规则时，获取本组织可用的、符合匹配条件的匹红字确认单规则，当存在多条时，获取修改时间最新的一条。
+ 可选开票申请单表头字段：购方税号、购方名称、~~客户.名称~~、数据来源、数据来源系统、发票种类、标准扩展字段、二开字段。
+ 范围：自动开具负数发票时获取匹蓝规则（未配置匹配项面板时，按照私有＞自由分配＞逐级分配＞管控范围内共享＞全局共享顺序，依次匹配、可用的、修改时间最新的匹配规则）、负数开票申请单自动匹配的弹窗（未配置时不展示）、匹配结果页自动匹配弹窗（未配置时不展示）。

![](https://cdn.nlark.com/yuque/0/2025/png/12881570/1753626772123-b00a8f11-e652-4642-8c43-6cde6cb704dc.png)

（６）负数开票申请单关联蓝票时，当蓝票为部分红冲时，在标准拆合开票工作台，方案处理步骤点击自动匹配，可自动匹配原蓝票明细序号。

## 自动开票方案相关配置说明【暂无配置】
## 自动开票方案相关接口说明【暂无接口】
| 编号 | 接口名称 | 接口用途 | 接口链接 |
| --- | --- | --- | --- |
|  |  |  |  |
|  |  |  |  |


## 
