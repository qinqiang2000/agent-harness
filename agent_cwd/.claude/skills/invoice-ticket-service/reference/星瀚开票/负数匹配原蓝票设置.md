文档适用范围：星空旗舰版开票

## 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1.0 | 2025.11.05 |  | 初稿发布 |  |


## 负数匹配原蓝票设置操作路径及所属模块编码
操作路径：【发票服务】→【基础资料】→【开票参数设置】→【负数匹配原蓝票设置】

所属模块编码：<font style="color:rgb(38, 38, 38);">F17025</font>

所属模块名称：<font style="color:rgb(0, 0, 0);">负数匹配原蓝票设置</font>

## 负数匹配原蓝票设置功能设计理念概述
### 用户痛点
1. 金四红冲规则变革
    1. 企业升级金税四期后，红冲规则变得非常严格，需红冲发票时，必须关联原蓝票、及原蓝票明细行才可进行红冲。
    2. 金税四期开具红票时，必须生成红字确认单，当蓝票被对方进行入账或者抵扣，还需要对方进行确认后，才可红冲发票。
2. 企业业务复杂，无法应对税局红冲规则。企业在B2B的交易中，存在多门店调拨、折让等非常复杂的红冲场景，这些场景中，开具红票可能无法对应至原蓝票、及原蓝票明细。

### 特性亮点
1. 匹配规则灵活：支持自定义负数开票申请单应按哪些信息匹配蓝票，例如按照购销方信息、商品名称、税编、单价等多种维度进行匹配，同时，支持二开拓展信息匹配。
2. 多种使用方式：支持页面执行匹配、接口执行匹配两种方式，满足多种使用场景
3. 兼容金税三期、四期多个票种：支持按照需红冲的发票种类自动区分流程，例如红票为数电票时，自动生成红字确认单；红票为税控专票时，自动生成红字信息表；红票为税控普票时，自动红冲。

### 常用场景
1. 企业有逆向的业务，例如退货、折让时，开具红票无法对应原蓝票，需要发票服务根据指定信息自动匹配蓝票。

## 负数匹配原蓝票设置功能详解
### 负数匹配原蓝票设置单据提交操作说明
#### 负数匹配原蓝票设置单据提交关键字段说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">字段名称*</font>** | **<font style="color:rgb(26, 26, 26);">业务含义*</font>** | **<font style="color:rgb(26, 26, 26);">字段规则*</font>** | **<font style="color:rgb(26, 26, 26);">其他属性说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 编码 | 规则的唯一编码 | 系统自动生成，全局唯一 |  |
| 2 | 名称 | 企业自定义名称 | 自行定义，可重复 |  |
| 3 | 使用状态 | 标记规则是否可用 |  |  |
| 4 | 创建组织 | 创建当前规则的组织名称，系统默认预置一条规则，创建组织为管理员 |  |  |
| 5 | 控制策略 | 本条规则可用的范围 |  |  |
| 6 | 创建时间 | 当前规则创建的时间 |  |  |


#### 负数匹配原蓝票设置单据提交按钮说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">按钮名称*</font>** | **<font style="color:rgb(26, 26, 26);">功能描述*</font>** | **<font style="color:rgb(26, 26, 26);">使用条件</font>** | **<font style="color:rgb(26, 26, 26);">其他说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 分配 | 将该配置分配给下级组织或指定组织，可通过组织或数据查询分配情况 | <font style="color:#000000;background-color:#FAFAFA;">“使用组织”与“创建组织”相同</font> |  |
| 2 | 管理 | <font style="color:#000000;">可变更控制策略，确认要变更后，可将私有转成其他模式（逐级分配、自由分配、全局共享和管控范围内共享）</font> | <font style="color:#000000;background-color:#FAFAFA;">“使用组织”与“创建组织”相同</font> |  |
| 3 | 新增 | <font style="color:#000000;">新增规则</font> | <font style="color:#000000;background-color:#FAFAFA;"></font> |  |
| 4 | 删除 | <font style="color:#000000;">删除规则</font> | <font style="color:#000000;background-color:#FAFAFA;"></font> |  |


#### 算法说明
##### 自动匹配
###### 无蓝票时匹配，需匹配蓝票及明细
负数开票申请单明细行和蓝票行进行匹配，匹配的蓝票是在发票服务的蓝票，不包含在税局未下载到发票服务的蓝票，匹配处理步骤如下：

1. 将负数开票申请单的第一行明细按章节【3.1.4.4 原蓝票红冲规则】配置的条件，找50行符合条件的蓝票行，须符合的条件包括：
    1. 判断业务信息是否匹配：章节【3.1.4.3匹配蓝票字段】，负数开票申请单与蓝票需要符合所配置的条件，包含表头购销方、明细的商品名称、税率等。
    2. 判断剩余可红冲金额/数量是否匹配：
        1. 章节【3.1.4.2匹配基准】：按照是使用数量匹配（仅匹配接口支持）、还是按金额匹配。
        * 当按数量匹配时，结合【3.1.4.10 允许一行负数明细匹配到多行原蓝票明细】配置，当配置关闭时，仅当蓝票行的剩余可红冲数量大于负数单行数量时，本蓝票行可用，当开启时，蓝票行的剩余可红冲数量≠0即可用，无论是否大于负数行数量。
        * 当按金额匹配时，红冲原因为销售退回或服务中止，默认按剩余可红冲金额匹配，红冲原因为销售折让时，可按章节【3.1.4.13 销售折让金额匹配值】区分是使用剩余可红冲金额匹配或按照剩余可折让金额匹配。确认匹配值后结合【3.1.4.10 允许一行负数明细匹配到多行原蓝票明细】配置，当配置关闭时，仅当蓝票行的剩余可红冲金额/剩余可折让金额大于负数单行红冲金额（不含税）时，本蓝票行可用，当开启时，蓝票行的剩余可红冲金额/剩余可折让金额≠0即可用，无论是否大于负数行红冲金额（不含税）。
        2. 章节【3.1.4.5允许忽略单价】控制负数行单价和蓝票的单价匹配时，两者在什么偏差范围内，蓝票行视为可用。另外使用那个蓝票单价，取决于配置章节【3.1.4.6单价可匹配值】：区分负数行单价与蓝票原蓝票单价或可红冲单价匹配，当可红冲单价为空时，使用原蓝票单价匹配。
    3. 蓝票符合章节【3.1.3.14可匹配原蓝票增值税用途状态】中配置的状态
    4. 符合章节【3.1.3.9数电可红冲税控发票】配置



2. 负数单剩余明细行循环第一步骤的匹配规则进行匹配，直到所有行被匹配完成，每行负数行匹配到最多50行蓝票行。
3. 将所有蓝票行对应蓝票的匹配命中次数从大到小排序，从命中次数最多的蓝票中，获取匹配的负数行，存在命中次数相同的蓝票时，按照【3.1.4.8 原蓝票红冲规则】按金额或开票时间排序后匹配，匹配时计算：
    1. 按金额匹配时：
        1. 计算红冲数量=红冲金额/被匹配蓝票的可红冲单价（无论按什么蓝票原单价还是剩余可红冲单价匹配，计算时都使用单价匹配），数量可保留的位数可通过章节【3.1.3.13数量小数位限制】控制，但是当按位数保留时，超过数量*可红冲单价计算的金额与红冲金额超过±0.01尾差，则不按配置保留位数。
        2. 当配置的【3.1.4.10 允许一行负数明细匹配到多行原蓝票明细】，存在某一张蓝票金额不足时，继续找下一张蓝票进行匹配。
        3. 特殊处理：当红冲金额=蓝票剩余可红冲金额时，红冲税额=蓝票剩余可红冲税额、红冲数量=蓝票剩余可红冲数量
    2. 按数量匹配时：
        1. 计算红冲不含税金额=红冲数量*可红冲单价，红冲税额=红冲不含税金额*税率。
        2. 当配置的【3.1.4.10 允许一行负数明细匹配到多行原蓝票明细】，存在某一张蓝票金额不足时，继续找下一张蓝票进行匹配。
4. 匹配完成后，再从命中次数第二的发票中匹配负数行，直到负数行被匹配完成。
5. 匹配完成后，可下推生成红字信息，当红票为数电票时，生成红字确认单，红字确认单可开红票。当红票为税控专票时，生成红字信息表，红字信息表可开红票。当红票为税控普票时，生成红字发票。



二、匹配效果

1. 蓝票行可匹配的红冲金额不超过蓝票剩余可红冲金额，可匹配数量不超过蓝票行剩余可红冲数量，不可超额红冲
2. 一个负数行可以匹配多行蓝票明细
3. 一张蓝票以及蓝票行在同一个匹配批次允许被多个负数行匹配，生成红字确认单时，将同一张蓝票同一行明细合并后，生成红字确认单中的一行（开发中）



三、生效范围

1. 负数开票申请单，进入工作台点击自动匹配按钮。
2. 负数开票申请单页面，点击自动匹配按钮。



##### 手动匹配
自动匹配失败后，支持手动匹配。手动匹配时，仅控制购销方、票种、剩余可红冲金额、税率是否符合条件。



<font style="color:rgb(0, 0, 0);">1、可选本批次内，已被匹配的蓝票，但暂不支持选该蓝票已被匹配的行。</font>

#### 负数匹配原蓝票设置单据提交主要操作说明
本页面可配置负数匹配蓝票的规则，包括匹配指定类型、指定范围的蓝票等规则。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726306669850-292622a9-9feb-46e2-8a7b-92c4ac166ae6.png)

##### **红冲原因**
配置本规则适用于哪些红冲原因，支持选择销售折让、销货退回、服务终止，不支持开票有误。开票申请单是对应红冲原因时，仅支持对应红冲原因的单据选择。

（1）当红冲原因为销售退回、服务中止时，按负数单据明细红冲金额与剩余可红冲金额匹配

（2）当红冲原因为销售折让时，可配置负数单据明细红冲金额与剩余可折让金额匹配，剩余可折让金额可配置折让比例，折让比例配置方法见本文档4.负数匹配原蓝票设置相关配置说明。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726306854182-a98f2038-57a9-4d17-a922-990986bebf59.png)

##### **匹配基准**
配置本规则执行时，按照红冲金额或红冲数量进行匹配。

（1）按红冲金额匹配

       按照单据明细的红冲金额进行匹配，匹配完成后，按照金额/单价重算红冲数量

（2）按红冲数量匹配

       按照单据明细的红冲数量进行匹配，蓝票明细匹配完成后，按照数量*单价，本匹配方式仅支持使用匹配接口进行匹配，不支持页面匹配。

**提示：**当配置章节3.1.3.9允许一行明细匹配多行时，按红冲金额匹配、按数量匹配，均允许一行负数明细匹配多行。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726306869254-9ace4835-97ff-4654-8bdc-a7048434e9b0.png)

##### **匹配蓝票字段**
可配置发票表头和明细匹配字段，配置后，负数开票申请单和蓝票指定字段相同时可进行匹配。例如明细配置时，选择商品名称、税收分类编码字段，则匹配时，负数开票申请单和蓝票明细的商品名称和税收分类编码一致时才能匹配成功。

（1）配置方法：点击字段设置，可选取需要匹配的字段。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726307148805-85fe614c-5b46-4e8e-9e42-adc77960bce2.png)

购方名称改为可配置项，默认配置需按照购方税号+购方名称匹配

（1）当仅配置按购方税号匹配，不配置按购方名称时：

+ 单据有购方税号时，仅按照税号匹配
+ 单据只有购方名称、没有税号时，按照名称匹配

（2）当配置按购方税号、购方名称匹配时：

+ 单据有购方名称、购方税号时，必须购方名称+税号一致的蓝票才允许匹配
+ 单据只有购方名称、没有税号时，按照名称匹配

![](https://cdn.nlark.com/yuque/0/2025/png/47254879/1750820083377-f36373c5-5766-4e94-8f1d-bc17ad2f3861.png)

##### 原蓝票红冲规则
配置匹配蓝票时，按什么顺序找蓝票。

1、开票时间最远优先：在配置的可匹配蓝票开票时间范围内，从开票时间最早的发票行开始匹配。

2、开票时间最近优先：在配置的可匹配蓝票开票时间范围内，从开票时间最晚的发票行开始匹配。

3、金额从小到大：在配置的可匹配蓝票开票时间范围内，按照蓝票金额（非剩余可红冲金额）从小到大排序后匹配。

4、金额从大到小：在配置的可匹配蓝票开票时间范围内，按照蓝票金额（非剩余可红冲金额）从大到小排序后匹配。

![](https://cdn.nlark.com/yuque/0/2025/png/12881570/1740035724599-9660483c-fb73-4dd6-8598-ebb963ee5cf9.png)



##### 允许忽略单价
匹配明细时，是否需要将单价作为匹配条件，如开启忽略单价，则匹配时不需要匹配单价，如果配置不忽略单价，



![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726308616109-fd956eab-75b7-4268-905f-8cb4396536ea.png)

##### **单价可匹配值**
配置负数开票申请单明细单价，与蓝票的原不含税单价匹配、或是与蓝票可红冲不含税单价匹配。

1、蓝票原单价（不含税）：蓝票未折扣（折扣包括蓝票票折、红票销售折让）的不含税单价。

2、蓝票可红冲单价（不含税）：蓝票已折扣（折扣包括蓝票票折、红票销售折让）的不含税单价。配置前，请先确认发票表中可红冲单价字段有值，否则可能无法匹配成功。



示例1：原蓝票存在折扣行，产生票折

发票A的明细行数据

| 商品名称 | 行性质 | 数量 | <font style="color:#DF2A3F;background-color:#FFFFFF;">不含税单价</font> | 不含税金额 | <font style="color:#DF2A3F;">可红冲单价</font> |
| --- | --- | --- | --- | --- | --- |
| 商品1 | 被折扣行 | 2 | <font style="color:#DF2A3F;background-color:#FFFFFF;">100</font> | 200 | <font style="color:#DF2A3F;">60=（200-80）/2</font> |
| 商品1 | 折扣行 |  |  | -80 |  |




![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1732604279913-d2a0b182-0522-4aa5-ae7b-9d79ac991aa4.png)

##### **可匹配蓝票开票时间范围**
指定可匹配的原蓝票范围，可按天或按月配置，最长可配置最近5年。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726307740558-1b040cad-fe10-4d49-912f-b35b44fd12f4.png)

##### **原蓝票红冲规则**
筛选出符合匹配字段、蓝票开票时间后的蓝票数据中，优先匹配开票时间最远、或开票时间最近、或金额最大、或者金额最小的蓝字发票。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726307793783-d5b1a91e-0989-49f5-9dfb-5f842ce393a5.png)

##### **数电可红冲税控发票**
配置当负数单据需开具数电票，匹配原蓝票时，是否可匹配到税控发票。

说明：税局规定，当销方的税控设备未缴销，且有余票时，原蓝票为税控发票，仅允许使用税控发票红冲， 不支持使用数电票红冲。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726307868422-438b1c37-93ea-47bb-947c-93ec8f82dfdd.png)

##### **允许一行负数明细匹配到多行原蓝票明细**
开启后，负数一行可能会匹配到多行。

示例：

负数开票申请单明细如下

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | -100 |


负数开票申请单执行匹配蓝票时，按照其他条件，筛选到蓝票A

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | 50 |
| 商品1 | 50 |


如果开启本配置，则蓝票A被匹配成功，最终按蓝票生成红字确认单，并按蓝票开具红冲，即红票票面为：

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | -50 |
| 商品1 | -50 |


如果关闭本配置，该蓝票不会被匹配。 

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1744269416205-81bf83b2-7575-44c4-b7eb-d2c5f72ba809.png)

##### ****<font style="color:rgb(0, 0, 0);">允许一行蓝票明细被多行负数明细匹配</font>
开启后，同一个匹配批次中，同一张发票的同一行可被多次匹配到，负数明细行和蓝票明细行多对一，多次匹配的总红冲金额不可超过发票的剩余可红冲金额/剩余可折让金额。未开启时，按照原逻辑，一行蓝票明细只使用一次。

若匹配成功，生成红字确认单时，获取当前匹配批次中，匹配到同一蓝票号码、同一蓝票明细行时，合并为一行红字确认单明细。

示例：

负数开票申请单明细如下

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | -50 |
| 商品1 | -50 |


负数开票申请单执行匹配蓝票时，按照其他条件，筛选到蓝票A

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | 100 |


如果开启本配置，则蓝票A被匹配成功，最终按蓝票生成红字确认单，并按蓝票开具红冲，即红票票面为：

| 商品名称 | 金额 |
| --- | --- |
| 商品1 | -100 |


如果关闭本配置，该蓝票不会被匹配。 

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1744269395907-6f6e62d3-5a51-4e3e-91f2-cf21ddf839b2.png)

##### 销售折让不匹配单价
销售折让时，完全忽略单价。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726309110678-f2fb0c33-37c5-4c16-926b-e441e9b82401.png)



##### 销售折让金额匹配值
当红冲原因为销售折让时，负数开票申请单明细金额与蓝票明细按剩余可折让金额匹配、按剩余可红冲金额匹配。

1、剩余可红冲金额：当前明细总的剩余可用于红冲的金额，等于原蓝票金额 - |折扣行金额| - 开具销售退回/销售折让/服务中止红票金额

2、剩余可折让金额：

（1）当前明细可用于折让的金额，|剩余可折让金额|＜=|剩余可红冲金额|，可配置折让比例，配置方式见本文档章节5.

（2）等于原蓝票金额 - |折扣行金额| -开销售折让红票金额-销货退回/服务中止时按数量及折让比例扣减金额

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1732604749974-3f6e1c6e-e866-43fa-a143-5ae136cb26e3.png)

##### 数量小数位限制
当按红冲金额匹配明细时，按负数单据明细金额/原蓝票单价，重新计算可红冲数量，本配置用于控制重新计算数量时，数量应保留几位小数，超出部分进行四舍五入。如果按配置保留小数位后超出税局允许的尾差范围，则不按配置的位数保留。

税局尾差校验：

<font style="color:rgb(0,0,0);">单行金额校验：|单价*数量-金额|<=0.01。 </font>

<font style="color:rgb(0,0,0);">单行税额校验：| 金额 * 税率 - 税额 |<=0.06。 </font>

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726309174229-021ec580-a70b-4987-9fd9-9e429aeffe7f.png)

##### **可匹配原蓝票增值税用途状态**
当被匹配的蓝票增值税用途状态为指定状态时，蓝票可被匹配到。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1735093316598-2166e52d-fac0-401d-8d78-faf224439afa.png)

匹配条件增加入账状态、消费税用途状态。

![](https://cdn.nlark.com/yuque/0/2025/png/47254879/1750819781774-da2a954c-dae3-4a83-aecc-6b3e94325588.png)

##### **设置匹配项面板**
<font style="color:rgb(33, 33, 33);">匹配蓝票规则下方增加匹配项面板，先获取本组织可用的匹蓝规则（包含所有控制策略），判断其中符合单据红冲原因的匹配规则中，单据是否有符合匹配项面板配置的匹蓝规则：</font>

    1. <font style="color:rgb(33, 33, 33);">如果无符合的匹配项，则将所有匹配蓝票规则，按照私有＞自由分配＞逐级分配＞管控范围内共享＞全局共享顺序，依次匹配可用的匹配规则，如果某管控策略有多条，则获取修改时间最新的匹配规则</font>
    2. <font style="color:rgb(33, 33, 33);">如果有符合的匹配项，则将符合匹配项的匹配蓝票规则，按照私有＞自由分配＞逐级分配＞管控范围内共享＞全局共享顺序，依次匹配可用的匹配规则，如果某管控策略有多条，则获取修改时间最新的匹配规则</font>

<font style="color:rgb(33, 33, 33);">可选开票申请单表头字段：购方税号、购方名称、客户.名称、数据来源、数据来源系统、发票种类、标准扩展字段、二开字段。</font>

<font style="color:rgb(33, 33, 33);">范围：自动开具负数发票时获取匹蓝规则，匹蓝接口获取匹蓝规则、负数开票申请单自动匹配的弹窗、匹配结果页自动匹配弹窗。</font>

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1756102596526-3a49700f-0818-413a-b2d5-2a03d1f0d578.png)

## 负数匹配原蓝票设置相关配置说明
1. 销售折让时，蓝票可折让比例配置：[https://www.yuque.com/piaozone/implement/egoz20](https://www.yuque.com/piaozone/implement/egoz20)

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726304420307-ad15417e-187e-4b33-abb5-0f2b39e0eee9.png)

## 负数匹配原蓝票设置相关接口说明
| 编号 | 接口名称 | 接口用途 | 接口链接 |
| --- | --- | --- | --- |
| 1 | 1.1.08 创建负数单匹配任务 | 传输负数单据信息，根据传输信息匹配原蓝票 | [https://piaozone-ultimate.apifox.cn/api-194841116](https://piaozone-ultimate.apifox.cn/api-194841116) |
| 2 | 1.1.09 查询负数单匹配任务结果 | 查询匹配到的原蓝票结果 | [https://piaozone-ultimate.apifox.cn/api-194893206](https://piaozone-ultimate.apifox.cn/api-194893206) |




