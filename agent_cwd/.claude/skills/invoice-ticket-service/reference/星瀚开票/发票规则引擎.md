## 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1.0 | 2025.11.17 |  | 初稿发布 |  |
|  |  |  |  |  |


## 发票规则引擎操作路径
【发票云】-【开票管理】-【海外发票】-【系统设置】-【发票规则引擎】

## 发票规则引擎功能设计理念概述
### 功能定位
 “发票规则引擎”用于为海外发票配置、维护发票业务规则（如信息补全、校验等），按**国家/地区 **进行管理。  
主要使用角色包括：实施顾问、系统管理员、财务/税务关键用户（Tax Specialist、AP Accountant 等）。  

### 设计理念与使用价值
+ 按 **国家/地区维度** 管理发票规则，确保不同市场可以配置适配当地法规和业务的规则逻辑.
+ 通过 **规则类型 + 发票类型/子类型 + 优先级** 组合，对同一发票场景的多条规则进行精细管控。
+ 使用 **JEXL Expression Editor** 将条件与执行逻辑表达为脚本，提升规则的可配置性与可维护性。
+ 内置 **测试和调试** 区域，可在保存前对规则进行本地测试，降低规则上线风险。
+ 支持通过 **AI生成内容** 辅助编写表达式，降低用户直接编写脚本的门槛。

## 发票规则引擎功能详解
### 发票规则引擎关键字段说明
| **字段名称** | **业务含义** | **字段规则说明** | **其他说明** |
| --- | --- | --- | --- |
| <font style="color:#000000;">国家/地区</font> | <font style="color:#000000;">当前正在配置规则所属的国家或地区</font> | <font style="color:#000000;">下拉选择。切换后左侧规则列表随之切换，仅展示该国家/地区下的规则。</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">规则名称</font> | <font style="color:#000000;">当前规则的业务名称</font> | <font style="color:#000000;">文本输入，必填，用于在左侧规则列表和详情页中标识该规则。</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">规则类型</font> | <font style="color:#000000;">用于区分当前规则的用途，是“发票规则引擎”的核心分类字段  </font> | <font style="color:#000000;">下拉必选，当前支持两类：   </font>**Information Completion Rules**<font style="color:#000000;">：用于 </font>_Auto-complete missing invoice information fields_<font style="color:#000000;">，即自动补全缺失的发票信息字段。   </font>**Validation Rules**<font style="color:#000000;">：用于 </font>_Verify invoice information completeness and accuracy_<font style="color:#000000;">，即校验发票信息的完整性与准确性。   </font><font style="color:#000000;">不同类型决定规则脚本主要用于“补全数据”还是“做校验并返回错误信息”。  </font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">发票类型</font> | <font style="color:#000000;">定义当前规则适用的发票大类  </font> | <font style="color:#000000;">下拉必选。用于限定规则只对选定类型的发票生效。系统会根据发票类型在处理过程中决定是否触发此规则。  </font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">发票子类型</font> | <font style="color:#000000;">规则适用的发票子类型</font> | <font style="color:#000000;">用于进一步限定规则只作用于特定子类型</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">生效日期</font> | <font style="color:#000000;">规则生效的日期时间</font> | <font style="color:#000000;">日期时间字段，只有当前时间在生效日期之后，规则才有机会被执行</font> | <font style="color:#000000;">示例：2025-11-17 19:37:34</font> |
| <font style="color:#000000;">失效日期</font> | <font style="color:#000000;">规则生效的日期时间</font> | <font style="color:#000000;">日期时间字段，当前时间超过失效日期后，规则不再参与执行。</font> | <font style="color:#000000;">示例：2026-11-17 19:37:34</font> |
| <font style="color:#000000;">优先级</font> | <font style="color:#000000;">同一场景下多条规则的优先顺序</font> | <font style="color:#000000;">数字输入。数值大小代表执行顺序。</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">规则描述</font> | <font style="color:#000000;">对规则的业务说明</font> | <font style="color:#000000;">文本输入，建议描述规则目的、适用场景、关键逻辑，便于后续维护</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">字段路径</font> | <font style="color:#000000;">规则作用目标字段的路径</font> | <font style="color:#000000;">例 e.g.invoice.vat_details</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">错误信息</font> | <font style="color:#000000;">规则未通过时的提示文案</font> | <font style="color:#000000;">文本输入，用于在规则校验失败时反馈给用户或日志的错误信息</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">激活状态</font> | <font style="color:#000000;">当前规则是否参与实际执行</font> | <font style="color:#000000;">开关控件。开启时规则在满足条件且生效期内参与执行；关闭时不参与执行但仍保留配置</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">规则表达式</font> | <font style="color:#000000;">规则脚本的配置区域</font> | <font style="color:#000000;">包含“条件”和“执行（当条件为真时）”两块 JEXL 编辑器</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">条件</font> | <font style="color:#000000;">规则触发条件配置分区</font> | <font style="color:#000000;">当条件表达式返回为真（true）时，下方“执行（当条件为真时）”中的脚本才会执行</font> | <font style="color:#000000;">条件使用 JEXL 表达式编辑</font> |
| <font style="color:#000000;">执行（当条件为真时）</font> | <font style="color:#000000;">条件满足时的执行逻辑分区</font> | <font style="color:#000000;">当“条件”表达式为真时，此处 JEXL 脚本将被执行，用于对目标字段赋值、变更等</font> | <font style="color:#000000;">使用 JEXL 表达式编辑</font> |
| <font style="color:#000000;">测试和调试</font> | <font style="color:#000000;">规则测试区域标题</font> | <font style="color:#000000;">汇总“测试数据”“执行结果”“调试日志”三个面板，用于在页面内对当前规则进行验证</font> | <font style="color:#000000;"></font> |


### 发票规则引擎按钮说明
| **<font style="color:#000000;">按钮名称*</font>** | **<font style="color:#000000;">功能描述*</font>** | **<font style="color:#000000;">使用条件</font>** | **<font style="color:#000000;">其他说明</font>** |
| --- | --- | --- | --- |
| <font style="color:#000000;">＋（左侧蓝色加号图标）</font> | <font style="color:#000000;">新增一条发票配置规则</font> | <font style="color:#000000;"></font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">保存规则</font> | <font style="color:#000000;">保存当前规则配置</font> | <font style="color:#000000;">需要至少填写必填字段（如规则名称、规则类型等），保存后规则将按生效日期与激活状态参与规则引擎执行</font> | <font style="color:#000000;"></font> |
| <font style="color:#000000;">测试运行</font> | <font style="color:#000000;">使用下方“测试数据”对当前规则进行一次测试执行</font> | <font style="color:#000000;">已配置并保存规则表达式，可以使用此功能进行测试。</font> | <font style="color:#000000;"></font> |


### 发票规则引擎主要操作说明
#### 新增发票规则
**操作目标**  
为指定国家/地区、新的业务场景场景新增一条发票规则。

**操作步骤**

1. 在左侧 **国家/地区** 下拉框中选择目标国家/地区，例如 `CN -China`。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429543624-2aa1c1a8-9254-44cd-9c27-704a9aad306d.png)

2. 点击左侧标题栏的 **＋（蓝色加号图标）**，创建新规则。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429567763-ff640f8a-1e13-443c-b13c-9a767562fdc9.png)

3. 在中间“规则配置”区域填写基础信息：
+ **规则名称**：输入易于识别的规则名称，例如“VAT 信息补全规则（普通发票）”。
+ **规则类型**：选择 `Information Completion Rules` 或 `Validation Rules` 。
+ **发票类型 / 发票子类型**：根据规则适用场景进行选择。
+ **生效日期 / 失效日期**：设置规则有效期。
+ **优先级**：填写数字以控制执行顺序。
+ **规则描述**：补充规则用途与简要说明。
+ **字段路径**：填写目标字段路径，例如 `invoice.vat_details`。
+ **错误信息**：填写规则不通过时需要提示的文案。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429710991-8ff13d16-f1e5-4efb-920b-8ebd18db6313.png)

4. 根据业务逻辑，在右侧 **规则表达式** 中配置：
+ 在 **条件** 的 `JEXL Expression Editor` 中编写触发条件表达式，或在“AI生成内容”区域输入说明并点击 **发送** 生成脚本后再调整。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429749891-c2cf4481-987a-451a-b0bb-2ade0b577183.png)

+ 在 **执行（当条件为真时）** 的编辑器中编写执行逻辑脚本，同样可通过 AI 辅助生成。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429778975-2b0adc70-caef-4b95-b39d-d90cbdc62041.png)

+ 必要时点击 **验证** 按钮检查表达式语法，使用 **格式化** 按钮优化排版。
5. 在页面内完成规则 **测试和调试**：
    1. 向下滚动到页面底部的 **测试和调试** 区域。
    2. 点击右上角 **测试执行** 按钮。
    3. 在 **执行结果** 面板中查看条件是否被触发、目标字段值是否符合预期。
    4. 如有异常，在 **调试日志** 面板中查看详细日志，定位问题；必要时返回“规则表达式”区域修正脚本，并再次测试，直至结果符合预期。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763430269284-609365c3-1266-4a72-a2dd-dd08d286cff7.png)

6. 确认规则配置及测试结果均符合预期后，返回页面顶部，点击右上角 **保存规则**。

**结果说明**

新规则将在左侧规则树中以规则 ID 或名称形式显示（例如 `custom-10-11009-0005`）。

若 **激活状态** 为开启且当前时间处于有效期内，规则将在后续发票处理流程中按配置参与执行。

#### 编辑现有发票规则
**操作目标**  
修改已有发票规则的基础信息或规则表达式。

**操作步骤**

1. 在左侧 **国家/地区** 下拉框中选择目标国家/地区。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763429543624-2aa1c1a8-9254-44cd-9c27-704a9aad306d.png?x-oss-process=image%2Fformat%2Cwebp)

2. 在左侧规则树中展开相应分组（例如 **General**），点击要编辑的规则（例如 `custom-10-11009-0005`）。（激活状态的规则在左侧规则树中将展示绿色原点，其他状态为灰色圆点）

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763430121001-0cef487a-651f-4b0d-baf8-a9b275b2617f.png)

3. 在中间“规则配置”区域修改需要调整的字段，如 **规则描述**、**字段路径**、**错误信息** 等。
4. 在右侧 **规则表达式** 区域中：
        * 更新 **条件** 或 **执行（当条件为真时）** 的 JEXL 脚本。
        * 使用 **验证** 按钮检查脚本语法是否正确。
        * 使用 **格式化** 提升脚本可读性。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763430133708-b8af4aa2-8a8f-416a-a935-6c4390f7b5e6.png)

5. 如需暂时停用该规则，可在 **激活状态** 开关处关闭。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763430147231-99cda0c1-7e76-4d66-a26c-6ebcea39613d.png)

6. 修改完成后，点击右上角 **保存规则**。

**结果说明**

+ 修改后的规则会立即保存。若规则处于激活状态，则在下一次业务执行中按照新的逻辑运行。
+ 若停用了规则，系统将不再根据该规则进行判断与执行，但配置仍被保留，可随时重新启用。

#### 启用或停用规则
**操作目标**  
控制规则是否参与发票处理逻辑，适用于灰度上线或临时停用规则的场景。

**操作步骤**

1. 在左侧规则列表中选择目标规则。
2. 在“规则配置”区域找到 **激活状态** 开关。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1763430436777-9af021ad-4bf0-416c-8316-5fafb2cc08ab.png)

3. 切换为开启（启用）或关闭（停用）。
4. 点击 **保存规则**。

**结果说明**

+ 启用后：在规则生效期内，且条件满足时，规则会按配置的 JEXL 脚本执行。
+ 停用后：即使条件满足，规则也不会被触发，相当于逻辑被临时关闭，但配置仍保留，随时可再次启用。

