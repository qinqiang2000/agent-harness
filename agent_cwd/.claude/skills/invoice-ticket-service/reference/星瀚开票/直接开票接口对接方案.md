| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-11-13** | **支三垒** |


# 直接开票异构对接说明
本文档旨在方便各异构的系统与金蝶发票云系统功能结合，使对接上游系统可以快速、高效的完成开票申请单异构对接，以适应该税改政策，完成全电发票的开具。如有异议请予指正。

# 直接开票适用场景
**<font style="background-color:#FBDE28;">开票场景：</font>**

+ 调用方通过调用金蝶开票接口推送开票信息
+ 发票云返回调用接口状态
+ 发票云调用回调方法将发票信息返回给调用方。（回调方法由调用方提供）
+ 支持根据发票流水号查询发票

<font style="color:#8A8F8D;background-color:#E8F7CF;">注意：已经下推开票的数据不允许撤回和调整开票信息</font>

**<font style="background-color:#FBDE28;">适用范围：</font>**

+ 支持企业直接上传开票数据开票
+ 支持开票类型：数电票（普票）、数电票（专票）、专用发票、普通发票、卷式发票、电子发票、电子专票 (税务 ukey才能开具)
+ 所有开票数据支持反写客户ERP 系统

## 业务流程图
![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764141552042-690fde19-8938-498f-8552-dcd9d17ec23e.png)

## 流程说明
| **编号** | **步骤** | **前置条件** | **操作人** | **工作说明** | **输出** | **系统** |
| :---: | :---: | :---: | --- | --- | :---: | :---: |
| 1 | 发起开票申请 | 应收系统存在业务单据 | 业务部门/应收 | 应收业务人员在异构系统里进行业务单据的处理，异构系统可支持应收业务人员对业务将确认需要开票的数据请求下推请求开票（需确认开票类型及金额，填写完整可靠的开票信息） | 提交开票 | 异构系统 |
| 2 | 向星瀚系统发起开票请求 | 发起开票申请 | 系统 | 异构系统的开票申请单数据通过金蝶发票云的开票申请单上传接口进行同步数据，把数据传给金蝶发票云进行发票开具处理。<br/> | 直接开票 | 金蝶 |
| 3 | 发票开具 | 提交开票成功 | 系统 | 金蝶发票云系统对开票数据进行确认；调用此税号下的对应税盘或乐企平台或省电子税局，进行发票的开具。 | 发票 | 税控 |
| 4 | 发票信息返回 | 发票开具 | 系统 | 返回开票信息到异构系统：包括开票状态、开票时间、开票金额、发票号码、发票代码、发票影像url。 | 发票 | 异构系统 |
| 6 | 发票查询 | 发票开具成功 | 开票人员 | 企业正常开具的发票集中在销项池的发票查询中，支持查询管理重发等操作。 | 发票 | 金蝶 |


# 接口执行顺序
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391280835-1306b317-0802-41e2-b2c6-7759248210f0.png)

## 获取接口授权
+ 接口名字：1.01.获取app_token
+ 接口地址：[https://open.piaozone.com/api-145421044](https://open.piaozone.com/api-145421044)

```json
"appId": "xxx",
"appSecuret": "xxxx",
"accountId": "xxx"
```



**<font style="color:#117CEE;">8.0路径</font>**<font style="color:#117CEE;">：【开放服务云】→【OpenApi】→【安全策略】→【第三方应用】  </font>

首次对接可根据对接系统不同创建不同的应用id

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764123926005-d125f176-ad86-4e45-9dd8-0ca543e82174.png?x-oss-process=image%2Fformat%2Cwebp)

AppId与AppSecuret为个性化设置

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391281858-51a123a7-ce4a-49e7-afbb-377e703c8daf.png)

点击获取获取Token示例

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391282204-f2620145-f694-4608-9a21-f2e46df2fafe.png)

只需替换appSecret与apptoken即可调通获取当前登录系统用户的授权接口

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391282465-0b06fbf1-3d42-4616-bb50-3de5498356d8.png)

**<font style="background-color:#FBDE28;">常见异常</font>**

+ 数据中心accountId参数不对

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391282658-5ce28385-ed3b-4a5b-af15-ed64fce33230.png)

+ appid/appsecuret参数不对

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391282912-b77b818f-09cd-4a29-aecb-4df8313f703a.png)

+ 接口名字：1.02获取access_token
+ 接口地址：[https://open.piaozone.com/api-145421045](https://open.piaozone.com/api-145421045)

## 调用直接开票接口
+ 接口名字：2.1.01 数电票蓝字发票开具
+ 接口地址：[https://open-ultimate.piaozone.com/api-149332334](https://open-ultimate.piaozone.com/api-149332334)

**<font style="background-color:#FBDE28;">常见报错1：</font>**未进行接口授权

解决方式：打开授权

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391283125-a21b5854-3ec4-49ad-8ecd-0c235d03a2d7.png)

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391283323-34c678b9-725b-4d84-a869-f1937d8c280c.png)

**<font style="background-color:#FBDE28;">常见报错2：</font>****未进行接口授权**

解决方式：access_token 过期，重新获取授权

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391283643-3e04aa02-76cd-464e-b4e4-30495caed65d.png)

**<font style="background-color:#FBDE28;">常见报错3：</font>**价税合计金额不对

解决方案：重新调整传入的价税合计金额重新推单

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391283981-bc26b25d-0e55-4664-87ad-adceb5388753.png)

**<font style="background-color:#C1E77E;">提交成功</font>**

<font style="color:#117CEE;">查看路径：发票云-开票管理-销项全票池</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391284306-0cf10680-5215-44ab-a599-d72ed9393d9a.png)

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391284624-044ec861-6d8d-4b60-b133-a4a1fd014d2b.png)

## 调用数电票发票单张查询接口
+ 接口名字：4.1.04.数电票发票单张查询
+ 接口地址：[https://open-ultimate.piaozone.com/api-146003726](https://open-ultimate.piaozone.com/api-146003726)

根据发票流水号获取开票后的发票信息

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391284913-678c0aaf-7e67-43e6-a46f-16415ddc9e3f.png)

## 调用回调接口-按票回调
+ 接口名字：5.1.02回调接口-按票回调(一次回调一张发票信息)
+ 接口地址：[https://open-ultimate.piaozone.com/api-146003721](https://open-ultimate.piaozone.com/api-146003721)

<font style="background-color:#D8DAD9;">注意：开票发票回调接口为对接异构系统提供，（并不需要鉴权）在星瀚发票云进行配置，当开票接收到开票请求（或开票完成后触发开票申请单回调接口）</font>

<font style="color:#117CEE;">配置回调接口路径：</font><font style="color:#117CEE;">发票云-系统管理-业务系统列表</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391285204-092b72ca-f959-48ef-8413-06cd3d20dda8.png)

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391285507-d05471b2-ca48-448b-9acd-9a02be22e84a.png)

# 接口请求示例（postman）
## 接口示例
[直接开票.json](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/json/39256605/1764142446926-147326e4-614c-4f2d-b6fe-7714b6489aaa.json)

## 回调接口配置路径
<font style="color:#117CEE;">配置回调接口路径：</font><font style="color:#117CEE;">发票云->系统管理->业务系统列表</font>

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764143361349-23641b91-3190-43d5-858d-bc39a567da0d.png)

# 实现效果
+ 开票中->可以查询到已开具的发票

<font style="color:#117CEE;">路径：发票云->开票管理->销项全票池->发票查询</font>

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764143728821-ae515484-ed76-44e5-9b10-5f26f4b4d1e5.png)

+ 开票成功->可以查询到开具中的发票

<font style="color:#117CEE;">路径：发票云->开票管理->开票过程管理->开票过程监控</font>

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764143684627-8375c4bd-f99c-49c1-8bd8-0c89f906f0c4.png)

+ 开票失败>可以查询到开具失败的发票及失败原因

<font style="color:#117CEE;">路径：发票云->开票管理->开票过程管理->开票异常处理</font>

## 调用数电蓝字发票开具->开票过程管理
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391285977-b4acbe02-0389-4975-923f-c46a2c447422.png)

## 开票过程管理->开票过程监控列表
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391286301-cac16c74-5822-4dee-8d75-a6f1a8435073.png)

## 开票过程管理->开票异常处理
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391286751-8926eb6b-08fd-4433-99cd-2b40ae2f1176.png)

## 对异常开票请求处理后开票->销项全票池
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391287093-dc656263-03f8-4bbb-99fc-7b184b18f47a.png)

## 开票后回调:发票云->系统管理->发票回调日志
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391287365-1fe07185-2d61-491b-85a9-ffb29c17a963.png)

## 异构系统接收开票回调数据
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391287649-08e5771b-9ad1-42e0-8ba7-d568fe8c06ea.png)





