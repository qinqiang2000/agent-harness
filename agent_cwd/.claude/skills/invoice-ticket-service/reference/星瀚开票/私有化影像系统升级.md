| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建/更新时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **标准版影像** | **公开** | 创建 | **2025-10-24** | **欧浩斌** |


# 文档说明
本文适用于私有化标准版影像系统升级操作，本文档描述了影像档案系统由低版本升级到最新版本的操作过程;文档所有内容仅作为参考，生产环境部署方案，请以现场实际规划为准。

# 注意事项
+ 升级选择环境使用人数比较少的时间段进行，并发送相关升级公告
+ 升级的低版本最好是在2.x.x版本以上,2.0.0以前的版本联系总部老师升级
+ 影像发版记录： [https://jdpiaozone.yuque.com/nbklz3/sszola/ibqegdth6dqp9wwl#88a0](https://jdpiaozone.yuque.com/nbklz3/sszola/ibqegdth6dqp9wwl#88a0)

# 下载升级包
确认升级目标版本，发票云仅提供最新版本包下载连接，如需其他指定版本包，需联系发票云技术人员获取。

最新升级包下载地址：

[http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip](http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip)

**账号：fpy**

**密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**

如服务器有外网权限，可直接在服务器上下载升级包，下载命令：

```sql
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip
```

# 上传升级包
升级包下载完成后，需上传到应用服务器，如有多台应用服务器，则每台都需要上传。

上传目录为服务器最大磁盘空间目录（升级包约5G，避免升级包过大，导致磁盘爆满）

建议新增子目录用于存放升级包（方便记录升级时间及次数）

# 解压升级包
解压升级包 update-image-archive.zip ，如 上传目录为 /data/up1024  执行如下命令：

```sql
#切换到升级包目录
cd /data/up1024
#解压
unzip update-image-archive.zip
```

# 备份数据库
生产环境升级前，必须备份数据库，确保数据安全。

mysql默认用户为root，现场以实际为准。

```sql
#切换到sql脚本目录
cd /data/up1024/update-image-archive/sql
#清理xxl_job日志，减少无用备份
./mysql -h mysql-ip -uroot -ppasswd -e "truncate table xxl_job.xxl_job_log; "
#mysql-ip: 替换为实际的mysql的IP
#passwd： 替换为实际的mysql密码

#执行备份
./mysqldump -h mysql-ip -uroot -ppasswd --all-databases --set-gtid-purged=OFF > all_data.sql
```

# 执行数据库升级脚本
## 获取当前版本号
```sql
#切换到sql脚本目录
cd /data/up1024/update-image-archive/sql
#获取版本号
./mysql -h mysql-ip -uroot -ppasswd  -e "select * from xxl_job.t_archive_version;"
```

## 按顺序执行升级脚本
如当前版本为2.8.1，升级目标版本为5.10.1，则需要执行2.8.1到5.10.1之间的所有sql脚本。

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1761532796665-aa370bea-3361-4e89-888a-9463f812bcbd.png)

sql脚本有两种：

+ 单个版本sql脚本，这类脚本需按版本顺序依次执行，如 v5.9.1.sql、v5.9.2.sql、v5.10.1.sql
+ 跨版本sql，这类脚本包括了两个版本号之间的所有sql脚本，如

v2.8.1-v3.2.1.sql： 包括了2.8.1到3.2.1版本之间的所有sql

v3.2.1-v3.12.2.sql： 包括了3.2.1到3.12.2版本之间的所有sql

v3.12.2-v4.8.2.sql： 包括了3.12.2到4.8.2版本之间的所有sql

v4.8.2-v5.8.2.sql： 包括了4.8.2到5.8.2版本之间的所有sql



故，从2.8.1升级到5.10.1版本，需要执行的sql有：

v2.8.1-v3.2.1.sql

v3.2.1-v3.12.2.sql

v3.12.2-v4.8.2.sql

v4.8.2-v5.8.2.sql

v5.9.1.sql、v5.9.2.sql、v5.10.1.sql

```sql
#切换到sql脚本目录
cd /data/up1024/update-image-archive/sql
#连接mysql
./mysql -h mysql-ip -uroot -ppasswd

#执行sql脚本
mysql> source history_sql/v2.8.1-v3.2.1.sql
mysql> source history_sql/v3.2.1-v3.12.2.sql
mysql> source history_sql_v3.12.2tov4.8.2/v3.12.2-v4.8.2.sql
mysql> source v4.8.1tov5.8.2/v4.8.2-v5.8.2.sql
mysql> source v5.9.1/v5.9.1.sql
mysql> source v5.9.2/v5.9.2.sql
mysql> source v5.10.1/v5.10.1.sql

#查询升级后版本号
mysql> select * from xxl_job.t_archive_version;
```

**<font style="color:#DF2A3F;">请不要重复执行sql脚本！！！</font>**

# 执行应用升级脚本
应用主节点执行：

```sql
#切换到解压目录
cd /data/up1024/update-image-archive
sh update.sh 0
```

应用从节点执行：

```sql
#切换到解压目录
cd /data/up1024/update-image-archive
sh update.sh 1
```

若不知道 update.sh 参数是传0 还是1 ，可通过如下命令查询，命令返回 1 的是传 0，  返回 0 的是传 1 。

```sql
docker ps | grep image-system|wc -l
```

待脚本运行完退出，升级完成。

# 升级验证
可以登录影像页面，查看当前版本号：

<font style="color:#117CEE;">系统管理—>租户影像配置—>基础信息—>影像版本</font>

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1761533525875-d87e4cce-d32a-4977-ab65-f8b871f6f624.png)









