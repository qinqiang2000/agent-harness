





















**乐企数字开放平台-沙箱操作指引2（用票）**



**V1.** **004**





























**修改说明**



| **版本** | **章节编号** | **修订内容描述** | **生效日期** |
| --- | --- | --- | --- |
| V1. 002 | 第五、六章 | 将章节6. 1调整至章节5. 2 | 2024-03-08 |
| V1. 004 | 第四章 | 3. 2. 2、3. 3. 2请求头新增clientTid、ptlx | 2024-11-21 |








http-equiv="Content-Type" content="text/html; charset=utf-8">











![](https://cdn.nlark.com/yuque/0/2024/png/38481329/1733233457794-0b64b8a8-e2b5-4900-bf6a-cf2f62c177ea.png)







**乐企数字开放平台-沙箱操作指引2（用票）-**

**V1.** **004**









































































2023年11月25日













**修改说明**



| **版本** | **章节编号** | **修订内容简述** | **生效日期** |
| --- | --- | --- | --- |
| V1. 000 | 全部 | 新建文档 | 2023-7-19 |






| V1. 000 | 全部 | 增加目录，添加页码 | 2023-9-19 |
| --- | --- | --- | --- |
| V1. 001 | 第六章 | 第六章6. 1. 1用票数据初始化接口，初始化场 景编码增加CSH008 | 2023-11-25 |
| V1. 002 | 第五、六章 | 将章节6. 1调整至章节5. 2 | 2024-03-08 |
| V1. 003 | 第三章 | 3. 3. 1服务请求地址newsandbox改为sandbox | 2024-11-13 |
| V1. 004 | 第四章 | 3. 2. 2、3. 3. 2请求头新增clientTid、ptlx | 2024-11-21 |
































































































**目录**

<u><font style="color:#0563C1;">第一章 概述</font></u><font style="color:#0563C1;"> </font>1

<u><font style="color:#0563C1;">第二章 接入要求</font></u>2



<u><font style="color:#0563C1;">2. 1接入要求</font></u>2 <u><font style="color:#0563C1;">第三章 测试指引</font></u>3

<u><font style="color:#0563C1;">3. 1准备工作</font></u>3

<u><font style="color:#0563C1;">3. 1. 1直连接入申请和网络白名单开通</font></u>3

<u><font style="color:#0563C1;">3. 1. 2能力订阅开通</font></u>3

<u><font style="color:#0563C1;">3. 1. 3获取直连单位平台编号</font></u>3

<u><font style="color:#0563C1;">3. 1. 4获取沙箱密钥</font></u>4

<u><font style="color:#0563C1;">3. 1. 5获取能力编码、接口编码和用例编码</font></u>4

<u><font style="color:#0563C1;">3. 1. 6虚拟单位初始化</font></u>5

<u><font style="color:#0563C1;">3. 2调用沙箱控制服务</font></u>5

<u><font style="color:#0563C1;">3. 2. 1请求地址</font></u>5

<u><font style="color:#0563C1;">3. 2. 2请求报文</font></u>6

<u><font style="color:#0563C1;">3. 2. 3返回报文</font></u>6

<u><font style="color:#0563C1;">3. 3调用沙箱数字服务</font></u>8

<u><font style="color:#0563C1;">3. 3. 1请求地址</font></u>8

<u><font style="color:#0563C1;">3. 3. 2请求报文</font></u>9

<u><font style="color:#0563C1;">3. 3. 3返回报文</font></u><font style="color:#0563C1;"> </font>10

<u><font style="color:#0563C1;">第四章 测试场景</font></u><font style="color:#0563C1;"> </font>11

<u><font style="color:#0563C1;">4. 1发票归集</font></u><font style="color:#0563C1;"> </font>11

<u><font style="color:#0563C1;">4. 2发票查验</font></u><font style="color:#0563C1;"> </font>12

<u><font style="color:#0563C1;">4. 3抵扣勾选场景</font></u><font style="color:#0563C1;"> </font>13

<u><font style="color:#0563C1;">4.4 退税勾选场景</font></u><font style="color:#0563C1;"> </font>15

<u><font style="color:#0563C1;">4.5 代办退税勾选场景</font></u><font style="color:#0563C1;"> </font>16

<u><font style="color:#0563C1;">4.6 成品油消费税勾选场景</font></u><font style="color:#0563C1;"> </font>17

<u><font style="color:#0563C1;">4.7 农产品加计扣除勾选场景</font></u><font style="color:#0563C1;"> </font>19

<u><font style="color:#0563C1;">4. 8入账标识场景</font></u>21

<u><font style="color:#0563C1;">第五章 附录</font></u>23

<u><font style="color:#0563C1;">5. 1乐企数字化电子发票用票能力相关编码</font></u>23

<u><font style="color:#0563C1;">5.1.1 发票归集</font></u>23

<u><font style="color:#0563C1;">5.1.2 发票查验</font></u>24

<u><font style="color:#0563C1;">5.1.3 抵扣勾选</font></u>24

<u><font style="color:#0563C1;">5.1.4 退税勾选</font></u>25

<u><font style="color:#0563C1;">5.1.5 代办退税勾选</font></u>25



<u><font style="color:#0563C1;">5.1.6 成品油消费税勾选</font></u>26

<u><font style="color:#0563C1;">5.1.7 农产品加计扣除勾选</font></u>27

<u><font style="color:#0563C1;">5.1.8 入账标识场景</font></u>28

<u><font style="color:#0563C1;">5. 2乐企沙箱控制服务文档</font></u>28

<u><font style="color:#0563C1;">5.2.1 用票数据初始化接口</font></u>28

<u><font style="color:#0563C1;">5.2.2 初始化数据增量归集触发接口</font></u>34

<u><font style="color:#0563C1;">5.2.3 税款所属期设置服务接口</font></u>35

<u><font style="color:#0563C1;">5.2.4 其他控制服务接口</font></u>36

















































































**第一章** **概述**

乐企沙箱是为乐企直连单位提供的仿真测试环境，支持能力订阅验收测试和系统联调测试两种 模式。新的乐企沙箱设计以支持直连单位在不同使用场景下的仿真测试为目标，涵盖单能力使用场 景和多能力关联的业务闭环使用场景。



本文档主要为企业提供用票能力的沙箱使用指引。









**第二章** **接入要求**

**2.** **1接入要求**

企业使用乐企沙箱，需要满足以下条件：

（1）直连单位需完成乐企直连单位接入，将系统的互联网出口IP 报税务机关备案，开通IP 白 名单。

（2）直连单位需完成乐企数字能力的订阅。

（3）直连单位需要获取自身及虚拟使用单位平台编号（乐企ID）。

（4）直连单位需要获取沙箱密钥用于报文请求加密。

（5）完成虚拟使用单位初始化。在沙箱环境， 一个直连单位默认分配一个虚拟使用单位，虚拟 使用单位无需订阅能力。企业可调用《虚拟单位企业数据查询》接口规范查询虚拟单位企业数据

,并保存到单位本地，完成虚拟单位信息初始化。

（6）完成用票数据初始化。直连单位通过开票能力开给虚拟使用单位，或者调用用票初始化接 口进行用票数据的初始化。









**第三章** **测试指引**

乐企沙箱基于场景化测试要求，为直连单位提供沙箱数字能力和沙箱控制服务。沙箱数字能力 用于企业做业务联调测试，和正式环境的实现逻辑一样，例如发票归集、增值税抵扣勾选等。沙箱 控制服务为企业提供修改返回结果和关联条件的功能，用于测试不同的业务场景，包括虚拟使用单 位信息调整、直连单位信息调整、用票数据初始化、初始化数据增量归集触发接口等功能。企业在 使用乐企沙箱服务时，要结合测试场景，需要初始化的，要先调用沙箱控制服务完成初始化，再按 照测试场景要求调用沙箱数字能力进行业务联调。

沙箱数字能力和正式环境数字能力的数据相互隔离，访问路径不同，使用报文加密密钥也不同 ,沙箱环境测试不会影响生产业务数据，但沙箱数字能力和正式环境数字能力的能力编码和接口编 码一样，在使用过程中要做好管理，避免混淆。

**3.** **1准备工作**

**3.** **1.** **1直连接入申请和网络白名单开通**

乐企直连单位登录省电子税务局，完成直连单位接入申请。在试点推广阶段，需要开通IP 白名 单后，才可以调用沙箱数字能力和沙箱控制服务，直连单位提交IP 备案表时，需要报备联调测试系 统的互联网出口IP。省局主管税务机关接入确认后，系统会自动为直连单位匹配一个用于沙箱测试



的虚拟使用单位。

**3.** **1.** **2能力订阅开通**

直连单位在接入申请后，选择需要开通的能力，申请订阅开通。发起订阅申请后，会在测试中 心自动生成能力测试任务。启动能力订阅验收测试。

**3.** **1.** **3获取直连单位平台编号**

乐企直连单位接入确认后，进入乐企平台【接入管理】模块，进入【接入申请】页面，会展示 企业相关信息。其中“乐企ID”就是沙箱测试以及能力调用时所需的“ptbh”。

![](https://cdn.nlark.com/yuque/0/2024/png/38481329/1733233458006-1b0fe7b5-99cd-461f-baaf-c0bd6f5b9818.png)



**3.** **1.** **4获取沙箱密钥**

直连单位进行沙箱测试时，需要使用【测试环境密钥】对请求报文做加密，对返回报文做解密 。企业通过【接入管理】-【秘钥管理】，获取【测试环境秘钥】。

![](https://cdn.nlark.com/yuque/0/2024/png/38481329/1733233458238-f6636f20-f4fe-42e2-ac20-727d0fa8f66b.png)



**3.** **1.** **5获取能力编码、接口编码和用例编码**

直连单位在访问沙箱环境，需要获取对应能力编码、接口编码和用例编码。

**能力编码**：能力是乐企平台提供某一具体业务的形式，某一具体能力由一个或多个相互关联的 服务（接口）和调用规则组成，能力编码是乐企平台对某一具体能力的唯一识别编号，可在能力订 阅请求页面和测试中心详情页查询。

**服务编码**：服务是构成乐企平台某一具体能力的接口，服务（接口）分为实时和异步，实时接 口可实时返回请求所需数据，异步接口返回流水号或批次流水号，可在处理完成后调用对应查询接 口获得所需数据，服务编码是乐企平台某一具体能力中的服务(接口)的唯一识别码，可在能力详情 页面和测试中心详情页查询。

**用例编码**：用例是乐企能力订阅沙箱测试的场景及要求描述，用例编码是乐企平台某一具体能 力用例的唯一识别码，可在测试中心详情页查询。用例编码在沙箱能力请求的报文头中，和沙箱环 境测试标识配套，两者互斥使用，用例编码仅在乐企沙箱订阅测试使用。

具体各个能力对应的能力编码、用票编码及服务编码详见5. 1章节

**3.** **1.** **6虚拟单位初始化**

直连单位通过调用“虚拟单位企业数据查询”接口，查询虚拟单位企业数据，并保存到单位本 地，完成虚拟单位信息初始化。

**3.** **2调用沙箱控制服务**

**3.** **2.** **1请求地址**

乐企平台沙箱控制服务接口服务请求地址（URL）：

[https://lqpt. chinatax. gov. cn:8443/access/sandbox_kzfw/v1/{](https://lqpt.%20chinatax.%20gov.%20cn:8443/access/sandbox_kzfw/v1/%7B)服务编码}，其中服务编码是某一具体控 制服务(接口)的唯一识别码。

沙箱控制服务（用票）的服务编码如下表所示：



| **序号** | **沙箱控制服务名称** | **服务编码** | **备注** |
| --- | --- | --- | --- |
|  | 用票数据初始化接口 | LQSX_SWZJ _GT4 _ SXFW_YPSJC SH |  |
|  | 初始化数据增量归集触发接 口 | LQSX_SWZJ _GT4 _ SXFW_CSHSJ ZLGJCF |  |
|  | 企业基础信息更新接口 | LQSX_ SWZJ _ GT4 _GXQYXX | 变更总分机构类型时调 用 |
|  | 虚拟单位企业数据查询接口 | LQS X_ SWZJ _ GT4 _ CXXNQYXX | 用于查询直连单位和虚 拟单位信息，若开票环 节 |
|  | 税款所属期设置服务接口 | LQSX_SWZJ _GT4 _ SXFW_ SZSKS SQ | 按需调用 |






**3.** **2.** **2请求报文**

**（1）请求报文头（header）**

沙箱控制服务请求报文头包含直连单位乐企ID、使用单位乐企ID和签名加密串，说明如下。



| **key** | **名称** | **说明** |
| --- | --- | --- |
| jrdwptbh | 直连单位平台ID | 直连单位平台ID |
| sydwptbh | 使用单位平台ID | 使用单位平台ID |
| access_signature | 签名加密串 | 暂不填写 |
| <br/><br/><font style="color:rgb(51, 51, 51);">clientTid</font> | <br/><br/><font style="color:rgb(51, 51, 51);">客户端交易ID</font> | **<font style="color:rgb(51, 51, 51);">非必录</font>**<font style="color:rgb(51, 51, 51);">，用于企业侧与乐企侧之间 的请求响应时长监测或其他业务跟 踪。</font><br/>**<font style="color:rgb(51, 51, 51);">特别注意</font>**<font style="color:rgb(51, 51, 51);">：建议使用UU ID或自有 业务系统会话ID，以减少重复概率</font><br/><font style="color:rgb(51, 51, 51);">。</font> |
| <br/><font style="color:rgb(51, 51, 51);">ptlx</font> | <br/><font style="color:rgb(51, 51, 51);">平台类型</font> | **<font style="color:rgb(51, 51, 51);">非必录</font>**<font style="color:rgb(51, 51, 51);">，当使用单位与直连单位关 系为不具有控制关系时且直连单位 接入类型为他用+联用时必录，用 于区分使用单位采用何种直连平台 接入类型进行能力服务调用</font> |






请求报头示例:



| {<br/>"jrdwptbh":"直连单位ID", "sydwptbh":"使用单位ID" } |
| --- |


**（2）请求报文体（body）**

报文体按照沙箱控制服务入参要求，传入JSON格式的报文。并且使用沙箱密钥对请求报文进行 SM4 加密。

请求报文体示例（用票数据初始化接口，未加密）:



| {<br/>"cshcjbm": "初始化场景编码" } |
| --- |


**3.** **2.** **3返回报文**

返回报文字段信息如下表所示：



| **<font style="color:rgb(51, 51, 51);">Key</font>** | **<font style="color:rgb(51, 51, 51);">名称</font>** | **<font style="color:rgb(51, 51, 51);">值</font>** | **<font style="color:rgb(51, 51, 51);">说明</font>** |
| --- | --- | --- | --- |
| <font style="color:rgb(51, 51, 51);">httpStatusCode</font> | 返回码 | 参数对照表 |  |
| body | 报文体 |  |  |
| |-<font style="color:rgb(51, 51, 51);">Response</font> | 响应体 |  |  |
| |-<font style="color:rgb(51, 51, 51);">RequestId</font> | 请求唯一码 |  |  |
| |-<font style="color:rgb(51, 51, 51);">Data</font> | 数据包 |  |  |






httpStatusCode（返回码）状态值如下表所示：



| **key** | **值** | **说明** |
| --- | --- | --- |
| <br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/>httpStatusCode | <font style="color:rgb(51, 51, 51);">200</font> | <font style="color:rgb(51, 51, 51);">成功</font> |
| | <font style="color:rgb(51, 51, 51);">500</font> | <font style="color:rgb(51, 51, 51);">请求云服务集成平台异常|服务接入异常，请联系管理员</font> |
| | <font style="color:rgb(51, 51, 51);">5001</font> | <font style="color:rgb(51, 51, 51);">云服务集成平台响应异常</font> |
| | <font style="color:rgb(51, 51, 51);">40322</font> | <font style="color:rgb(51, 51, 51);">直连单位无资格</font> |
| | <font style="color:rgb(51, 51, 51);">40321</font> | <font style="color:rgb(51, 51, 51);">使用单位无资格</font> |
| | <font style="color:rgb(51, 51, 51);">4055</font> | <font style="color:rgb(51, 51, 51);">通过平台序号未查询到此使用单位信息</font> |
| | <font style="color:rgb(51, 51, 51);">4054</font> | <font style="color:rgb(51, 51, 51);">通过平台序号未查询到此直连单位信息</font> |
| | <font style="color:rgb(51, 51, 51);">4047</font> | <font style="color:rgb(51, 51, 51);">未查询到该单位的测试批次号</font> |
| | <font style="color:rgb(51, 51, 51);">4049</font> | <font style="color:rgb(51, 51, 51);">未查询到该能力与对应服务的相关信息</font> |
| | <font style="color:rgb(51, 51, 51);">4032</font> | <font style="color:rgb(51, 51, 51);">使用单位无授权服务</font> |
| | <font style="color:rgb(51, 51, 51);">4033</font> | <font style="color:rgb(51, 51, 51);">使用单位未授权此服务</font> |
| | <font style="color:rgb(51, 51, 51);">4056</font> | <font style="color:rgb(51, 51, 51);">云服务APP 未找到</font> |
| | <font style="color:rgb(51, 51, 51);">4057</font> | <font style="color:rgb(51, 51, 51);">报文解密失败</font> |
| | <font style="color:rgb(51, 51, 51);">-1</font> | <font style="color:rgb(51, 51, 51);">未知错误</font> |






报文返回的body 报文体内容已加密，以乐企沙箱控制服务用票数据初始化为例，请求成功返回 报文如下所示：



| {<br/>"httpStatusCode": 200, "body":<br/>"{\"Response\":{\"RequestId\":\"0379d75e317315c2\",\"Data\":\"gP1yg+YEloUeFjx /o8VDEQmsQmod1O+/mNEvVj CYfupeMeE+VRu1GSr7Gxhi7hZcq42BUF/hWjMt  Gb8hVMiGW/SiW/ay0vXQD7Be+EmF/vLDG9Ukgli84Chimhc3yi0pv7EXPUwHmSs foIPrm5WP+etnlx3uYnkCx5SDyDR3fBt6rnTkifv2Wa0TOYGOKmnRequ1Po3IwbO4 |
| --- |






| CKCyPzIOCX2BSRocyO205JHNEiI/Ic8kuF6rRytjwvoDjw0wefDeNT4dHD0F3QlbcX FGoSwZqc lney6QEV7FkUZi z/vIQRfV0KjvniyGeg/EdH6U6Fk5MJm4ojmRwi8M/k3  V/d3q5Uvp+/J+yMl ELyMHpa2PONOfRDdHJhGpS3a437FBLU3MRH57+Ws dqT09  nslxJpzXTlBlgM3UsABySt50tNuUr3zy7as317g4ndlze1n+GGx8EvSV6flldI2cv3fIVa1A0 UwtZgU/cnhrN0WdAEKNSSb1obxgJNzQJJRGkqu6a6qfLXf7ge6uw2Nd7z0yfdF9P9jn DBOenAGhtOPLB3U7xH+rpv4vqrj+BS6SqRqMMYv2\"}}"<br/>} |
| --- |






解密后报文示例如下：



| {<br/>"Response":{<br/>"RequestId":"xxxx", "Data":{<br/>"returncode":"00",<br/>"returnmessage": "成功"<br/>} } } |
| --- |






**3.** **3调用沙箱数字服务**

访问沙箱数字能力和访问生产环境数字能力一样，数字能力的入参、处理逻辑和返回报文可以 参考能力说明文档。

**3.** **3.** **1请求地址**

以下是乐企平台沙箱接口服务请求地址（URL）：

[https://lqpt. chinatax. gov. cn:8443/access/sandbox/v2/invoke/{](https://lqpt.chinatax.gov.cn:8443/access/sandbox/v2/invoke/{) 能力编码}/{ 服务编码}/能力编码和服务 编码的定义详见3. 1. 5 获取能力编码、接口编码和用例编码章节

**3.** **3.** **2请求报文**

沙箱数字能力访问的报文头要区分能力订阅验收测试请求和系统联调测试需求。两者仅通过报 文头区分，报文体内容一致，参考能力说明文档。

**（1）能力订阅验收测试请求**

直连单位在首次订阅开通能力时，需要完成能力订阅沙箱测试，可前往测试中心模块查看测试



指引与测试用例，通过测试中心启动测试后，需要在限定时间（72小时）内完成指定测试任务，测 试任务通过后生成测试报告，提交税务部门确认通过后，才能完成能力订阅开通。能力订阅验收测 试需要在报文通中传入对应的用例编码。



| **key** | **名称** | **说明** |
| --- | --- | --- |
| <font style="color:rgb(51, 51, 51);">jrdwptbh</font> | <font style="color:rgb(51, 51, 51);">直连单位平台ID</font> | <font style="color:rgb(51, 51, 51);">直连单位乐企ID</font> |
| <font style="color:rgb(51, 51, 51);">sydwptbh</font> | <font style="color:rgb(51, 51, 51);">使用单位平台ID</font> | <font style="color:rgb(51, 51, 51);">使用单位乐企ID</font> |
| <font style="color:rgb(51, 51, 51);">ylbm</font> | <font style="color:rgb(51, 51, 51);">用例编码</font> | <font style="color:rgb(51, 51, 51);">能力订阅验收测试任务重对应的测试用例编码</font> |
| <font style="color:rgb(51, 51, 51);">sxcsbz</font> | <font style="color:rgb(51, 51, 51);">沙箱测试标志</font> | <font style="color:rgb(51, 51, 51);">能力订阅验收测试模式下，该字段为空</font> |
| <font style="color:rgb(51, 51, 51);">access_signature</font> | <font style="color:rgb(51, 51, 51);">签名加密串</font> | <font style="color:rgb(51, 51, 51);">暂不填写</font> |
| <br/><font style="color:rgb(51, 51, 51);">clientTid</font> | <br/><font style="color:rgb(51, 51, 51);">客户端交易ID</font> | **<font style="color:rgb(51, 51, 51);">非必录</font>**<font style="color:rgb(51, 51, 51);">，用于企业侧与乐企侧之间的请求响应时长 监测或其他业务跟踪。</font><br/>**<font style="color:rgb(51, 51, 51);">特别注意</font>**<font style="color:rgb(51, 51, 51);"> ：建议使用UU ID或自有业务系统会话 ID，以减少重复概率。</font> |
| <br/><font style="color:rgb(51, 51, 51);">ptlx</font> | <br/><font style="color:rgb(51, 51, 51);">平台类型</font> | **<font style="color:rgb(51, 51, 51);">非必录</font>**<font style="color:rgb(51, 51, 51);">，当使用单位与直连单位关系为不具有控制 关系时且直连单位接入类型为他用+联用时必录 ,用于区分使用单位采用何种直连平台接入类型进 行能力服务调用</font> |








**（2）系统联调测试**

直连单位在订阅开通能力后，在日常业务联调测试中，可以通过系统联调测试进行业务联调。 在不同测试场景中，要配合沙箱控制服务进行使用。在沙箱数字能力调用的请求报文头中进行设置

。



| **key** | **名称** | **说明** |
| --- | --- | --- |
| <font style="color:rgb(51, 51, 51);">jrdwptbh</font> | <font style="color:rgb(51, 51, 51);">直连单位平台ID</font> | <font style="color:rgb(51, 51, 51);">直连单位乐企ID</font> |
| <font style="color:rgb(51, 51, 51);">sydwptbh</font> | <font style="color:rgb(51, 51, 51);">使用单位平台ID</font> | <font style="color:rgb(51, 51, 51);">使用单位乐企ID</font> |
| <font style="color:rgb(51, 51, 51);">ylbm</font> | <font style="color:rgb(51, 51, 51);">用例编码</font> | <font style="color:rgb(51, 51, 51);">系统联调测试模式下，用例编码为空</font> |
| <font style="color:rgb(51, 51, 51);">sxcsbz</font> | <font style="color:rgb(51, 51, 51);">沙箱测试标志</font> | <font style="color:rgb(51, 51, 51);">能力订阅验收测试模式下，该字段为“1”</font> |
| <font style="color:rgb(51, 51, 51);">access_signature</font> | <font style="color:rgb(51, 51, 51);">签名加密串</font> | <font style="color:rgb(51, 51, 51);">暂不填写</font> |








**3.** **3.** **3返回报文**

详见能力文档。









**第四章** **测试场景**



测试场景描述乐直连单位在不同业务场景下，调用沙箱数字能力和沙箱控制服务接口的测试建 议。

**4.** **1发票归集** **前置条件：**

已通过开票能力开具了相关发票，或已完成用票数据初始化。

**正常业务场景：**

（1）从已开票数据或用票数据初始化返回的发票明细信息中，确认符合归集能力相关接口的数据范 围；

（2）按照发票归集能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【批量发票下载申请】、【批量海关缴款书下载申请】、【取得批量数字化电子发票

（xml）文件申请下载】、【批量增值税代扣代缴完税凭证下载申请】等接口上传请求到乐企平台

,获取本次上传请求对应的批次流水号；

（4）传入上一步请求返回的批次流水号调用【批量发票下载申请反馈】、【取得数字化电子发票文 件申请结果反馈】、【批量海关缴款书下载申请反馈】、【批量增值税代扣代缴完税凭证下载申请   反馈】等获取结果类接口，查询具体的处理结果；

（5）其他相关接口按照接口规范调用。

**异常业务场景：**

（1）调用【批量发票下载申请】、【发票风险信息查询】、【发票用途状态信息查询】、【取得批 量数字化电子发票（xml）文件申请下载】等查询类接口时，传入非法参数：

传入的日期传入为空或者非日期格式的数据；

传入参数涉及发票类型、数据类型等的，传入为空或者非支持范围内的值； 传入的纳税人识别号传入为空或者非直连单位、虚拟单位税号；

传入涉及发票号码的，传入发票号码为空 上述情况可任选其一来测试。

（2）调用【批量发票下载申请反馈】、【取得数字化电子发票文件申请结果反馈】、【批量消费税 代扣代缴完税凭证下载申请反馈】、【批量海关缴款书下载申请反馈】、【批量增值税代扣代缴完   税凭证下载申请反馈】等获取结果类接口时，传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。

**4.** **2发票查验** **前置条件：**



已通过开票能力开具了相关发票，或已完成用票数据初始化。

**正常业务场景：**

（1）从已开票数据或用票数据初始化返回的发票明细信息中，选择待查验发票信息；

（2）按照发票查验能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【发票查验（单张发票实时查询下载接口）】上传发票查验查询请求到乐企平台，并对接 口实时返回的票面信息进行解析及其他相关处理。

**异常业务场景：**

传入的发票类型为空，或非支持范围内的值如90,99等 传入的发票号码、发票号码同时为空；

传入的开票日期为空或者非标准日期格式；

纳税人识别号传入非直连单位、虚拟单位税号；

正常业务场景中已查验成功的传入参数，修改其中的发票号码、发票类型、开票日期等参数为 其他值；

上述情况可任选其一来测试。

**4.** **3抵扣勾选场景** **前置条件：**

企业已通过发票归集能力归集到本企业的进项数据（发票、海关缴款书、代扣代缴完税凭证等 ),或已通过调用未勾选数据初始化相关接口已获取可勾选但未勾选数据清单。

**普通业务场景（非总机构汇总勾选确认场景）：**

（1）从可勾选但未勾选数据清单中选择用于抵扣勾选申请清单信息（非异常状态且未勾选的抵扣凭 证）；

（2）按照增值税抵扣勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【获取当前税款所属期与当期税款所属期统计状态】，进行税款所属期初始化；

（4）调用抵扣凭证勾选申请上传接口（【批量发票抵扣勾选】、【批量海关缴款书抵扣勾选】、【 批量上传增值税代扣代缴完税凭证抵扣勾选】），上传抵扣勾选申请到乐企平台，获取本次上传请

求对应的批次流水号；

（5）传入上一步请求返回的批次流水号调用抵扣凭证勾选申请处理结果查询接口（【查询发票抵扣 勾选处理结果】、【查询海关缴款书抵扣勾选处理结果】、【查询增值税代扣代缴完税凭证抵扣勾   选处理结果】）查询具体的处理结果；

<font style="color:#FF0000;">申请/撤销抵扣统计、申请确认抵扣统计接口，如果涉及农产品加计扣除勾选的，可在做完农产品加 计扣除勾选相关接口测试后一并调用。</font>

（6）调用【申请/撤销抵扣统计】接口，上传申请抵扣统计/撤销抵扣统计的请求到乐企平台，获取



本次上传请求对应的批次流水号；

（7）传入上一步请求返回的批次流水号调用【查询申请撤销统计处理结果】接口查询对应的处理结 果

（8）调用【申请确认抵扣统计】接口，上传申请确认抵扣统计的请求到乐企平台，获取本次上传请 求对应的批次流水号；

（9）传入上一步请求返回的批次流水号调用【查询确认统计处理结果】接口查询统计确认结果。

（10）调用【获取当前税款所属期发票抵扣勾选处理结果】、【获取当前税款所属期海关缴款书抵 扣勾选处理结果】、【获取当前税款所属期代扣代缴完税凭证抵扣勾选处理结果】接口获取已勾选

在当前税款所属期的票据清单。

**总分机构汇总勾选确认场景：**

（1）调用控制服务接口【企业基础信息更新接口】，将本企业设置为总机构，将虚拟单位设置为分 支机构；

（2）总机构企业调用【汇总纳税人机构列表查询】接口，查询本企业分支结构列表信息；

（3）按总、分支机构身份分别调用【获取当前税款所属期与当期税款所属期统计状态】，进行税款 所属期初始化；

（4）总机构调用【总分机构汇总勾选确认】接口，设置由总机构来汇总勾选确认所有总、分支机构 发票的标志；

（5）从可勾选但未勾选数据清单中选择用于抵扣勾选申请清单信息（非异常状态且未勾选的抵扣凭 证）；

（6）按照增值税抵扣勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（7）总、分支机构分别调用抵扣凭证勾选申请上传接口（发票、海关缴款书、代扣代缴完税凭证 ),上传抵扣勾选申请到乐企平台，并获取本次上传请求对应的批次流水号；

（8）总、分支机构分别调用抵扣凭证勾选申请处理结果查询接口（发票、海关缴款书、代扣代缴完 税凭证），传入批次流水号查询具体的处理结果；

（9）总机构调用【申请/撤销抵扣统计】、【查询申请撤销统计处理结果】来实现抵扣统计，

（10）总机构调用【申请确认抵扣统计】、【查询确认统计处理结果】接口实现统计确认。

**异常业务场景：**

（1）调用【批量发票抵扣勾选】、【批量海关缴款书抵扣勾选】、【批量上传增值税代扣代缴完税 凭证抵扣勾选】等接口时，传入非法参数：

传入参数的购方识别号为非直连单位税号和虚拟单位税号； 传入的勾选类型为非01、02、03、04的；

传入的申请勾选明细数据超过2000条；

传入的申请明细数据中的开票日期传入为空或者非日期格式的数据；



上述情况可任选其一来测试。

（2）调用【查询发票抵扣勾选处理结果】、【查询海关缴款书抵扣勾选处理结果】、【查询增值税 代扣代缴完税凭证抵扣勾选处理结果】等接口时，传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统自行随机生成的批次流水号； 上述情况可任选其一来测试。

**特殊说明：**

（1）《申请税款所属期变更》接口可实现将税款所属期回退到上一属期或将税款所属期切换到下一 属期的功能。

（2）调用《申请税款所属期变更》进行税款所属期回退或税款所属期切换时需逐月调用进行变更 ,不可跨月调用。

（3）为方便在沙箱环境下进行测试，税款所属期切换到下一属期的功能对按月、按季申报企业均开 放，实际生产环境下，该功能仅对按季申报企业开放（在当前税款所属期为非03,06,09,12时对按季企

业开放）。

（4）纳税人调用税款所属期回退到目标属期后，在完成目标属期的相关业务后（已完成统计确认 ),可调用税款所属期切换到下一属期。







**4.4** **退税勾选场景** **前置条件：**

企业已通过发票归集能力归集到本企业的进项数据（发票、海关缴款书等），或已通过调用未 勾选数据初始化相关接口已获取可勾选但未勾选的数据清单。

**正常业务流程：**

（1）从可勾选但未勾选数据清单中选择用于退税勾选申请清单信息（非异常状态且未勾选的税控专 票、数电专票）；

（2）按照增值税退税勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【批量发票退税勾选确认】、【批量海关缴款书退税勾选确认】接口，上传退税勾选申请 到乐企平台，并获取本次上传请求对应的批次流水号；

（4）调用【查询发票退税勾选确认处理结果】、【查询海关缴款书退税勾选确认处理结果】接口 ,传入上一步请求返回的批次流水号查询退税勾选处理结果。

**异常业务流程：**

（1）调用【批量发票退税勾选确认】、【批量海关缴款书退税勾选确认】接口时，传入非法参数： 传入参数的购方识别号为非直连单位税号和虚拟单位税号；



传入的申请勾选明细数据超过2000条；

传入的申请明细数据中的开票日期/填发日期传入为空或者非日期格式的数据； 上述情况可任选其一来测试。

（2）调用【查询发票退税勾选确认处理结果】、【查询海关缴款书退税勾选确认处理结果】接口时 ,传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。

**4.5** **代办退税勾选场景** **前置条件：**

企业已通过发票归集能力归集到本企业的发票进项数据，或已通过调用未勾选数据初始化相关 接口已获取可勾选但未勾选的数据清单。

**正常业务流程：**

（1）从可勾选但未勾选数据清单中选择用于代办退税勾选申请清单信息（非异常状态且未勾选的税 控专票、数电专票）；

（2）按照代办退税勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【批量发票代办退税勾选】接口，上传代办退税勾选申请到乐企平台，获取本次上传请求 对应的批次流水号；

（4）传入上一步请求返回的批次流水号调用【查询发票代办退税勾选处理结果】接口，查询代办退 税勾选处理结果。

**异常业务流程：**

（1）调用【批量发票代办退税勾选】接口时，传入非法参数： 传入参数的购方识别号为非直连单位税号和虚拟单位税号； 传入的申请勾选明细数据超过2000条；

传入的申请明细数据中的开票日期传入为空或者非日期格式的数据； 上述情况可任选其一来测试。

（2）调用【查询发票代办退税勾选处理结果】接口时，传入非法批次流水号： 传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。



**4.6** **成品油消费税勾选场景** **前置条件：**

企业已通过发票归集能力归集到本企业的进项数据（发票、海关缴款书、代扣代缴完税凭证 ),或已通过调用未勾选数据初始化相关接口已获取可勾选但未勾选数据清单。

**生产企业测试场景：**

（1）调用【获取当前税款所属期与当期税款所属期统计状态（成品油）】接口，获取本企业的当前 税款所属期；

（2）从可勾选但未勾选数据清单中选择用于成品油扣除勾选申请清单信息（非异常状态且未勾选的 凭证）；

（3）按照成品油消费税勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（4）调用【批量上传发票勾选清单（勾选、撤销）】、【批量上传海关缴款书勾选清单（勾选、撤 销）】、【批量上传代扣代缴完税凭证勾选清单（勾选、撤销）】接口，上传勾选请求到乐企平台

,获取本次上传请求对应的批次流水号；

（5）传入上一步获取到的批次流水号调用【查询发票勾选处理结果信息】、【查询海关缴款书勾选 处理结果（成品油）】、【查询代扣代缴完税凭证勾选处理结果】接口，查询勾选处理结果信息；

（6）调用【上传统计请求（成品油）】接口上传申请统计请求到乐企平台，实时接收统计结果；

（7）调用【申请确认统计（成品油）】接口上传确认统计请求到乐企平台，实时接收确认统计结果 ;

（8）调用【获取当前税款所属期发票勾选处理结果】、【获取当前税款所属期海关缴款书勾选处理 结果】、【获取当前税款所属期代扣代缴完税凭证勾选处理结果】获取勾选在当前税款所属期的票

据清单。

**经销企业测试场景：**

（1）从可勾选但未勾选数据清单中选择用于成品油库存勾选申请清单信息（非异常状态且未勾选的 凭证）

（2）按照成品油消费税勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【批量上传发票勾选清单（经销）】、【批量上传海关缴款书勾选清单（经销）】接口 ,上传成品油库存勾选请求到乐企平台，获取本次上传请求对应的批次流水号；

（4）传入上一步获取到的批次流水号调用【查询发票勾选上传处理结果（经销）】、【查询海关缴 款书勾选处理结果（经销）】接口，查询库存勾选处理结果信息。

**异常业务场景：**

（1）调用【批量上传发票勾选清单（勾选、撤销）】、【批量上传海关缴款书勾选清单（勾选、撤 销）】、【批量上传代扣代缴完税凭证勾选清单（勾选、撤销）】、【批量上传发票勾选清单（经   销）】、【批量上传海关缴款书勾选清单（经销）】接口时，传入非法参数：

传入的申请明细数据中的开票日期/填发日期传入为空或者非日期格式的数据；



传入参数涉及发票类型的传入为空或传入非支持范围内的值； 传入的申请勾选类型为空或为非支持范围内的值；

上述情况可任选其一来测试。

（2）调用【查询发票勾选处理结果信息】、【查询海关缴款书勾选处理结果（成品油）】、【查询 代扣代缴完税凭证勾选处理结果】、【查询发票勾选上传处理结果（经销）】、【查询海关缴款书  勾选处理结果（经销）】接口时，传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。





**4.7** **农产品加计扣除勾选场景** **前置条件：**

企业已通过发票归集能力归集到本企业的进项数据（农产品的发票、海关缴款书等），或已通 过调用未勾选数据初始化相关接口已获取可勾选但未勾选数据清单。

**正常业务场景：**

（1）从待确认农产品发票确认清单中选择用于待处理农产品发票确认清单信息；

（2）按照农产品加计扣除勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（3）调用【批量上传待处理农产品发票确认清单】接口，上传待处理农产品发票确认请求到乐企平 台，获取本次上传请求对应的批次流水号；

（4）传入上一步请求中获取到的批次流水号调用【查询批量上传待处理农产品发票确认清单处理结 果】接口，获取对应的处理结果；

（5）从可勾选但未勾选数据清单中选择用于农产品加计扣除勾选申请清单信息（非异常状态且未勾 选的抵扣凭证）；

（6）按照农产品加计扣除勾选能力说明文档相关接口的具体要求组装合法的请求报文；

（7）调用【获取当前税款所属期与当期税款所属期统计状态】，查询当前税款所属期及统计状态。 ;

（8）调用【批量上传农产品发票加计扣除勾选清单】、【批量上传农产品海关缴款书加计扣除勾选 清单】接口，上传农产品加计扣除勾选请求到乐企平台，获取本次上传请求对应的批次流水号；

（9）传入上一步请求中获取到的批次流水号调用【查询农产品发票加计扣除勾选处理结果】、【查 询农产品海关缴款书加计扣除勾选处理结果】接口，获取对应的处理结果；

<font style="color:#FF0000;">【申请统计/撤销统计】、【申请确认抵扣】及对应的查询接口，可在完成农产品加计扣除勾选后 ,   一并参考在抵扣勾选能力中的相关接口调用。</font>



（10）调用【获取当前税款所属期农产品发票加计扣除勾选处理结果】、【获取当前税款所属期农 产品海关缴款书加计扣除勾选处理结果】接口，查询当前税款所属期已勾选农产品加计扣除用途的 清单信息。







**异常业务场景：**

（1）调用【批量上传待处理农产品发票确认清单】、【批量上传农产品发票加计扣除勾选清单】、 【批量上传农产品海关缴款书加计扣除补录信息】、【批量上传农产品海关缴款书加计扣除勾选清  单】、【批量上传税务机关代开农产品发票补录信息】接口时，传入非法参数：

传入参数的购方识别号为非直连单位税号和虚拟单位税号； 传入的申请勾选明细数据超过2000条；

传入的申请明细数据中的开票日期/填发日期传入为空或者非日期格式的数据；

传入参数涉及勾选类型、发票类型的，传入为空或者非支持范围内的值； 上述情况可任选其一来测试。

（2）调用【查询农产品发票加计扣除勾选处理结果】、【查询农产品海关缴款书加计扣除勾选处理 结果】、【查询批量上传待处理农产品发票确认清单处理结果】、【查询批量上传农产品海关缴款   书加计扣除补录信息处理结果】、【查询批量上传税务机关代开农产品发票补录信息处理结果】接   口时，传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。





**4.** **8入账标识场景** **前置条件：**

已通过开票能力开具了相关发票，或已完成用票数据初始化。

**正常业务流程：**

（1）从已开票数据或用票初始化返回数据清单中选取待入账数据清单；

（2）按照发票入账能力说明文档相关接口的具体要求组织请求报文；

（3）调用【批量上传入账发票】、【批量上传入账海关缴款书】、【批量上传增值税入账代扣代缴 完税凭证】接口，上传入账标识请求到乐企平台，获取本次上传请求对应的批次流水号；

（4）传入上一步请求返回的批次流水号调用【查询发票入账处理结果】、【查询增值税代扣代缴完 税凭证入账处理结果】、【查询海关缴款书入账处理结果】接口，查询入账标识处理结果。

**异常业务流程：**



（1）调用【批量上传入账发票】、【批量上传入账海关缴款书】、【批量上传增值税入账代扣代缴 完税凭证】接口时，传入非法参数：

传入的申请明细数据中的开票日期/填发日期传入为空或者非日期格式的数据； 传入参数涉及发票类型的传入为空或传入非支持范围内的值；

传入的申请勾选类型为空或为非支持范围内的值； 上述情况可任选其一来测试。

（2）调用【查询发票入账处理结果】、【查询增值税代扣代缴完税凭证入账处理结果】、【查询海 关缴款书入账处理结果】接口时，传入非法批次流水号：

传入的批次流水号为空；

传入企业侧系统随机自行生成的批次流水号； 上述情况可任选其一来测试。







**第五章** **附录**

**5.** **1乐企数字化电子发票用票能力相关编码**

**5.1.1** **发票归集**

能力编码（nlbm）：203067 用例编码（ylbm）：203067

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 批量发票下载申请 | PLFPXZSQ |
|  | 批量发票下载申请反馈 | PLFPXZSQFK |
|  | 查询增量下载发票信息 | CXZLXZFPXX |
|  | 发票风险信息查询 | FPTSTXXXCX |
|  | 发票状态信息查询 | FPZTXXCX |
|  | 取得数字化电子发票(xml)文件申请下载 | FPWJSQXZ |
|  | 取得数字化电子发票文件申请结果反馈 | FPWJSQJGFK |
|  | 批量出口转内销发票信息查询 | PLCKZNXFPXXCX |
|  | 批量出口转内销海关缴款书信息查询 | PLCKZNXHGJKS XXCX |
|  | 查询增量下载增值税代扣代缴完税凭证信息 | CXZLXZZZSDKDJWSPZXX |
|  | 批量增值税代扣代缴完税凭证下载申请反馈 | PLZZSDKDJWSPZXZSQFK |






|  | 批量海关缴款书下载申请 | PLHGJKSXZSQ |
| --- | --- | --- |
|  | 查询增量下载消费税代扣代缴完税凭证信息 | CXZLXZXFSDKDJWSPZXX |
|  | 查询增量下载海关缴款书信息 | CXZLXZHGJKS XX |
|  | 批量消费税代扣代缴完税凭证下载申请 | PLXFSDKDJWSPZXZSQ |
|  | 批量消费税代扣代缴完税凭证下载申请反馈 | PLXFSDKDJWSPZXZSQFK |
|  | 批量增值税代扣代缴完税凭证下载申请 | PLZZSDKDJWSPZXZSQ |
|  | 批量海关缴款书下载申请反馈 | PLHGJKSXZSQFK |






**5.1.2** **发票查验**

能力编码（nlbm）：203059 用例编码（ylbm）：203059

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 发票查验（单张发票实时查询下载接口） | FPCY_ NEW |






**5.1.3** **抵扣勾选**

能力编码（nlbm）：203065 用例编码（ylbm）：203065

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 获取当前税款所属期与当期税款所属期统计状 态 | HQDQS KS SQYDQS KS SQTJ ZT |
|  | 批量发票抵扣勾选 | PLFPDKGX |
|  | 查询发票抵扣勾选处理结果 | CXFPDKGXCLJG |
|  | 批量海关缴款书抵扣勾选 | PLHGJKSDKGX |
|  | 查询海关缴款书抵扣勾选处理结果 | CXHGJKSDKGXCLJG |
|  | 申请撤销抵扣统计 | SQCXDKTJ |
|  | 查询申请撤销统计处理结果 | CXTJCLJG |
|  | 申请确认抵扣统计 | S QQRDKTJ |
|  | 查询确认统计处理结果 | CXQRTJCLJG |
|  | 获取当前税款所属期发票抵扣勾选处理结果 | HQDQS KS SQFPDKGXCLJG |
|  | 获取当前税款所属期海关缴款书抵扣勾选处理 结果 | HQDQS KS SQHGJKSDKGXCLJG |
|  | 查询增值税代扣代缴完税凭证抵扣勾选处理结 | CXZZSDKDJWSPZDKGXCLJG |






|  | 果 |  |
| --- | --- | --- |
|  | 批量上传增值税代扣代缴完税凭证抵扣勾选 | PLSCZZSDKDJWSPZDKGX |
|  | 获取当前税款所属期代扣代缴完税凭证抵扣勾 选处理结果 | HQDQS KS SQDKDJ WSPZDKGXCLJ G |
|  | 未勾选数据初始化清单下载申请（抵扣勾选） | WGXS JCS HQDXZS QDKGX |
|  | 未勾选数据初始化清单下载申请反馈（抵扣勾 选） | WGXS JCS HQDXZSQFKDKGX |
|  | 汇总纳税人机构列表查询 | HZNS RJGLBCX |
|  | 申请税款所属期变更 | SQSKS SQBG |
|  | 申请注销勾选 | SQZXGX |
|  | 总分机构汇总勾选确认 | ZFJ GHZGXQR |
|  | 批量上传待处理农产品发票确认清单 | PLS CDCLNCPFPQRQD |
|  | 查询批量上传待处理农产品发票确认清单处理 结果 | CXPLS CDCLNCPFPQRQDCLJG |
|  | 批量上传税务机关代开农产品发票补录信息 | PLSCSWJGDKNCPFPBLXX |
|  | 查询批量上传税务机关代开农产品发票补录信 息处理结果 | CXPLSCSWJGDKNCPFPBLXXCLJG |
|  | 查询发票农产品商品编码列表 | CXFPNCPSPBMLB |






**5.1.4** **退税勾选**

能力编码（nlbm）：203064 用例编码（ylbm）：203064

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 批量发票退税勾选确认 | PLFPTSGXQR |
|  | 查询发票退税勾选确认处理结果 | CXFPTSGXQRCLJG |
|  | 批量海关缴款书退税勾选确认 | PLHGJKSTSGXQR |
|  | 查询海关缴款书退税勾选确认处理结果 | CXHGJKSTS GXQRCLJG |
|  | 未勾选数据初始化清单下载申请（退税勾选） | WGXS JCS HQDXZSQTSGX |
|  | 未勾选数据初始化清单下载申请反馈（退税勾 选） | WGXS JCS HQDXZSQFKTSGX |






**5.1.5** **代办退税勾选**

能力编码（nlbm）：203066



用例编码（ylbm）：203066



| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 查询发票代办退税勾选处理结果 | CXDBTS GX |
|  | 批量发票代办退税勾选 | PLFPDBGX |
|  | 未勾选数据初始化清单下载申请（代办退税勾 选） | WGXS JCS HQDXZSQFKDBTSGX |
|  | 未勾选数据初始化清单下载申请反馈（代办退 税勾选） | WGXS JCS HQDXZS QDBTS GX |






**5.1.6** **成品油消费税勾选**

能力编码（nlbm）：203105 用例编码（ylbm）：203105

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 获取当前税款所属期与当期税款所属期统计状态 （成品油） | HQDQS KS SQYDQS KS SQTJ ZTCP Y |
|  | 批量上传发票勾选清单（勾选、撤销） | PLS CFPGXQDGXCX |
|  | 查询发票勾选处理结果信息 | CXFPGXCLJGXX |
|  | 批量上传海关缴款书勾选清单（勾选、撤销） | PLSCHGJKSGXQD |
|  | 查询海关缴款书勾选处理结果（成品油） | CXHGJKSGXCLJG |
|  | 批量上传代扣代缴完税凭证勾选清单（勾选、撤 销） | PLSCDKDJWSPZGXQD |
|  | 查询代扣代缴完税凭证勾选处理结果 | CXDKDJWSPZGXCLJG |
|  | 批量上传发票勾选清单（经销） | PLSCFPGXQDJX |
|  | 查询发票勾选上传处理结果（经销） | CXFPGXCLJGXJX |
|  | 批量上传海关缴款书勾选清单（经销） | PLSCHGJKSGXQDJX |
|  | 查询海关缴款书勾选处理结果（经销） | CXHGJKSGXCLJGJX |
|  | 上传统计请求（成品油） | SCTJQQCPY |
|  | 申请确认统计（成品油） | SQQRTJCPY |
|  | 申请税款所属期回退 | SQSKS SQHT |
|  | 获取当前税款所属期发票勾选处理结果 | HQDQS KS SQFPGXCLJG |
|  | 获取当前税款所属期海关缴款书勾选处理结果 | HQDQS KS SQHGJKSGXCLJG |
|  | 获取当前税款所属期代扣代缴完税凭证勾选处理 结果 | HQDQS KS SQDKDJWSPZGXCLJ G |
|  | 未勾选数据初始化清单下载申请（成品油） | WGXS JCS HQDXZSQFKCPY |






|  | 未勾选数据初始化清单下载申请反馈（成品油） | WGXS JCS HQDXZSQFKCPY |
| --- | --- | --- |






**5.1.7** **农产品加计扣除勾选**

能力编码（nlbm）：203108

用例编码（ylbm）：230407001



| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |
|  | 查询发票农产品商品编码列表 | CXFPNCPSPBMLB |
|  | 查询海关缴款书农产品海关税号列表 | CXHGJKSNCPHGSHLB |
|  | 获取当前税款所属期与当期税款所属期统计状态 | HQDQS KS SQYDQS KS SQTJ ZT |
|  | 批量上传农产品发票加计扣除勾选清单 | PLSCNCPFPJJKCGXQD |
|  | 查询农产品发票加计扣除勾选处理结果 | CXNCPFPJJKCGXCLJG |
|  | 批量上传农产品海关缴款书加计扣除勾选清单 | PLSCNCPHGJKSJJKCGXQD |
|  | 查询农产品海关缴款书加计扣除勾选处理结果 | CXNCPHGJKSJJKCGXCLJG |
|  | 批量上传待处理农产品发票确认清单 | PLS CDCLNCPFPQRQD |
|  | 查询批量上传待处理农产品发票确认清单处理结 果 | CXPLS CDCLNCPFPQRQDCLJG |
|  | 批量上传农产品海关缴款书加计扣除补录信息 | PLSCNCPHGJKSJJKCBLXX |
|  | 查询批量上传农产品海关缴款书加计扣除补录信 息处理结果 | CXPLSCNCPHGJKSJJKCBLXXCLJ G |
|  | 批量上传税务机关代开农产品发票补录信息 | PLSCSWJGDKNCPFPBLXX |
|  | 查询批量上传税务机关代开农产品发票补录信息 处理结果 | CXPLSCSWJGDKNCPFPBLXXCLJ G |
|  | 获取当前税款所属期农产品发票加计扣除勾选处 理结果 | HQDQSKS SQNCPFPJJKCGXCLJG |
|  | 获取当前税款所属期农产品海关缴款书加计扣除 勾选处理结果 | HQDQS KS SQNCPHGJ KS JJ KCGX CLJG |
|  | 未勾选数据初始化清单下载申请反馈（农产品） | WGXS JCS HQDXZSQFKNCP |
|  | 未勾选数据初始化清单下载申请（农产品） | WGXS JCS HQDXZSQNCP |






**5.1.8** **入账标识场景**

能力编码（nlbm）：203057 用例编码（ylbm）：203057

| **序号** | **服务名称（fwmc）** | **服务编码（fwbm）** |
| --- | --- | --- |






|  |  | PLSCRZFP |
| --- | --- | --- |
|  | 查询发票入账处理结果 | CXFPRZCLJG |
|  | 批量上传入账海关缴款书 | PLSCRZHGJKS |
|  | 查询海关缴款书入账处理结果 | CXHGJKSRZCLJG |
|  | 批量上传增值税入账代扣代缴完税凭证 | PLSCRZDKDJWSPZ |
|  | 查询增值税代扣代缴完税凭证入账处理结果 | CXDKDJWSPZRZCLJG |






**5.** **2乐企沙箱控制服务文档**

**5.2.1** **用票数据初始化接口**

接口描述：根据传入的纳税人识别号+初始化场景编码进行数据的初始化，初始化数据的购方 信息为虚拟单位信息，销方信息为直连单位信息（税务机关代开发票除外）。

接口编码：LQSX_SWZJ _GT4 _SXFW_YPSJCSH

数据格式：json 请求方式：post 传入参数body：

| **序号** | **数据项标识** | **数据项名称** | **字段类型** | **长度** | **必须** | **说明** |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | cshcjbm | 初始化场景编码 | varchar | 6 | 是 | 数据初始化场景编码 |


初始化场景编码说明如下：



| **场景编码** | **场景名称** | **包含票证类型** | **支撑业务类型** | **备注** |
| --- | --- | --- | --- | --- |
| <br/><br/><br/>CSH001 | <br/><br/>通用业务<br/>全票面信息 | 税控发票 | <br/><br/>发票归集、发票查 验、抵扣勾选、退 税勾选 | <br/><br/>不含农产品、成品油 发票 |
| | | 数电发票 | | |
| | | 海关缴款书 | | |
| | | 增值税代扣代缴完 税凭证 | | |
| <br/>CSH002 | 出口转内销业务 （出口退税企业 调用，其他企业 无需调用） | 税控发票 | <br/>发票归集、抵扣/不 抵扣勾选 | 税控、数电的专用发 票，已确认为退税的 凭证 |
| | | 数电发票 | | |
| | | 海关缴款书 | | |
| <br/>CSH003 | <br/>农产品业务 | 税控发票 | 发票归集、发票查 验、抵扣/不抵扣勾 选、农产品加计扣 除勾选 | 特定要素类型为农产 品，或者货物含农产 品的混开发票 |
| | | 数电发票 | | |
| | | 海关缴款书 | | |
| CSH004 | 成品油业务 | 税控发票 | 发票归集、发票查 | 特定要素类型为成品 |






|  | （成品油经销企 业、成品油生产 企业调用，非成 品油企业无需调 用） | 数电发票 | 验、抵扣/不抵扣勾 选、退税勾选，成 品油库存勾选、生 产企业扣除勾选 | <br/><br/>油 |
| --- | --- | --- | --- | --- |
| | | 海关缴款书 | | |
| | | 消费税代扣代缴完 税凭证 | 发票归集、生产企 业扣除勾选 | |
| <br/>CSH005 | 税务机关代开发 票（农产品深加 工企业调用，其 他企业无需调用 ) | 税控发票 | 发票归集、发票查 验、农产品加计扣 除勾选（税务机关 代开农产品发票补 录） | 符合业务规则的发票 销方税号含有DK |
| | | 数电发票 | | |
| CSH006 | 异常数据 | 税控发票 | 涵盖可勾选未勾选 、可勾选已勾选、 不可勾选等范围 | 异常发票阻断勾选 已勾选的阻断统计 |
| | | 数电发票 | | |
| <br/>CSH007 | 代办退税（出口 退税外贸综合服 务企业调用，其 他企业无需调用 ) | 税控发票 | <br/>发票归集、发票查 验、代办退税勾选 | 专票、电子专票 |
| | | 数电发票 | | 专票 |
| <br/><font style="color:rgb(255, 0, 0);">CSH008</font> | <font style="color:rgb(255, 0, 0);">开具给自然人的 发票</font> | <font style="color:rgb(255, 0, 0);">数电发票（普通发 票）</font> | <font style="color:rgb(255, 0, 0);">发票归集、发票查 验</font> | <font style="color:rgb(255, 0, 0);">购销方非本单位，且 为开具给自然人的发 票，模拟自然人推送 给本单位的业务场景</font> |








接口返回参数：



| **序号** | **数据项标识** | **数据项名称** | **字段类型** | **长度** | **必须** | **说明** |  |
| --- | --- | --- | --- | --- | --- | --- | --- |
|  | returncode | 返回码 | varchar | 2 | 是 | 00：成功<br/>99：失败 |  |
|  | returnmsg | 返回信息 | varchar | 2000 | 否 | 错误信息说明 |  |
| 初始化成功时返回（发票）fplist | | | | | | |  |
|  | fphm | 发票号码 | varchar | 20 | 是 |  |  |
|  | zzfpDm | 纸质发票代码 | varchar | 12 | 否 | 数电电票时，此字段 为空 | 可 |
|  | zzfphm | 纸质发票号码 | varchar | 8 | 否 | 数电电票时，此字段 为空 | 可 |
|  | ckznxzmbh | 出口转内销证明编号 | varchar | 50 | 否 | CSH002时不为空 |  |
|  | xfsbh | 销方识别号 | varchar | 30 | 是 |  |  |
|  | fplx | 发票类型 | varchar | 2 | 是 | 详见附表1 |  |
|  | kprq | 开票日期 | varchar | 8 | 是 | YYYYMMDD |  |
|  | je | 金额 | DECIMAL | 18,2 | 否 | CSH002、CSH006时可 空 |  |
|  | se | 税额 | DECIMAL | 18,2 | 否 | CSH002、CSH006时可 空 |  |






|  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- |
|  | jshj | 价税合计 | DECIMAL | 18,2 | 否 | CSH002、CSH006时可 空 |  |
|  | yzm | 验证码 | varchar | 20 | 否 | CSH002、CSH006时可 空 |  |
|  | <br/><br/><br/><br/>fpzt | <br/><br/><br/><br/>发票状态 | <br/><br/><br/><br/>varchar | <br/><br/><br/><br/>1 | <br/><br/><br/><br/>否 | 0正常<br/>1失控<br/>2作废<br/>3已红冲<br/>7部分红冲 8全额红冲 |  |
|  | <br/>sfycpz | <br/>是否异常凭证 | <br/>varchar | <br/>2 | <br/>否 | 01正常<br/>02异常凭证<br/>03疑似异常凭证 |  |
| 初始化成功时返回（海关缴款书）hgjkslist | | | | | | |  |
|  | hgjkshm | 海关缴款书号码 | varchar | 75 | 是 |  |  |
|  | ckznxzmbh | 出口转内销证明编号 | varchar | 50 | 否 | CSH002时不为空 |  |
|  | tfrq | 填发日期 | varchar | 8 | 是 | YYYYMMDD |  |
|  | skje | 税款金额 | DECIMAL | 18,2 | 是 |  |  |
| 初始化成功时返回（代扣代缴完税凭证）dkdjlist | | | | | | |  |
|  | dkdjwspzh | 代扣代缴完税凭证号 | VARCHAR | 20 | 是 |  |  |
|  | tfrq | 填发日期 | VARCHAR | 8 | 是 | YYYYMMDD |  |
|  | kjywrsbh | 扣缴义务人识别号 | VARCHAR | 30 | 是 |  |  |
|  | bkjnsrsbh | 被扣缴纳税人识别号 | VARCHAR | 30 | 是 |  |  |
|  | sjje | 实缴金额 | DECIMAL | 18,2 | 是 |  |  |






请求业务报文样例：



| {<br/>"cshcjbm": "初始化场景编码" } |
| --- |








返回业务报文样例：



| 请求成功报文样例：<br/><font style="color:#FF0000;">{</font><br/><font style="color:#FF0000;">"Response":{</font><br/><font style="color:#FF0000;">"RequestId":"系统自动生成ID", "Data":{</font><br/><font style="color:#FF0000;">"returncode":"00",       "returnmsg":"成功"， "fplsit":[</font><br/><font style="color:#FF0000;">{</font><br/><font style="color:#FF0000;">"fphm": "23442000000001790001",</font><br/><font style="color:#FF0000;">"zzfpDm": "",</font><br/><font style="color:#FF0000;">"zzfphm": "",</font><br/><font style="color:#FF0000;">"ckznxzmbh": "",</font><br/><font style="color:#FF0000;">"xfsbh":  "XXXXXXXXXXXXX", "fplx": "81",</font><br/><font style="color:#FF0000;">"kprq": "20230701",</font><br/><font style="color:#FF0000;">"je": "100. 00", "se": "3. 00",    "jshj": "103",   "yzm": "",</font><br/><font style="color:#FF0000;">"fpzt": "0",</font><br/><font style="color:#FF0000;">"sfycpz": "01" },{</font><br/><font style="color:#FF0000;">"fphm": "",</font><br/><font style="color:#FF0000;">"zzfpDm": "4400212130", "zzfphm": "01009402",</font><br/><font style="color:#FF0000;">"ckznxzmbh": "",</font><br/><font style="color:#FF0000;">"xfsbh":  "XXXXXXXX", "fplx": "01",</font> |
| --- |






| <font style="color:#FF0000;">"kprq": "20230630",</font><br/><font style="color:#FF0000;">"je": "100. 00", "se": "9. 00",</font><br/><font style="color:#FF0000;">"jshj": "109. 00", "yzm": "",</font><br/><font style="color:#FF0000;">"fpzt": "0",</font><br/><font style="color:#FF0000;">"sfycpz": "01"</font><br/><br/><br/><font style="color:#FF0000;">}  ],</font><br/><font style="color:#FF0000;">"hgjkslsit":[ {</font><br/><font style="color:#FF0000;">"hgjkshm": "150020191001939236-L02",</font><br/><font style="color:#FF0000;">"ckznxzmbh": "",   "tfrq": "20230630", "skje": "10000. 09"  },{</font><br/><font style="color:#FF0000;">"hgjkshm": "150020231001930036-L02",</font><br/><font style="color:#FF0000;">"ckznxzmbh": "",   "tfrq": "20230701", "skje": "300. 00"</font><br/><font style="color:#FF0000;">}  ],</font><br/><font style="color:#FF0000;">"dkdjlsit":[ {</font><br/><font style="color:#FF0000;">"dkdjwspzh": "331016230300605406",</font><br/><font style="color:#FF0000;">"tfrq": "20230630",</font><br/><font style="color:#FF0000;">"kjywrsbh":  "XXXXXXXXX",    "bkjnsrsbh":  "XXXXXXXXXX",</font> |
| --- |






| <font style="color:#FF0000;">"sjje": "2999. 09" },{</font><br/><font style="color:#FF0000;">"dkdjwspzh": "331016230300605499", "tfrq": "20230701",</font><br/><font style="color:#FF0000;">"kjywrsbh":  "XXXXXXXXX",    "bkjnsrsbh":  "XXXXXXXXXX", "sjje": "87623. 88"</font><br/><font style="color:#FF0000;">} ] } } }</font> |
| --- |










**5.2.2** **初始化数据增量归集触发接口**

接口描述：根据纳税人的请求触发初始化数据的增量归集，触发成功后纳税人可通过增量发票 归集接口下载初始化数据明细。

接口编码：LQSX_SWZJ_GT4 _SXFW_CSHSJZLGJCF

数据格式：json 请求方式：post 接口返回参数：



| **序号** | **数据项标识** | **数据项名称** | **字段类型** | **长度** | **必须** | **说明** |
| --- | --- | --- | --- | --- | --- | --- |
|  | returncode | 返回码 | varchar | 2 | 是 | 00：成功<br/>99：失败 |
|  | returnmsg | 返回信息 | varchar | 2000 | 否 | 错误信息说明 |






请求业务报文样例：



|  |
| --- |






| {} |
| --- |








返回业务报文样例：



| 请求成功报文样例： {<br/>"Response":{<br/>"RequestId":"系统自动生成ID",<br/>"Data":{<br/>"returncode":"00",    "returnmsg":"成功"<br/>} } } |
| --- |






**5.2.3** **税款所属期设置服务接口**

接口路径：

host:/sandbox_kzfw/v1/LQSX_SWZJ _GT4 _SXFW_SZSKSSQ 请求方式：POST

数据格式：JSON

接口说明：根据纳税人的请求信息，将纳税人当前的有效的税款所属期设置为请求对应的目标 税款所属期（税款所属期最晚可设置为当前自然月）

纳税人识别号从报文头获取 传入参数body：

| **序号** | **数据项标识** | **数据项名称** | **字段类型** | **长度** | **必须** | **说明** |
| --- | --- | --- | --- | --- | --- | --- |
| 1 | skssq | 税款所属期 | varchar | 6 | 是 | YYYYMM<br/>目标税款所属期 |
| 2 | sqbz | 申请标志 | varchar | 1 | 是 | 1增值税 |






|  |  |  |  |  |  | 2消费税 |
| --- | --- | --- | --- | --- | --- | --- |








接口返回参数：



| **序号** | **数据项标识** | **数据项名称** | **字段类型** | **长度** | **必须** | **说明** |
| --- | --- | --- | --- | --- | --- | --- |
|  | returncode | 返回码 | varchar | 2 | 是 | 00：成功<br/>99：失败 |
|  | returnmsg | 返回信息 | varchar | 2000 | 否 | 错误信息说明 |






请求业务报文样例：



| {<br/>"skssq": "税款所属期"， "sqbz": "申请标志"<br/>} |
| --- |








返回业务报文样例：



| 请求成功报文样例： {<br/>"Response":{<br/>"RequestId":"系统自动生成ID",<br/>"Data":{<br/>"returncode":"00",    "returnmsg":"成功"<br/>} } } |
| --- |


**5.2.4** **其他控制服务接口**

调用企业基础信息更新接口（LQS X_ SWZJ _ GT4 _ GXQYXX）、虚拟单位企业数据查询接口



（LQS X_ SWZJ _ GT4 _CXXNQYXX）按需调用接口，具体接口报文规范参照沙箱开票部分操作指引相 关章节内容。

