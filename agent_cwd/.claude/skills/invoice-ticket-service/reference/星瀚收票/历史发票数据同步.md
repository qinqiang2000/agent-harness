文档适用范围：星空旗舰版开票

# 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1.0 | 2025.11.04 |  | 初稿发布 |  |




# 历史发票数据同步操作路径及所属模块编码
操作路径：【发票服务】→【开票管理】→【销项全票池】→【历史发票数据同步】

所属模块编码：<font style="color:rgb(0, 0, 0);">F17029</font>

所属模块名称：<font style="color:rgb(0, 0, 0);">历史发票导入</font>

# 历史发票数据同步功能设计理念概述
## 用户痛点
1. 数据迁移工作量大

    某新客户以前使用其他系统开具发票，后续切换为发票云开具发票，在其他平台开具的发票需迁移至发票云，便于查看等动作，但由于发票量巨大，纳税主体多，导致数据迁移工作复杂。

2. 金四红冲需原蓝票信息

    金税四期进行发票红冲规则较金税三期变化较大，例如发票红冲必须原始蓝票信息，因此申请红冲时，原蓝票必须在发票云存在。

金四数电红冲规则：[https://jdpiaozone.yuque.com/nbklz3/dn5ehb/edhu9lhwt2kq46sv?singleDoc#](https://jdpiaozone.yuque.com/nbklz3/dn5ehb/edhu9lhwt2kq46sv?singleDoc#) 《数电票红冲》

## 特性亮点
1. 多方式导入历史数据

（1）税局下载：支持通过乐企、rpa通道，直接从税局获取发票结构化数据、发票用途信息

（2）导入电子税局文件：支持通过直接导入从电子税局导出的文件，无需转换模板，导入时发票云自动解析数据后导入。导入发票结构化数据，不支持导入发票用途信息

以上数据导入完成后，统一写入销项发票池。

2. 支持获取多种数据

（1）可获取发票结构化数据，包括购销方信息、发票明细、备注等信息

（2）可获取发票用途信息，包括增值税用途状态、消费税用途状态、入账状态

3. 年度、月度数据获取

（1）年度数据获取：支持长跨度、大批量年度数据下载，方便完成数据整体迁移，一次操作、批量下载

（2）月度数据获取：支持每月短期下载，方便每月完成数据获取，无需操作，自动下载

## 常用场景
1. 新客户迁移历史数据：新客户以前使用其他平台开具发票，后升级发票云开具，需要将历史数据迁移至发票云进行管理，便于查看、红冲等操作。
2. 在用客户日常同步多渠道销方数据：已经在使用发票云的客户，其他业务正在使用其他平台开具发票，不使用发票云，需要将发票统一下载至发票云中。
3. 红冲时发票用途状态查看：企业业务要求需红冲已抵扣、或已入账的发票，因此红冲前需要查看发票增值税用途状态、入账状态。同时针对每月开出的发票，持续更新该状态。

# 历史发票数据同步功能详解
## 历史发票数据同步单据提交操作说明
### 历史发票数据同步单据提交关键字段说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">字段名称*</font>** | **<font style="color:rgb(26, 26, 26);">业务含义*</font>** | **<font style="color:rgb(26, 26, 26);">字段规则*</font>** | **<font style="color:rgb(26, 26, 26);">其他属性说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 导入批次号 | 导入发票数据时的批次号 | 标注导入任务的唯一性，导入时系统自动生成，由时间戳、随机码组成 |  |
| 2 | 销方名称 | 导入发票所属销方名称 | 创建导入任务，进行导入时，按照税号拆分导入任务；例如导入时，选择了下载2个税号的发票数据，将生成两条导入任务。 |  |
| 3 | 销方税号 | 导入发票所属销方税号 | 创建导入任务，进行导入时，按照税号拆分导入任务 |  |
| 4 | 发票种类 | 导入的发票种类 | 导入的发票种类，一个任务可包含多个发票种类 |  |
| 5 | 执行状态 | 标记执行任务的状态 | 执行状态包括：<br/>1. 待同步：等待执行<br/>2. 数据预处理中：直接导入电子税局文件时，需要先解析导入的数据，解析过程的状态为数据预处理中。通过税局下载发票，无需经过本状态。<br/>3. 同步中：正在执行任务<br/>4. 部分执行成功：本条任务的子任务中，存在部分成功的任务。<br/>5. 全部执行成功：本条任务的子任务中，所有子任务执行成功。<br/>6. 全部执行失败：本条任务的子任务中，所有子任务执行失败。 |  |
| 6 | 导入方式 | 该任务导入发票的方式 | 包括税局下载、导入电子税局文件 |  |
| 7 | 下载通道 | 该任务获取发票的通道 | 当导入方式为税局下载时，区分获取发票的通道，包括rpa、乐企两种通道。<br/>使用乐企测试下载时，请使用乐企沙箱税号下载。 |  |
| 8 | 总份数 | 本任务获取的发票总数 | 本次任务获取的总份数 |  |
| 9 | 成功份数 | 本次任务导入成功的份数 | 本次任务导入成功的份数 |  |
| 10 | 创建人 | 创建导入任务的操作人 | 创建导入任务的操作人 |  |
| 11 | 创建时间 | 创建导入任务的时间 | 创建导入任务的时间 |  |
| 12 | 组织 | 创建任务的组织 | 创建导入任务的组织名称 |  |


### 历史发票数据同步单据提交按钮说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">按钮名称*</font>** | **<font style="color:rgb(26, 26, 26);">功能描述*</font>** | **<font style="color:rgb(26, 26, 26);">使用条件</font>** | **<font style="color:rgb(26, 26, 26);">其他说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 导入 | 创建导入任务 | 点击后打开弹窗，填写发票数据类型、导入方式等信息后，可创建导入任务。生成任务时，选择多个企业名称时，按照企业名称拆分任务。 |  |
| 2 | 终止 | 终止导入任务 | 选择导入任务，可强制终止选中的任务中未执行和执行中的任务。 |  |
| 3 | 重试 | 重试导入任务 | 选择导入任务，可将选中的任务中执行失败的记录，重新执行。 |  |
| 4 | 自动更新 | 自动更新 | 点击后，可创建每月自动下载发票数据和自动下载发票用途状态的任务，任务默认为全局共享。 |  |


### 历史发票数据同步单据提交主要操作说明
#### 发票结构化数据获取
支持通过税局下载或者导入电子税局文件的方式，将发票导入到销项发票池。

##### 税局下载发票结构化数据
###### 历史大批量数据下载
1. 点击【导入】按钮，打开弹窗，填写需要获取的发票内容，填写内容可创建下载任务，下载任务按照企业拆分。

（1）发票数据类型：包括发票数据（发票结构化数据）、发票用途状态（发票增值税用途状态、入账状态、消费税用途状态）

（2）导入方式：税局下载、导入电子税局文件

（3）下载通道：选择税局下载时展示，可以选择使用rpa或者乐企的方式进行下载。

   ① 选择rpa下载时，使用默认电子税局账号下载，请先配置电子税局账号。

   ② 选择乐企下载时，**必须开通乐企归集能力，并在发票云基础资料->企业管理-> 企业信息中，收票通道配置为乐企平台。**并且乐企每月、每天都有下载次数限制，详细内容如下：

+ **乐企可下载的销项发票数据为企业授权进/销任意一种乐企能力后所开具的发票（含所有开具渠道）。**
+ 针对同一开票月份、同一发票类型的销项发票每天申请次数超过 1 次。如：6 月 10 日需要申请下载开票月份 6 月份的增值税专用发票，只能申请一次；
+ 针对当前开票月份、同一发票类型的销项发票每月申请次数超过 5 次。如：6 月份需要申请下载开票月份 6 月份的增值税专用发票，最多只能申请 5 次；
+ 针对同一历史开票月份、同一发票类型的销项发票每月申请次数超过 3次。如： 6 月份需要申请下载 5 月份的增值税专用发票，只能申请三次；
+ 可下载的销项发票数据仅包括企业授权任意一种乐企能力后所开具的发票（含所有开具渠道）。

（4）企业名称：可选择登录用户具备权限的税号，可多选。

（5）开票日期：可选择下载近五年的发票，支持按年下载，按月下载。

（6）发票种类：可下载电子普通发票、电子专用发票、纸质普通发票、纸质专用发票、数电票（普通发票）、数电票（增值税专用发票）。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1735036180909-5d31ea2e-aae7-4efa-807d-5e93085d6ad8.png)

弹窗中点击确定，生成导入任务。任务按月拆分为子任务，点击导入批次号，可以查看导入详情。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1725605739908-2b9cf06d-ef29-417b-9c31-93ab525acf3d.png)

 点击导入批次号，可以查看子任务的导入详情。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1725607075717-882db429-5820-462f-ab1e-a25f6f6dd122.png)



****用户通过乐企或者RPA下载的**蓝票（仅适用于蓝票）**，税局发票数据出现返回错误的情况时，产品默认会自动过滤商品名称为原价合计、折扣额合计和详见销货清单的明细行。

可过滤的文字内容支持在开发平台配置，当发票明细商品名称与配置的文字全匹配时，发票下载保存数据时，不包含该行。

**支持过滤的下载范围：**发票同步、历史发票同步、进项下载、Excel导入、税局文件导入、公有云同步时。

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1747019966121-74472f38-cf4e-49b4-b485-20bd6741461b.png)

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1747019989064-a4d478e3-a029-482e-bd32-f8264e2635fc.png)

**开发平台配置路径：**

进入开发平台-发票云-系统管理-云应用参数配置-参数配置单据，或直接搜索参数配置单据，预览列表。

![](https://cdn.nlark.com/yuque/0/2021/png/22572071/1639448621203-04a7a92b-1b5d-4646-8285-2825e320a022.png)

进入列表后，搜索配置项：<font style="color:rgb(0, 0, 0);">errorGoodsNames，修改配置项的值。注意：需要添加多个配置项的值时，配置项之间用英文逗号隔开。</font>

<font style="color:rgb(0, 0, 0);">配置项类型：errorGoodsNames</font>

<font style="color:rgb(0, 0, 0);">配置项KEY：</font><font style="color:rgb(0, 0, 0);">errorGoodsNames</font>

<font style="color:rgb(0, 0, 0);">配置项值：默认值为：详见销货清单,原价合计,折扣额合计。可根据实际业务需要自行调整。</font>

![](https://cdn.nlark.com/yuque/0/2025/png/38481329/1753242147400-8f07894d-88df-4990-8740-5e34a9644df5.png)



###### 每月定时更新
创建每月自动更新任务有两种方式，以下两种方式都是在自动化设置中创建对应任务，只是入口不同。

方式1、在基础资料→开票参数设置→自动化设置中，创建自动任务，操作方式见自动化设置文档章节3.3部分。[https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl](https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl)

方式2、在历史发票数据同步页面创建，以下为在本页面创建任务的操作方式。

步骤一：点击【自动更新】按钮，打开弹窗，询问是否需要生成自动更新任务。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726020484507-dcaf796c-7148-4a83-a6fa-3bf1fffbac20.png)

勾选发票明细信息更新，点击确定，将在自动化设置创建任务，每月五号自动更新上月数据，默认任务为本组织私有。

##### 电子税局文件导入发票结构化数据
点击页面【导入】按钮，打开弹窗，选择导入电子税局文件。选择企业

（1）发票数据类型：包括发票数据（发票结构化数据）、发票用途状态（发票增值税用途状态、入账状态、消费税用途状态）

（2）导入方式：税局下载、导入电子税局文件

（3）企业名称：可选择登录用户具备权限的税号，当导入方式为导入电子税局文件时，仅支持选择一个税号。

（4）文件导入：从电子税局导出的文件，通过弹窗上传，最大可上传10M的文件。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1725622558203-6859786f-a1af-4f85-8566-7db200a8eb9d.png)

弹窗中点击【确定】，生成任务。每个任务按顺序执行，导入发票结构化数据。

#### 发票用途状态获取
1、仅正数发票支持查询发票用途状态。

2、发票用途状态获取后，自动更新销项发票池的增值税用途状态、消费税用途状态、入账状态。

###### 历史大批量数据下载
1、点击【导入】按钮，打开弹窗，勾选发用途状态，填写内容可创建下载任务。

（1）下载通道：支持乐企、rpa。

  ① 选择rpa下载时，使用默认电子税局账号下载，请先配置电子税局账号。

  ② 选择乐企下载时，**必须开通乐企归集能力，并在发票云基础资料->企业管理-> 企业信息中，收票通道配置为乐企平台。**

（2）企业名称：可选择登录用户具备权限的税号，可多选。多选后，按税号拆分任务。

（3）开票日期：可选择下载近五年的发票，可多选。

（4）发票种类：可下载电子普通发票、电子专用发票、纸质普通发票、纸质专用发票、数电票（普通发票）、数电票（增值税专用发票）。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726021906839-6f45317f-6ad8-4631-b81d-3390c1d8ec38.png)

###### 每月定时更新
创建每月自动更新任务有两种方式，以下两种方式都是在自动化设置中创建对应任务，只是入口不同。

方式1、在基础资料→开票参数设置→自动化设置中，创建自动任务，操作方式见自动化设置文档章节3.3部分。[https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl](https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl)

方式2、在历史发票数据同步页面创建，以下为在本页面创建任务的操作方式。

步骤一：点击【自动更新】按钮，打开弹窗，询问是否需要生成自动更新任务。

![](https://cdn.nlark.com/yuque/0/2024/png/12881570/1726020484507-dcaf796c-7148-4a83-a6fa-3bf1fffbac20.png)

勾选发票明细信息更新，点击确定，将在自动化设置创建任务，每月五号自动更新上月数据，默认任务为本组织私有。

（以上两种方式，对应的调度任务编码为： sim_his_inv_data_import_task_SKDP_S、历史发票数据导入定时计划）

# 历史发票数据同步相关配置说明
1. 历史数据更新：如使用乐企获取发票信息，需要在**发票云基础资料->企业管理-> 企业信息中，收票通道配置为乐企平台。**
2. 每月定时更新：在基础资料→开票参数设置→自动化设置中，创建自动任务，操作方式见自动化设置文档章节3.3部分。[https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl](https://jdpiaozone.yuque.com/nbklz3/tadboa/yv17ymt8xd59envl)

# 历史发票数据同步相关接口说明
| 编号 | 接口名称 | 接口用途 | 接口链接 |
| --- | --- | --- | --- |
| 1 | 2.1.14 入账状态查询（暂只支持乐企） | 查询发票入账状态、增值税用途状态、消费税用途状态 | [https://piaozone-ultimate.apifox.cn/api-169226962](https://piaozone-ultimate.apifox.cn/api-169226962) |
|  |  |  |  |




