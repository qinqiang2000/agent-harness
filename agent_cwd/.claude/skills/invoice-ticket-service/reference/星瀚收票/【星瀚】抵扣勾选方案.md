| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-11-13** | **支三垒** |


# 方案说明
本文档旨在方便各异构的系统与金蝶发票云系统功能结合，使对接上游系统可以快速、高效的完成收票系统异构对接，以适应该税改政策，完成全电发票的开具。如有异议请予指正。

# 适用场景说明
**场景说明 ：**

1. 如客户想对进项收到的增值税抵扣勾选功能支持用户直连税局对进项纸质专用发票、电子专用发票、数电票（增值税专用发票）、数电票（航空运输电子客票行程单）、数电票（铁路电子客票）、机动车销售发票、通行费电子发票、纸质普通发票、电子普通发票、数电票（普通发票）（注：普通发票为农产品类型）、数电发票（机动车销售统一发票）进行抵扣勾选及撤销勾选操作； 
2. 通过发票云定时任务将进项全票池相关发票抵扣勾选操作；



**补充说明：**

1. 可以调用旗舰版发票云预勾选接口，预勾选确认，预勾选确认结果查询；或发票勾选,发票勾选结果查询;将需要抵扣勾选的进项发票的发票数据同步给税局，后调用勾选结果查询接口查询税局抵扣勾选的结果；
2. <font style="color:rgb(0,0,0);">通过定时任务对进项采集到的发票做自动入账设置，可以以数据来源，和绑定发票的单据类型，以及发票种类等维度进行发票自动入账的定时任务设置。从而实现发票的自动入账操作；</font>

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300127187-a7755f50-bca8-43c2-b735-4aaca3a0d1d8.png)

## 业务流程图
![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300194263-bf61d4b1-5a98-487b-87c9-49a580324321.png)

## 流程说明
**<font style="color:rgb(0,0,0);">业务说明：</font>**

员工的费用报销，差旅报销-客户付费、差旅报销-非客户付费、对供应商付款，项目采购与服务分包付款等

**<font style="color:rgb(0,0,0);"></font>**

**<font style="color:rgb(0,0,0);">异构对接说明：</font>**

1. 异构系统查询查询发票云全票池数据用于抵扣的发票数据的筛选，（发票云全票池数据为税局下载同步或进项采集）；
2. 对想要勾选税号查询税款所属期信息,对根据业务需要对需要勾选进行发票的所属期和可抵扣的期限进行处理筛选后进行抵扣操作；
3. 异构系统调用发票云抵抗勾选接口接口对进项采集到的纸质专用发票、电子专用发票、数电票（增值税专用发票）、数电票（航空运输电子客票行程单）、数电票（铁路电子客票）、机动车销售发票、通行费电子发票、纸质普通发票、电子普通发票、数电票（普通发票）（注：普通发票为农产品类型）、数电发票（机动车销售统一发票）进行抵抗勾选申请请求，发票云再对数据进行处理后请求电子税局勾选抵扣；
4. 异构系统调用发票勾选结果查询接口对勾选抵扣的结果进行查询发票云再请求电子税局获取到抵扣勾选结果，其中返回内容有勾选成功和勾选失票信息；
5. 异构调用发票云当前统计接口，返回统计所属期，税款所属期，可抵扣期限，更新时间，统计表状态及统计的发票类型，抵扣份数抵扣金额，不抵扣份数，不抵扣金额等；
6. 根据查询到的统计表信息，异构系统再进行调用发票云接口生成统计表，发票云再请求电子税局生成统计表；
7. 异构系统根据返回的任务号对生成的统计表信息进行查询；
8. 对查询后的统计表信息进行进一步确认，如果信息无误异构系统调用调用发票云确认统计表接口对统计表信息确认；
9. 根据返回的任务号对确认后的统计表结果进行查询再次核对统计表信息；
10. 如果有税期需要变更，异构系统调用发票云变更税款所属期接口进行税期变更，变更后再次查询税款所属期流程如上所属；

# 接口执行顺序
## 授权接口
+ 接口名字：1.01.获取app_token
+ 接口地址：[https://open.piaozone.com/api-145421044](https://open.piaozone.com/api-145421044)

```json
{
"appId": "CASHINV",
"appSecuret": "12345678",
"tenantid": "devbiz",
"accountId": "1534920374578620490",
"language": "zh_CN"
}
```

```json
{
"data": {
"app_token": "12324eroeutrekdfgfkdkkk",
"success": true,
"error_desc": "",
"expire_time": 1535675659434,
"error_code": "0"
},
"state": "success"
} 
```

+ 接口名字：1.02获取access_token
+ 接口地址：[<font style="color:rgb(0,0,255);">https://open.piaozone.com/api-145421045</font>](https://open.piaozone.com/api-145421045)

```json
{
"user": "13825207590",
"apptoken": "a3270799-b482-4697-931f-2fb68b56bdf2",
"tenantid": "devbiz ",
"accountId": "1534920374578620490",
"usertype": "Mobile"
}
```

```json
{
"data": {
"access_token": "f035550a-f9e8-4cc6-a775-8a21462a9f8b",
"success": true,
"error_desc": "",
"expire_time": 1535680289307,
"error_code": "0"
},
"state": "success"
}
```

### 授权信息获取与初始化说明
**8.0路径****<font style="color:#117CEE;">：【开放服务云】→【OpenApi】→【安全策略】→【第三方应用】  </font>**

首次对接可根据对接系统不同创建不同的应用id

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764320001907-82d27039-a226-47ca-8601-701a93b8aef7.png?x-oss-process=image%2Fformat%2Cwebp)

<font style="background-color:rgb(255,255,255);">Appid与appSecuret为个性化设置</font>

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300339801-2480e582-5f93-478a-897b-d4ff30087ade.png)

点击获取获取Token示例

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300352174-0a87754f-7fa1-4621-b6b4-e36a675fca59.png)

只需替换appSecret与apptoken即可调通获取当前登录系统用户的授权接口

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300364460-531e611b-afde-4bf0-830d-1d1392c65937.png)

### 常见授权接口异常
#### 异常类型1：数据中心accountId参数错误
+ **错误原因**<font style="background-color:rgb(255,255,255);">：accountId参数与数据中心配置不匹配</font>
+ **排查方法**<font style="background-color:rgb(255,255,255);">：检查accountId是否为数据中心分配的正确账号ID</font>
+ **解决措施**<font style="background-color:rgb(255,255,255);">：从数据中心管理界面获取正确的accountId参数</font>

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300381311-8ae9ec1c-3e89-408d-b8a2-c7cf7ef2d709.png)

#### <font style="background-color:rgb(255,255,255);">秘钥不对appsecuret参数不对</font>
+ **错误原因**：应用ID或密钥不正确
+ **排查方法**：检查第三方应用配置中的appid和appsecuret是否正确
+ **解决措施**：重新生成并更新正确的appid和appsecuret参数

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1764300390513-22079e36-9c7c-4556-82a7-4488bea7c3bd.png)

## 税局登录接口
+ 接口名字：4.02 税局登录接口
+ 接口地址：https://open-ultimate.piaozone.com/api-145421060

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "taxLogin",
"requestId": "1624601109096",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDU5MTg3MjEzM0IiCiB9"
}
```

```json
{
"data": "eyJsb2dpblR5cGUiOiIxIn0=",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 调用获取税款所属期信息
+ 接口名字：4.04 获取税款所属期信息
+ 接口地址：https://open-ultimate.piaozone.com/api-145421063

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "taxperiodQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDc0NTE5NDc3ODIiCn0="
}
```

```json
{
"message": "税号:914403007451947782,不在租户:5368720388 范围内",
"errorCode": "1130",
"status": false,
"success": false
}
```

## 发票勾选&撤销勾选 
+ 接口名字：4.05 发票勾选&撤销勾选
+ 接口地址：https://open-ultimate.piaozone.com/api-145421064

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceSelect",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJiaWxsVHlwZSI6ICIwIiwKICAgICAgICAiYXV0aGVudGljYXRlRmxhZyI6IDAsCiAgICAgICAgImRlZHVjdGlvblB1cnBvc2UiOiAiMSIsCiAgICAgICAgImFzeW5jRmxhZyI6ICIxIiwKICAgICAgICAiaW52b2ljZXMiOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJzYWxlck5hbWUiOiAiIiwKICAgICAgICAgICAgICAgICJzYWxlclRheE5vIjogIiIsCiAgICAgICAgICAgICAgICAiaW52b2ljZVR5cGUiOiAiNCwyNywyOCwyOSIsCiAgICAgICAgICAgICAgICAiaW52b2ljZUNvZGUiOiAiIiwKICAgICAgICAgICAgICAgICJpbnZvaWNlTm8iOiAiMjM0NDIwMDAwMDAxNjQyMTQzMzUiLAogICAgICAgICAgICAgICAgImV0YXhJbnZvaWNlTm8iOiAiIiwKICAgICAgICAgICAgICAgICJpbnZvaWNlRGF0ZSI6ICIyMDIzLTA4LTE2IiwKICAgICAgICAgICAgICAgICJpbnZvaWNlQW1vdW50IjogIjIzNS42NCIsCiAgICAgICAgICAgICAgICAiZWZmZWN0aXZlVGF4QW1vdW50IjogIjIuMzYiLAogICAgICAgICAgICAgICAgInRvdGFsVGF4QW1vdW50IjogIjIzOC4wMCIsCiAgICAgICAgICAgICAgICAibm90RGVkdWN0aWJsZVR5cGUiOiAiIgogICAgICAgICAgICB9CiAgICAgICAgXQogICAgfQ=="
}
```

```json
{
"data": "eyJhc3luY0ZsYWciOiIxIiwidGFza05vIjoiMzg5ZDg5MDdlYThlNDliZjhjZGNjODFiNjczMWU3NjYifQ==",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 调用发票勾选结果查询
+ 接口名字：4.06 发票勾选结果查询
+ 接口地址：https://open-ultimate.piaozone.com/api-145421065

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceSelectQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJ0YXNrTm8iOiAiMzg5ZDg5MDdlYThlNDliZjhjZGNjODFiNjczMWU3NjYiLAogICAgICAgICJwYWdlTm8iOiAxLAogICAgICAgICJwYWdlU2l6ZSI6IDUwCiAgICB9Cgo="
}
```

```json
{
"message": "异步任务处理中，请稍后再查询。[税号:91440300MA5G9GK78Y,没有开启软证书模式]",
"errorCode": "6910",
"status": false,
"success": false
}
```

## 调用当前统计
+ 接口名字：4.07 当前统计查询
+ 接口地址：https://open-ultimate.piaozone.com/api-145421066

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "statisticQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiCiAgICB9Cgo="
}
```

```json
{
"message": "税号:91440300MA5G9GK78Y,没有开启软证书模式",
"errorCode": "1130",
"status": false,
"success": false
}
```

## 调用生成&撤销统计表
+ 接口名字：4.08 生成&撤销统计表
+ 接口地址：https://open-ultimate.piaozone.com/api-145421067

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "statisticCreate",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJvcGVyYXRlVHlwZSI6ICIxIiwKICAgICAgICAiYXN5bmNGbGFnIjogIjEiCiAgICB9Cg=="
}
```

```json
{
"data": "eyJhc3luY0ZsYWciOiIxIiwidGFza05vIjoiYjNjOGI4NGI4OTJhNDQyM2FlMDc0N2M4MWI2ZmQ4YjkifQ==",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 调用生成&撤销统计表结果查询
+ 接口名字：4.09 生成&撤销统计表结果查询
+ 接口地址：https://open-ultimate.piaozone.com/api-145421068

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "statisticCreateQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJ0YXNrTm8iOiAiYjNjOGI4NGI4OTJhNDQyM2FlMDc0N2M4MWI2ZmQ4YjkiCn0="
}
```

```json
{
"message": "税号:91440300MA5G9GK78Y,没有开启软证书模式",
"errorCode": "1130",
"status": false,
"success": false
}
```

## 调用确认统计表
+ 接口名字：4.10 确认统计表
+ 接口地址：https://open-ultimate.piaozone.com/api-145421069

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "statisticConfirm",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJwYXNzd29yZCI6ICIxMjM0NTY3IiwKICAgICAgICAiYXN5bmNGbGFnIjogIjEiCn0="
}
```

```json
{
"data": "eyJhc3luY0ZsYWciOiIxIiwidGFza05vIjoiZDE5MDJmMzA3MmRiNDQ0MWEzZDdkOTkwNzA5ZjhjZmIifQ==",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 调用确认统计表结果查询
+ 接口名字：4.11 确认统计表结果查询
+ 接口地址：https://open-ultimate.piaozone.com/api-145421070

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "statisticCreateQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJ0YXNrTm8iOiAiZDE5MDJmMzA3MmRiNDQ0MWEzZDdkOTkwNzA5ZjhjZmIiCn0="
}
```

```json
{
"message": "未查询到“生成统计表”或“撤销统计表”相关任务，请确认“请求任务号”或“接口类型”是否正确。",
"errorCode": "2002",
"status": false,
"success": false
}
```

## 调用变更税款所属期
+ 接口名字：4.12 变更税款所属期
+ 接口地址：https://open-ultimate.piaozone.com/api-145421071

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "taxperiodChange",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwME1BNUc5R0s3OFkiLAogICAgICAgICJ0YXhQZXJpb2QiOiAiMjAyNTExIiwKICAgICAgICAic3RhdHVzIjogMQp9"
}
```

```json
{
"message": "非新电子平台或者乐企通道，不支持变更属期。",
"errorCode": "0201",
"status": false,
"success": false
}
```

# postman接口示列
[勾选抵扣.postman_collection.json](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/json/21778712/1764300548912-e5d2bedd-817d-4f7e-b25a-866cf051f01e.json)

