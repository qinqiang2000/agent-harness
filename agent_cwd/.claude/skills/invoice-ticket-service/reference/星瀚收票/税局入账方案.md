| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-11-13** | **支三垒** |


# 方案说明
本文档旨在方便各异构的系统与金蝶发票云系统功能结合，使对接上游系统可以快速、高效的完成收票系统异构对接，以适应该税改政策，完成全电发票的开具。如有异议请予指正。

# 方案适用场景说明
**场景说明：**

1. 如客户想对进项收到的发票进行管控，避免发票被随意红冲，对发票的状态进行更新可以使用发票云入账能力接口，将需要入账的进项发票数据进行同步税局； 
2. 通过发票云定时任务将进项全票池相关发票同步税局入账状态



**补充说明：**

1. 可以调用旗舰版发票云批量创建税局入账申请任务接口，将进项发票的状态入账同步给税局，后调用查询税局入账申请任务结果接口查询入账结果；
2. <font style="color:rgb(0,0,0);">通过定时任务对进项采集到的发票做自动入账设置，可以以数据来源，和绑定发票的单据类型，以及发票种类等维度进行发票自动入账的定时任务设置。从而实现发票的自动入账操作；</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148294122-4fc5dbba-6a6c-4a84-8f22-add9743eccf2.png)

## 对接税局入账申请任务流程图
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148273414-75d39d68-4bc6-47d5-9831-dfea20757416.png)

## 流程说明
**<font style="color:rgb(0,0,0);">业务说明：</font>**

员工的费用报销，差旅报销-客户付费、差旅报销-非客户付费、对供应商付款，项目采购与服务分包付款等



**<font style="color:rgb(0,0,0);">异构对接说明：</font>**

1. 异构系统调用发票云税局入账接口对进项采集到的发票进行入账申请请求；
2. 异构系统根据任务号对入账申请的任务号对入账执行情况进行查询。
3. 对全票池发票的数据进行请求税局入账从而到收到的发票进行管控避免进项采集到的发票被随意红冲，从而影响进项发票的相关操作；  


**<font style="color:rgb(0,0,0);">用户使用操作说明：</font>**

1. <font style="color:rgb(0,0,0);"></font>根据业务需要去调用税局入账接口/或定时下载任务将收到的发票数据同步税局入账申请从而到进项发票进行管控；
2.  业务系统根据相关查询条件去查询进项的入账状态。
3. 业务系统根据业务场景需要对进项发票数据做进一步的业务逻辑处理如：报销，供应商付款，税局入账，抵扣勾选等；做进项税抵扣业务。

# 接口执行顺序
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148448120-db34c7fe-3d35-48ec-b960-f01ffd242bf4.png)

## 授权接口
+ 接口名字：1.01.获取app_token
+ 接口地址：[https://open.piaozone.com/api-145421044](https://open.piaozone.com/api-145421044)

```json
{
"appId": "CASHINV",
"appSecuret": "12345678",
"tenantid": "devbiz",
"accountId": "1534920374578620490",
"language": "zh_CN"
}
```

```json
{
"data": {
"app_token": "12324eroeutrekdfgfkdkkk",
"success": true,
"error_desc": "",
"expire_time": 1535675659434,
"error_code": "0"
},
"state": "success"
} 
```

### 授权信息获取与初始化说明
**8.0路径****<font style="color:#117CEE;">：【开放服务云】→【OpenApi】→【安全策略】→【第三方应用】  </font>**

首次对接可根据对接系统不同创建不同的应用id

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764320001907-82d27039-a226-47ca-8601-701a93b8aef7.png?x-oss-process=image%2Fformat%2Cwebp)

<font style="background-color:rgb(255,255,255);">Appid与appSecuret为个性化设置</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148603782-c8dcb7b5-0874-4e26-a918-7e4cd5fb82d5.png)

点击获取【获取Token示例】

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148675223-aa6afb14-9074-445e-9aaa-066ba71437b7.png)

只需替换appSecret与apptoken即可调通获取当前登录系统用户的授权接口

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148697327-d611d9fc-e696-4481-b8fc-4a9412be9731.png)

### 常见授权接口异常
#### 异常类型1：数据中心accountId参数错误
+ **错误原因**<font style="background-color:rgb(255,255,255);">：accountId参数与数据中心配置不匹配</font>
+ **排查方法**<font style="background-color:rgb(255,255,255);">：检查accountId是否为数据中心分配的正确账号ID</font>
+ **解决措施**<font style="background-color:rgb(255,255,255);">：从数据中心管理界面获取正确的accountId参数</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148709946-36ed468c-d7a6-441f-a346-f468111b3da3.png)

#### <font style="background-color:rgb(255,255,255);">秘钥不对appsecuret参数不对</font>
+ **错误原因**：应用ID或密钥不正确
+ **排查方法**：检查第三方应用配置中的appid和appsecuret是否正确
+ **解决措施**：重新生成并更新正确的appid和appsecuret参数

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764148729239-1c3fc05e-6bf9-482d-8582-4b90f95c22ee.png)

## 税局登录接口
+ 接口名字：4.02 税局登录接口
+ 接口地址：https://open-ultimate.piaozone.com/api-145421060

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "taxLogin",
"requestId": "1624601109096",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDU5MTg3MjEzM0IiCiB9"
}
```

```json
{
"data": "eyJsb2dpblR5cGUiOiIxIn0=",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 调用税局入账接口
+ 接口名字：4.16 批量创建税局入账申请任务
+ 接口地址：https://open-ultimate.piaozone.com/api-258669364

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceRecorded",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDc0NTE5NDc3ODIiLAogICAgICAgICJuZXh0RW50cnlNYXJrU3RhdHVzIjogIjAyIiwKICAgICAgICAiaW52b2ljZXMiOiBbCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJzZXJpbE5vIjogIjMzODgyOTZjYTRkMTQ3ZjFiNGZmZTExNDQxMjQ5M2EwMCIsCiAgICAgICAgICAgICAgICAiaW52b2ljZU5vIjogIjIzNDQyMDAwMDAwMTY0MjE0MzM1IiwKICAgICAgICAgICAgICAgICJpbnZvaWNlQ29kZSI6ICIiLAogICAgICAgICAgICAgICAgInJlY29yZGVkVGltZSI6ICIyMDI1MTEyNiIsCiAgICAgICAgICAgICAgICAicmVjb3JkZWRQZXJpb2QiOiAiMjAyNTExMjYiCiAgICAgICAgICAgIH0KICAgICAgICBdCn0="
}
```

```json
{
"message": "该组织的收票通道不支持税局入账操作",
"errorCode": "2002",
"status": false,
"success": false
}
```

## 查询税局入账申请任务结果 
+ 接口名字：4.17 查询税局入账申请任务结果
+ 接口地址：https://open-ultimate.piaozone.com/api-258669778

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceRecordedQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDc0NTE5NDc3ODIiLAogICAgICAgICJ0YXNrTm8iOiAiOTE0NDAzMDA3NDUxOTQ3NzgyIiwKICAgICAgICAicGFnZU5vIjogMSwKICAgICAgICAicGFnZVNpemUiOiAyMDAKICAgIH0KCg=="
}
```

```json
{
"message": "未查询到相关任务，请确认请求税号或任务号是否正确",
"errorCode": "0201",
"status": false,
"success": false
}
```

# postman接口示列
### [税局入账.postman_collection.json](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/json/21778712/1764150762596-ae9039a5-0eab-4fcf-a3be-b844a8200bdb.json)
[异构对接税局入账方案.docx](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/docx/21778712/1764150762660-67f46d0f-4b63-4c20-bb99-85f845cfed6e.docx)



