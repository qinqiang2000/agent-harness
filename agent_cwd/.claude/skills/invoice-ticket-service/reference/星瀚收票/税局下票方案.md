| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-11-13** | **支三垒** |


# 方案说明
本文档旨在方便各异构的系统与金蝶发票云系统功能结合，使对接上游系统可以快速、高效的完成收票系统异构对接，以适应该税改政策，完成全电发票的开具。如有异议请予指正。

# 方案适用场景说明
**场景说明：**

1. 客户如无自己进项发票采集通道想要借助发票云进项发票能力进行从税局同步相关发票可以调用发票云接口；
2. 通过发票云定时任务从税局进行同步发票信息



**补充说明：**

1. 可以调用旗舰版发票关键进项表头归集接口，将进项发票的表头数据从税局同步回来；<font style="color:rgb(0,0,0);background-color:rgb(255,255,0);">发票表头数据无发票明细行数据；</font>
2. <font style="color:rgb(0,0,0);">通过定时任务下载全量发票数据，每月有五次数量限制；</font>

<font style="color:rgb(0,0,0);">由于税局发票数据同步需要时间，无法下载当天进项发票数据；</font>

<font style="color:rgb(48,48,48);background-color:rgb(255,255,255);">下载前四天的发票（全量发票下载rpa可以下载过去五年数据，乐企可以下载最近两年数据）</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764145877442-dd529485-e65f-41fc-a97c-df47369f0763.png)

3. <font style="color:rgb(0,0,0);">通过定时任务下载进项表头数据，</font>将进项发票的表头数据从税局同步回来<font style="color:rgb(0,0,0);">；</font>

<font style="color:rgb(0,0,0);">无发票明细数据，乐企无进项表头下载功能</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764145885388-348b38f1-400c-44b6-9300-cee59504499a.png)

## 对接税局下票相关案例流程图
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764145928472-c34118af-5ddf-46b4-8e2f-5402882e7e35.png)

## 对接税局下票流程说明
**<font style="color:rgb(0,0,0);">业务说明：</font>**

用于在客户业务系统无进行采集发票通道时，通过发票云进项发票下载接口或定时任务获取到该税号的进项发票数据用于后续进项业务场景中的报销，供应商付款，以及项目采购和税局入账及抵扣勾选；

**<font style="color:rgb(0,0,0);"></font>**

**<font style="color:rgb(0,0,0);">异构对接说明：</font>**

1. 异构系统调用发票云归集接口进行进项发票表头数据归集发起数据下载任务；
2. 异构系统根据任务号对进项表头下载任务的执行情况进行查询。
3. 将发票从税局同步到进项全票池后调用发票查询接口对发票查询，获取所需使用的发票数据



**<font style="color:rgb(0,0,0);">用户使用操作说明</font>**<font style="color:rgb(0,0,0);">：</font>

1. <font style="color:rgb(0,0,0);"></font>根据业务需要去调用进项表头归集/或定时下载任务从税局拉取业务系统所需发票至发票云全票池
2. 业务系统根据相关查询条件去查询进项发票。
3. 业务系统根据业务场景需要对进项发票数据做进一步的业务逻辑处理如：报销，供应商付款，税局入账，抵扣勾选等；

# 接口执行顺序
![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764147345713-73f344b0-983a-4c8c-ae1c-b74cb243589e.png)

## 授权接口
+ 接口名字：1.01.获取app_token
+ 接口地址：[https://open.piaozone.com/api-145421044](https://open.piaozone.com/api-145421044)

```json
{
"appId": "CASHINV",
"appSecuret": "12345678",
"tenantid": "devbiz",
"accountId": "1534920374578620490",
"language": "zh_CN"
}
```



```json
{
"data": {
"app_token": "12324eroeutrekdfgfkdkkk",
"success": true,
"error_desc": "",
"expire_time": 1535675659434,
"error_code": "0"
},
"state": "success"
} 
```

+ **接口名字：1.02获取access_token**
+ 接口地址：[<font style="color:rgb(0,0,255);">https://open.piaozone.com/api-145421045</font>](https://open.piaozone.com/api-145421045)

```json
{
"user": "13825207590",
"apptoken": "a3270799-b482-4697-931f-2fb68b56bdf2",
"tenantid": "devbiz ",
"accountId": "1534920374578620490",
"usertype": "Mobile"
}
```

```json
{
"data": {
"access_token": "f035550a-f9e8-4cc6-a775-8a21462a9f8b",
"success": true,
"error_desc": "",
"expire_time": 1535680289307,
"error_code": "0"
},
"state": "success"
}
```

### 授权信息获取与初始化说明
**8.0路径****<font style="color:#117CEE;">：【开放服务云】→【OpenApi】→【安全策略】→【第三方应用】  </font>**

首次对接可根据对接系统不同创建不同的应用id

![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764320001907-82d27039-a226-47ca-8601-701a93b8aef7.png?x-oss-process=image%2Fformat%2Cwebp)

<font style="background-color:rgb(255,255,255);">Appid与appSecuret为个性化设置</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764147383428-4ead3033-3f4a-40d2-9489-7dd0a371ff04.png)

点击获取获取Token示例

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764147395504-550b7ed7-3b27-4fb4-aaf3-22e406ff0687.png)

只需替换appSecret与apptoken即可调通获取当前登录系统用户的授权接口

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1764147432236-e02422d1-ffe6-4af2-acee-3ab5be7d659b.png)

### 常见授权接口异常
#### 异常类型1：数据中心accountId参数错误
+ **错误原因**<font style="background-color:rgb(255,255,255);">：accountId参数与数据中心配置不匹配</font>
+ **排查方法**<font style="background-color:rgb(255,255,255);">：检查accountId是否为数据中心分配的正确账号ID</font>
+ **解决措施**<font style="background-color:rgb(255,255,255);">：从数据中心管理界面获取正确的accountId参数</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391510154-638c5df3-f445-4808-9888-c94ee94730e6.png)

#### <font style="background-color:rgb(255,255,255);">秘钥不对appsecuret参数不对</font>
+ **错误原因**：应用ID或密钥不正确
+ **排查方法**：检查第三方应用配置中的appid和appsecuret是否正确
+ **解决措施**：重新生成并更新正确的appid和appsecuret参数

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391510421-fc993142-6e94-485c-9384-eb44679fec1d.png?x-oss-process=image%2Fformat%2Cwebp)

## 税局登录接口
+ 接口名字：4.02 税局登录接口
+ 接口地址：https://open-ultimate.piaozone.com/api-145421060

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "taxLogin",
"requestId": "1624601109096",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDU5MTg3MjEzM0IiCiB9"
}
```

```json
{
"data": "eyJsb2dpblR5cGUiOiIxIn0=",
"message": "请求成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 进项表头归集接口
+ 接口名字：4.02 进项表头归集
+ 接口地址：https://open-ultimate.piaozone.com/api-145421061

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceDown",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDU5MTg3MjEzM0IiLAogICAgICAgICJhc3luY0ZsYWciOiAiMSIsCiAgICAgICAgInNlYXJjaE9wdCI6IHsKICAgICAgICAgICAgInRheFBlcmlvZCI6ICIyMDIyMDYiLAogICAgICAgICAgICAiaW52b2ljZUNvZGUiOiAiIiwKICAgICAgICAgICAgImludm9pY2VObyI6ICIiLAogICAgICAgICAgICAic2FsZXJUYXhObyI6ICIiLAogICAgICAgICAgICAiYXV0aGVudGljYXRlRmxhZ3MiOiAiIiwKICAgICAgICAgICAgImludm9pY2VTdGF0dXMiOiAiIiwKICAgICAgICAgICAgImludm9pY2VUeXBlIjogIiIsCiAgICAgICAgICAgICJzdGFydFRpbWUiOiAiMjAyMy0wOC0xMiIsCiAgICAgICAgICAgICJlbmRUaW1lIjogIjIwMjUtMTEtMjUiCiAgICAgICAgfQogICAgfQ=="
}
```

```json
{
"data": "eyJhc3luY0ZsYWciOiIxIiwidGFza05vIjoiMmM0OTEyNjZjODliNGRjNmExYTRiMGMwYjk5ZmZlZTEifQ==",
"message": "成功",
"errorCode": "0000",
"status": true,
"success": true
}
```

## 进项发票表头归集结果查询 
+ 接口名字：4.03 表头归集结果查询
+ 接口地址：https://open-ultimate.piaozone.com/api-145421062

```json
{
"businessSystemCode": "yhtest",
"interfaceCode": "invoiceDownQuery",
"requestId": "1",
"data":"ewogICAgICAgICJ0YXhObyI6ICI5MTQ0MDMwMDU5MTg3MjEzM0IiLAogICAgICAgICJ0YXNrTm8iOiAiMmM0OTEyNjZjODliNGRjNmExYTRiMGMwYjk5ZmZlZTEiLAogICAgICAgICJzYXZlRmxhZyI6ICIxIiwKICAgICAgICAicGFnZU5vIjogMSwKICAgICAgICAicGFnZVNpemUiOiAyMDAKICAgIH0="
}
```

```json
{
"message": "税号:91440300591872133B,不在租户:5368720388 范围内",
"errorCode": "1130",
"status": false,
"success": false
}
```

# postman接口示列
### [收票电子税局下票.postman_collection.json](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/json/21778712/1764150785654-09506aeb-52e0-4881-aec1-bb0c5449eb6c.json)
[异构对接税局下票方案.docx](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/docx/21778712/1764150785726-bf379bac-37b9-4d7c-bc58-5d0ee00f705f.docx)

