| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.02** | **6.0及以上** | **公开** | **创建** | 2025-05-27 | 李志坚 |


# 一、背景
发票云系统后台服务出口IP不能直接访问公网乐企域名，乐企域名端口：lqpt.chinatax.gov.cn  8443

<font style="color:#DF2A3F;">本方案为纯代理方案，代理无应用程序</font>

# 二、常见场景及方案
#### 场景1：发票云系统部署在客户内网，客户内网不能直接访问公网域名需要DMZ机器做代理访问
**<font style="background-color:#FBDE28;">方案如图：</font>**

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723725461113-4a195178-73fa-4b61-b346-2a3733e08f69.png)

**操作申请：**

1. 开放防火墙 
    1. 保证金蝶发票云后台服务器出口IP可以直连代理机器入口IP ，协议是http或https
    2. 证代理机器可以直接访问税局乐企平台 ，协议是https
2. 建议代理服务器开启防火墙设置只允许金蝶发票云系统后台服务器访问
3. 建议出口IP和代理机器为访问乐企专用
4. <font style="color:#E4495B;">代理机器的出口外网IP与申请税局乐企时登记的IP保持一致 </font>
5. 代理机器建议可以是CentOS 7、Redhat、麒麟v10系统，代理软件建议是Nginx （如客户有网络运维能力，可自己选择熟悉的软件）
6. 配置要求2C4G以上（代理软件独立能用的资源，虚拟机、物理机都可以）
7. 生产环境若要实现高可用可以使用负载均衡器或者keepalive+虚ip
8. 金蝶公有云环境需要在乐企控制和开发平台两个地方将连接乐企地址头改成代理公网地址头，具体操作见[乐企沙箱控制文档](https://jdpiaozone.yuque.com/nbklz3/grvkab/bd132nud25mtdx67?singleDoc# )。

#### 场景2：发票云使用的是公有云，而乐企的访问需要企业所属IP，所以需要在客户申报出口ip机器做代理
**<font style="background-color:#FBDE28;">方案如图：</font>**

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723725446032-61075751-edcd-40af-a855-e015c91cc9b8.png)

<font style="color:rgb(8,13,30);">【图⽰内容摘要：场景2⽹络架构图，展⽰公有云环境下通过客⼾出⼝IP代理机器访问乐企平台 的⽹络拓扑】</font>

操作申请：

1. 开放防火墙 
    1. 保证金蝶发票云后台服务器出口IP可以访问代理机器外网映射IP/域名 ，协议是http或https
    2. 保证代理机器可以直接访问税局乐企平台 ，协议是https
2. 限制代理服务器入口<font style="color:#E4495B;">只允许金蝶出口IP访问，绝不可全网放开，否则会被乐企封IP</font>
3. 建议出口IP和代理机器为访问乐企专用
4. 金蝶出口IP：
    1. 集团沙箱出口ip：49.4.80.61; 124.70.28.68
    2. 集团生产出口ip：49.4.83.185; 121.36.53.241
    3. 发票云沙箱出口ip：68.79.14.3；82.156.30.248
    4. 发票云生产出口ip：52.82.125.155；82.157.180.203
5. <font style="color:#E4495B;">代理机器的出口外网IP与申请税局乐企时登记的IP保持一致</font> 
6. 代理机器操作系统建议可以是CentOS 7、Redhat、麒麟v10系统，代理软件建议是Nginx （如客户有网络运维能力，可自己选择熟悉的软件）
7. 配置要求2C4G以上（代理软件独立能用的资源，虚拟机、物理机都可以）
8. 生产环境若要实现高可用可以使用负载均衡器或者keepalive+虚ip
9. 金蝶公有云环境需要在乐企控制和开发平台两个地方将连接乐企地址头改成代理公网地址头，具体操作见[乐企沙箱控制文档](https://jdpiaozone.yuque.com/nbklz3/grvkab/bd132nud25mtdx67?singleDoc# )。

# 三、代理服务器（nginx）安装部署
1. 使用发票云安装包**默认端口为：8864**；即提供公网发票云访问的外网地址需映射内网代理机器的8864端口
2. 下载安装包：[**http://dl.piaozone.com:18025/download/tools/fpy-nginx-lqpt.tar.gz**](http://dl.piaozone.com:18025/download/tools/fpy-nginx-lqpt.tar.gz)**		**

**<font style="background-color:#FBDE28;">下载账号密码：fpy / Fpy@piaonzone2025#$（不定期修改，可联系发票云获取）</font>**

3. 将安装包上传到服务器随意目录，解压并执行安装脚本。

 tar xvf fpy-nginx-lqpt.tar.gz

 cd fpy-nginx-lqpt

sh nginx_install.sh 接入单位乐企id

ps -ef |grep nginx

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723794897581-a0464eff-2109-4138-a94d-2a61b76e91bf.png)

有进程则为安装完成。

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723794962038-7b88493a-5a23-49b8-b23b-723381181039.png)

4. 常见nginx运维命令
    1. 乐企配置文件路径： /usr/local/nginx/conf/conf.d/lqpt.conf；详细内容见附件
    2. 启动命令：/usr/local/nginx/sbin/nginx
    3. 检测配置是否有语法或格式错误：/usr/local/nginx/sbin/nginx -t
    4. 热加载nginx配置：/usr/local/nginx/sbin/nginx -s reload
    5. 停止nginx：/usr/local/nginx/sbin/nginx -s stop
    6. nginx日志目录：/usr/local/nginx/logs
5. 如果服务器已经安装nginx，需要将乐企代理配置添加配置文件中。（默认nginx安装路径为/usr/local/nginx）
    1. nginx.conf的http模块下添加"include /usr/local/nginx/conf/conf.d/lqpt.conf;" （lqpt.conf文件目录需要更改为实际目录）
    2. 将附件中的lqpt-conf.txt文件修改文件名为lqpt.conf后配置到include中的对应目录下，默认为：/usr/local/nginx/conf/conf.d/
    3. 检测和reload配置文件：

/usr/local/nginx/sbin/nginx -t

 /usr/local/nginx/sbin/nginx -s reload

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723775497577-4ea1f54f-91c6-435c-a7a2-0733c7abf2ae.png)

# 四、代理服务器（nginx）防火墙规则设置，所有命令需要root账号执行。
#### 启动防火墙并设置开机自启动
**systemctl enable firewalld**

**systemctl start firewalld**

#### 移除对端口8864（默认端口）的现有规则
**firewall-cmd --permanent --zone=public --remove-port=8864/tcp**

#### 允许指定ip访问指定端口
##### 发票云系统为私有云（手工替换命令中的ip）
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="星瀚发票云容器服务器ip1" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="星瀚发票云容器服务器ip2" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="星瀚发票云容器服务器ip3" port protocol="tcp" port="8864" accept"

##### 发票云系统为公有云
firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="49.4.80.61" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="124.70.28.68" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="49.4.83.185" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="121.36.53.241" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="68.79.14.3" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="82.156.30.248" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="52.82.125.155" port protocol="tcp" port="8864" accept"

firewall-cmd --permanent --add-rich-rule="rule family="ipv4" source address="82.157.180.203" port protocol="tcp" port="8864" accept"

#### 重新加载防火墙规则
**firewall-cmd --reload**

#### 查看规则
**firewall-cmd --list-all**

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723736053486-b57bdd76-d9ad-4995-837e-8373e2d1c84e.png)

# 五、乐企连通性常见测试命令
#### 测试乐企端口是否连通：
**telnet -t 20s lqpt.chinatax.gov.cn 8443**

**如图返回中包含"Connected"即为连通**

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723774534600-6b9c30a3-218b-4701-9c86-07f2d3e30110.png)

#### 测试接口请求是否可达乐企平台，需要将命令中的“接入单位乐企id”换成实际企业乐企ID：
**<font style="background-color:#FBDE28;">沙箱：</font>**

curl -k -X POST -H "Content-Type: application/json" -H "jrdwptbh:接入单位乐企id" -H "sydwptbh:接入单位乐企id" -H "sxcsbz:1" https://lqpt.chinatax.gov.cn:8443/access/newsandbox/v2/invoke/202007/CXKYSL

**<font style="background-color:#FBDE28;">生产：</font>**

curl -k -X POST -H "Content-Type: application/json" -H "jrdwptbh:接入单位乐企id" -H "sydwptbh:接入单位乐企id"  https://lqpt.chinatax.gov.cn:8443/access/v2/invoke/202007/CXKYSL

如图返回中包含"**json数据格式不正确**"即为连通，如果返回“403 Forbidden”需要试几次（多次不行可以等待30分钟后尝试）只要有一次返回了"json数据格式不正确"即为连通。

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723774414626-6de5e073-b4aa-4782-8e0f-b3077b760dd5.png)

![](https://cdn.nlark.com/yuque/0/2024/png/21778712/1723774722076-272175b7-23e0-4f19-ba41-40bf57e07114.png)

# 六、附件
#### lqpt-conf.txt-----乐企在nginx的代理配置文件
[lqpt-conf.txt](https://www.yuque.com/attachments/yuque/0/2025/txt/21778712/1748329996558-f835dc4c-fae5-442c-8521-955478c79812.txt)

#### 公有云发票系统方案PPT版
[乐企+发票云公有云+固定IP方案 v0.3.pptx](https://www.yuque.com/attachments/yuque/0/2025/pptx/21778712/1748329996647-46dfbf40-1f7b-4ff9-85b6-89e5808311dc.pptx)

#### 乐企被封IP解封申请材料模板
[关于申请开启乐企访问的申请.docx](https://www.yuque.com/attachments/yuque/0/2025/docx/21778712/1748329996788-215189dc-85ee-481d-aa74-e772d28ef385.docx)

