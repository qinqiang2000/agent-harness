| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-11-13** | **支三垒** |


# 方案说明
本文档旨在指导异构系统与金蝶发票云系统的集成对接，帮助上游系统快速实现收票系统的异构对接，以适应税改政策要求，完成全电发票的开具流程。文档内容供技术实施人员参考，如有异议请反馈指正。

# 对接发票助手说明
**<font style="background-color:#FBDE28;">业务场景：</font>**

1. 客户在费用报销或进项发票系统中创建业务单据
2. 通过发票助手采集并查验发票
3. 通过WebSocket或轮询方式获取发票结构化数据
4. 调用保存单据接口，建立发票与单据的绑定关系
5. 根据实际业务需求，调用生成并保存凭证接口（可选）
6. 根据实际业务需求，完成进项发票的抵扣勾选操作（可选）

**<font style="background-color:#FBDE28;">适用范围</font>**<font style="background-color:#FBDE28;">：</font>

1. 应用场景：适用于OA系统进项发票管理场景，用于发票采集与真伪核验
2. 支持查验发票种类：
    - 增值税专用发票
    - 增值税电子专用发票
    - 电子发票（增值税专用发票）
    - 电子发票（普通发票）
    - 增值税普通发票（折叠票）
    - 增值税普通发票（卷票）
    - 增值税电子普通发票（含收费公路通行费增值税电子普通发票）
    - 机动车销售统一发票
    - 二手车销售统一发票
3. 其他种类发票：支持通过OCR识别返回结构化数据，但不支持真伪核验

##  业务流程图
![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764145473950-806075bb-bde9-4105-b8b3-2245b23507e6.png)

## 流程说明
**<font style="color:#000000;">业务说明：</font>**<font style="color:#000000;"></font>

适用但不仅限于以下业务场景：

+ 员工费用报销
+ 差旅报销（客户付费）
+ 差旅报销（非客户付费）
+ 供应商付款
+ 项目采购付款
+ 服务分包付款

**<font style="color:#000000;">异构对接说明：</font>**

1. 在费用等单据界面增加以下自定义按钮：
    - “采集发票/附件”按钮
    - “查看发票/附件”按钮
2. “采集发票/附件”按钮配置：对接单点登录至发票云的发票助手采集界面
3. 数据交互流程：
    - 用户创建单据并完成发票采集
    - 调用发票云保存单据接口
    - 系统自动保存发票与单据的关联关系
    - 同步更新发票状态
4. “查看发票/附件”按钮配置：通过单点登录跳转至发票云发票助手查看界面
5. 逆向操作：调用发票云删除接口，解除发票与单据的关联关系

**<font style="color:#000000;">用户使用操作说明：</font>**

1. 用户在费用报销单中创建单据，填写相关单据内容
2. 用户在单据界面点击“选择发票”按钮跳转到发票云的发票助手上，采集发票。
3. 发票云根据企业的合规性校验配置检查用户上传的发票，合规的导入到单据中。
4. 业务主管审核业务的真实性
5. 财务的审核财务相关合规性
6. 审核 通过生成凭证，回写全票池发票入账信息。
7. 出纳付款 根据全票池的信息刷选出需要做进项税抵扣的发票，批量直连税局做进项税抵扣业务。

## 接口执行顺序
![](https://cdn.nlark.com/yuque/0/2025/png/39256605/1764145531976-dbae4219-2646-44c3-88d3-9d60cab625da.png)

# 授权接口
+ 接口名字：1.01.获取app_token
+ 接口地址：[https://open.piaozone.com/api-145421044](https://open.piaozone.com/api-145421044)

```json
{
  "appId": "CASHINV",
  "appSecuret": "12345678",
  "tenantid": "devbiz",
  "accountId": "1534920374578620490",
  "language": "zh_CN"
}
```



```json
{
	"data": {
		"app_token": "12324eroeutrekdfgfkdkkk",
		"success": true,
		"error_desc": "",
		"expire_time": 1535675659434,
		"error_code": "0"
	},
	"state": "success"
} 
```

+ 接口名字：1.02获取access_token
+ 接口地址：[https://open.piaozone.com/api-145421045](https://open.piaozone.com/api-145421045)

```json
{
	"user": "13825207590",
	"apptoken": "a3270799-b482-4697-931f-2fb68b56bdf2",
	"tenantid": "devbiz ",
    "accountId": "1534920374578620490",
	"usertype": "Mobile"
}
```



```json
{
	"data": {
		"access_token": "f035550a-f9e8-4cc6-a775-8a21462a9f8b",
		"success": true,
		"error_desc": "",
		"expire_time": 1535680289307,
		"error_code": "0"
	},
	"state": "success"
}
```

## 授权信息获取与初始化说明
**授权信息获取路径**：实施服务云 → 基础设置 → 第三方应用

**初始化步骤**：

1. 根据对接系统类型创建对应应用ID
2. 配置个性化Appid与appSecuret参数
3. 通过Token获取示例获取授权信息
4. 替换appSecret与apptoken完成授权接口调用

**适用范围**：适用于系统初次对接配置及授权参数维护场景，供技术实施人员使用

**配置界面截图**：

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391508995-c249d810-6dab-42f6-a885-0e4c6872eea4.png)

**Appid与appSecuret设置界面**：

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391509289-617255ef-bf30-4f6e-9cd0-eae42600e0d8.png)

**Token获取示例界面**：

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391509627-4adc2b26-8dfe-4427-a0da-11aeabf8c184.png)

**授权接口调用示例**：

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391509951-5ae96419-b496-4b30-a456-4a8abd4274c7.png)

## 常见授权接口异常
### 异常类型1：数据中心accountId参数错误
+ **错误原因**：accountId参数与数据中心配置不匹配
+ **排查方法**：检查accountId是否为数据中心分配的正确账号ID
+ **解决措施**：从数据中心管理界面获取正确的accountId参数

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391510154-638c5df3-f445-4808-9888-c94ee94730e6.png)

### 异常类型2：appid/appsecuret参数错误
+ **错误原因**：应用ID或密钥不正确
+ **排查方法**：检查第三方应用配置中的appid和appsecuret是否正确
+ **解决措施**：重新生成并更新正确的appid和appsecuret参数

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391510421-fc993142-6e94-485c-9384-eb44679fec1d.png)

# Js建立连接通道
```json
var httpUrl = "https://cosmic-sandbox.piaozone.com/jdpjykjyxgs/";
var wssUrl = "wss://cosmic-sandbox.piaozone.com/jdpjykjyxgs/" // 规律：将环境地址https改为wss（如果是http则改为ws）
var accessToken = "..."; // 上文第1步获取的access_token
var eventCode = "...";   // 上文第2步获取的eventCode
var identifytype = ".."  // 获取eventCode时，传入的linkKey参数

var socket = new WebSocket(wssUrl + "msgwatch/?identifytype=" + identifytype + "&token=" + accessToken);
//打开事件
socket.onopen = function () {
alert("连接成功");
setInterval(function () {
socket.send("{\"handshake\":false}");
}, 20000)
};
//获得消息事件
socket.onmessage = function (msg) {
alert("接收消息:" + msg.data);
};
//关闭事件
socket.onclose = function () {
alert("连接关闭");
};
//发生了错误事件
socket.onerror = function () {
alert("连接失败");
}
```

对接发票助手demo

# Socket数据返回格式 
```json
{
	"invoiceData": [
		{}—参见发票结构
	],
	"attachData": [
		{
			"attachUrl": "附件url",
			"attachType": "附件文件类型",
			"attachNo": "附件编号",
			"attachName": "附件名称"
		}
	]
}
```

发票数据结构：[https://open-ultimate.piaozone.com/doc-3656826](https://open-ultimate.piaozone.com/doc-3656826)

# 获取evencode 
功能说明：保存参数用于下一步打开的页面，返回唯一eventCode，eventCode有效期10分钟 

+ HTTP请求方式：POST
+ 请求参数格式：JSON
+ 返回格式：JSON
+ 调用限制：无
+ 请求路径：http://${baseUrl} /kapi/app/rim/message?access_token=${access_token}

```json
{
	"messageType": "getEventCode",
	"messageId": "请求id",
	"data": {
		"billId": "单据id",
		"billNo": "单据编码",
		"billType": "单据类型",
		"resource ": "单据来源系统",
		"billTaxNo": "单据所属企业税号",
"userId": "用户标识",
		"linkKey": "socket连接key",
		"companyInfo": [
			{
				"taxNo": "",
				"name": ""
			}
		]
	}
}
```



```json
{
	"data": {
		"eventCode": "" 
	},
	"success": "true",
"errorCode": "0000",
"message": "成功" 
}
```

请求参数描述：

| 参数 | | 类型 | 是否必须 | 示例 | 描述 |
| --- | --- | --- | --- | --- | --- |
| billId | | String | 是 | iCFJ7WdQTrxjJTCkx2fAmKk7FTnPXj= | 单据id |
| resource | | String | 是 | SSEPC | 单据来源系统，最长10位，<font style="color:#FF0000;">billId+resource唯一</font> |
| billNo | | String | 是 | <font style="color:rgb(0, 0, 0);">AVT-202206-002027</font> | 单据编码 |
| billTaxNo | | String | 否 | <font style="color:rgb(0, 0, 0);">91440300MA5G9GK78Y</font> | 单据<font style="color:#FF0000;">所属企业</font>税号，用于根据税号获取核算组织 |
| orgNumber | | String | 否 | <font style="color:rgb(0, 0, 0);">Org-00002</font> | 苍穹组织编码，如果存在发票将归到对应核算组织下 |
| pushType | | String | 是 | socket | 推送方式，socket,poll |
| billType | | String | 是 | er_dailyreimbursebill | 单据类型，系统管理员在收票管理下单据类型中维护 |
| userId | | String | 是 | ID-000006 | 用户标识，用户唯一标识，用于个人票夹数据隔离 |
| linkKey | | String | 是 |  | socket连接key，参见3.1 参数identifytype |
| companyInfo | | List | 否 |  |  |
|  | taxNo | String | 是 | <font style="color:rgb(0, 0, 0);">91440300MA5G9GK78Y</font> | 税号 |
|  | name | String | 是 | 金蝶票据云科技(深圳)有限公司 | 企业名称 |


返回参数：

| 参数 | | 类型 | 描述 |
| --- | --- | --- | --- |
| success | | String | true或false |
| errorCode | | String | 0000-成功  |
| message | | String | 结果描述 |
| data | | Json |  |
|  | eventCode | String | eventCode |


# 打开选择发票页面 
1. **PC端页面路径: **

https://${baseUrl}/index.html?formId=rim_fpzs_main&eventCode={eventCode} 

2. 移动端页面路径: 

https://${baseUrl}/mobile.html?form=rim_mobile_index&eventCode={eventCode} 

请求方式参见页面url处理

# 打开查看发票页面 
1. **PC端页面路径: **

<font style="color:#117CEE;">https://${baseUrl}/index.html?formId=rim_view_invoice&eventCode={eventCode} </font>

2. 移动端页面路径: 

<font style="color:#117CEE;">https://${baseUrl}/mobile.html?form=rim_invoice_list_mobile&eventCode={eventCode} </font>

请求方式参见页面url处理

# 保存单据 
功能说明：保存单据与发票关系 

+ HTTP请求方式：POST
+ 请求参数格式：JSON
+ 返回格式：JSON
+ 调用限制：无
+ 请求路径：http://${baseUrl} /kapi/app/rim/message?access_token=${access_token}

```json
{
	"messageType": "billSave",
	"messageId": "请求id",
	"data": {
		"billId": "单据id",
"resource ": "单据来源系统",
		"billNo": "单据编号",
		"billType": "单据类型",
		"billTaxNo": "单据所属企业税号”,
		“status”:”状态”,
		“invoiceData”: [
			{
				“serialNo”: “发票流水号”,
				“amount”:”报销金额”,
				“deductionFlag”:”是否可抵扣”,
				“deductionTaxAmount”:”可抵扣税额”,  
				“entryId”: “分录id” 
			}
		]
	}
}
```



```json
{
	“data”: { },
	“success”: “true”,
“errorCode”: “0000”,
“message”: “成功” 
}
```

**请求参数描述：**

| 参数 | | 类型 | 是否必须 | 示例 | 描述 |
| --- | --- | --- | --- | --- | --- |
| billId | | String | 是 | iCFJ7WdQTrxjJTCkx2fAmKk7FTnPXj= | 单据id |
| resource | | String | 是 | AESPC | 单据来源系统，最长10位，<font style="color:#FF0000;">billId+resource唯一</font> |
| billNo | | String | 是 | <font style="color:rgb(0, 0, 0);">AVT-202206-002027</font> | 单据编码 |
| billType | | String | 是 | er_dailyreimbursebill | 单据类型 |
| billTaxNo | | String | 是 | <font style="color:rgb(0, 0, 0);">91440300MA5G9GK78Y</font> | 单据<font style="color:#FF0000;">所属企业</font>税号 |
| orgNumber | | String | 否 | <font style="color:rgb(0, 0, 0);">Org-00002</font> | 苍穹组织编码 |
| status | | String | 是 | 1 | 单据状态，1-未用，30-在用，60-已用 |
| coverData | | Object | 否 |  | 封面 |
|  | base64 | String | 是 |  | 封面文件base64 |
|  | coveNo | String | 是 |  | 封面编号，<font style="color:#FF0000;">coveNo+resource唯一</font> |
|  | coveType | String | 是 |  | 封面文件类型,1-pdf,2-图片 |
| invoiceData | | List | 是 |  | 发票数据 |
|  | serialNo | String | 是 |  | 发票流水号 |
|  | amount | Decimal  | 否 |  | 报销金额，默认全部报销 |
|  | deductionFlag | String | 否 |  | 是否可抵扣 0-否，1-是 |
|  | deductionTaxAmount | Decimal  | 否 |  | 入账税额 |
|  | outputAmount | String | 否 |  | 转出金额 |
|  | remark | String | 否 |  | 转出原因 |
|  | entryId | String | 否 |  | 分录id |
|  | <font style="color:rgb(0, 0, 0);">extInfo</font> | Object | 否 |  | 发票主表二开字段 |
|  |  |  |  |  |  |


# 保存凭证
功能说明：保存单据与发票关系 

+ HTTP请求方式：POST
+ 请求参数格式：JSON
+ 返回格式：JSON
+ 调用限制：无
+ 请求路径：http://${baseUrl} /kapi/app/rim/message?access_token=${access_token}

```json
{
    "messageType": "voucherSave",
    "messageId": "请求id",
    "data": {
        "vouchId": "694dc8a844752b64022",//凭证id
        "vouchNo": "694dc8a844752b64022",//凭证号
        "accountDate": "2025-03-20",//所属账期
        "accountTime": "2025-03-20",//入账时间
        "businessDate": "2025-03-20",//业务日期
        "resource ": "SAP",//凭证来源
        "serialNoArray": [
        "907694dc8a844752b6402589e0e0c0330"//发票流水号
        ],
       "expenseIdArray": [
        "694dc8a844752b64022"//单据id 
        ] 
    }
}
```

**请求参数描述：**

| 参数 | 类型 | 是否必须 | 示例 | 描述 |
| --- | --- | --- | --- | --- |
| vouchId | String | 是 | iCFJ7WdQTrxjJTCkx2fAmKk7FTnPXj= | 凭证id |
| vouchNo | String | 是 | 694dc8a844752b64022 | 凭证号 |
| accountDate | String | 是 | 2025-03-20 | 所属账期 |
| accountTime | String | 是 | 2025-03-20 | 入账时间 |
| businessDate | String | 是 | 2025-03-20 | 业务日期 |
| resource  | String | 是 | AESPC | 凭证来源 |
| serialNoArray | List | 是 | 907694dc8a844752b6402589e0e0c0330 | 发票流水号 |
| expenseIdArray | List | 是 | 694dc8a844752b64022 | 单据id |


# 实现效果 
## postman接口示列




<font style="color:#DF2A3F;">注意：目前由于苍穹架构调整，第三方系统访问苍穹系统不在允许url拼接accesstoken方式进行访问，统一使用登录认证的方式进行安全认证，安全认证信息请参考下面链接</font>[https://vip.kingdee.com/knowledge/specialDetail/228892721203874816?productLineId=29&lang=zh-CN](https://vip.kingdee.com/knowledge/specialDetail/228892721203874816?productLineId=29&lang=zh-CN)

## 10.2 对接发票页面示列demo
<font style="color:#344054;">为方便开发者测试，我们将上述步骤整合起来，做了一个postman的collection</font>[收票.json](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/json/39256605/1764145928294-fc5aca2b-22cf-4b2f-a4cf-ae5d019eca53.json)<font style="color:#344054;">和html示例代码</font>[socket-test 0312.html](https://jdpiaozone.yuque.com/attachments/yuque/0/2025/html/39256605/1764146441275-8cb6abeb-1ebe-4218-9932-a4ad71989d3c.html)<font style="color:#344054;">。</font>

1. <font style="color:#344054;">用PC打开该页面，并填写  
</font>![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391510803-bd2957ef-d24c-4940-aafb-1fe6dbcc09d0.png)
2. **<font style="color:#344054;">点击“打开页面”</font>**<font style="color:#344054;">  
</font><font style="color:#344054;">如果出现以下发票采集页面，则说明打开成功。  
</font>![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391511094-bdfcb615-7d94-4b68-a6d5-af0c56f455ce.png)
3. **<font style="color:#344054;">采集发票</font>**<font style="color:#344054;">  
</font><font style="color:#344054;">如果您按上述步骤的参数打开的页面，可以通过【电脑上传】上传发票  
</font>![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391511379-4bc8104b-0e66-4efd-abcb-60d6c69923db.png)

<font style="color:#344054;">需上传申请eventCode时传入的税号和企业名称作为购方的发票，否则会提示不合规</font>

4. <font style="color:#344054;">导入单据  
</font><font style="color:#344054;">点击右下角的【导入单据】按钮，如果出现下图的弹框，说明PC页面已经收到服务端通过websocket推送的发票数据。</font>

![](https://cdn.nlark.com/yuque/0/2025/png/27248535/1745391511677-b1e57be5-af7c-4346-beed-41b9a955c71a.png)

<font style="color:#344054;">至此，对接完毕！</font>

# 对接常见异常排查
## websocket异常排查
[苍穹Websocket常见问题分析](https://vip.kingdee.com/knowledge/647444403023554048?channel_level=%E9%87%91%E8%9D%B6%E4%BA%91%E7%A4%BE%E5%8C%BA%7C%E6%90%9C%E7%B4%A2%7C%E5%AE%98%E6%96%B9%E7%9F%A5%E8%AF%86&productLineId=29&isKnowledge=2&lang=zh-CN)

##  跨域问题解决  
（1）根据手册的方案三，现场自行开发插件

[第三方系统跳转接星瀚对接方案](https://vip.kingdee.com/link/s/ZQssn)

（2）私有云由运维自行在MC部署插件，集团公有云提单找公有云运维老师帮忙部署

##  websocket监听不到消息  
直接调用接口【[3.07 长轮询获取发票信息 - 发票云(旗舰版)API文档](/tolink?target=https%3A%2F%2Fopen-ultimate.piaozone.com%2Fapi-145421053)】

注意前面获取linkkey和后面长轮询linkkey是同一个，一个linkkey只能消费一次





