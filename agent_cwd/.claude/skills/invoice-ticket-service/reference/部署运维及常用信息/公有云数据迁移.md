文档适用范围：星空旗舰版开票

## 操作手册更新版本记录
| 文档版本 | 文档更新日期 | 对应产品版本号/功能更新日期 | 说明 | 更新人 |
| --- | --- | --- | --- | --- |
| V1.0 | 2025.11.05 |  | 初稿发布 |  |
| V2.0 | 2025.11.22 | 2025.11.22 | ①优化了公有云发票同步、同步AWS个人发票、小程序推送发票数据时支持将AWS推送的invoiceTag字段保存到票池的发票标注字段<br/>② 优化了支持星瀚回写发票状态至AWS，详见3.3第2点。 |  |




## 公有云数据迁移操作路径及所属模块编码
操作路径：【发票服务】→【基础资料】→【公有云数据迁移】

所属模块编码：其他

所属模块名称：其他

## 公有云数据迁移功能设计理念概述
通过定时任务，将公有云的发票数据同步至星瀚发票服务。 原使用AWS公有云产品的用户，可通过定时任务或手工同步将发票数据（发票票面信息、发票报销状态、发票认证状态等）同步至星瀚发票服务。AWS切换星瀚的用户，只需配置此处，无其他数据迁移相关配置。

## 公有云数据迁移功能详解
### 公有云数据迁移关键字段说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">字段名称*</font>** | **<font style="color:rgb(26, 26, 26);">业务含义*</font>** | **<font style="color:rgb(26, 26, 26);">赋值规则*</font>** | **<font style="color:rgb(26, 26, 26);">控制规则*</font>** | **<font style="color:rgb(26, 26, 26);">其他属性说明</font>** |
| --- | --- | --- | --- | --- | --- |
| 1 | 组织 | 企业的组织名称 |  |  |  |
| 2 | 税号 | 纳税人识别号 |  |  |  |
| 3 | 类型 | 包含进项同步和销项同步 |  |  |  |
| 4 | 处理开始时间 | 数据同步的开始时间 |  |  |  |
| 5 | 处理完成时间 | 数据同步的结束时间 |  |  |  |
| 6 | 数据日期 | 要同步的数据的日期 | 在同步列表中修改，默认为当天 |  |  |
| 7 | 同步结果 | 数据同步的结果 |  |  |  |
| 8 | 同步信息 | 数据同步后的反馈 |  |  |  |
| 9 | 成功记录 | 数据同步成功的次数 |  |  |  |
| 10 | 处理次数 | 数据同步的次数 |  |  |  |


### 公有云数据迁移按钮说明
| **序号*** | **<font style="color:rgb(26, 26, 26);">按钮名称*</font>** | **<font style="color:rgb(26, 26, 26);">功能描述*</font>** | **<font style="color:rgb(26, 26, 26);">使用条件</font>** | **<font style="color:rgb(26, 26, 26);">其他说明</font>** |
| --- | --- | --- | --- | --- |
| 1 | 进项同步 | 同步有关进项的数据 | 直接点击 |  |
| 2 | 销项同步 | 同步有关销项的数据 | 直接点击 |  |


### 公有云数据迁移主要操作说明
#### 进项同步/销项同步
**步骤1：**点击“进项同步”或“销项同步”并选中要同步的数据。![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748915725129-219caba8-202c-470e-a4d4-df1193dd9337.png)![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748915764947-c1de98fd-0558-4fa3-85d5-9b71fa237e5d.png)

  
**步骤2：**设置数据时间，<font style="color:#000000;">如"2024-07-22",则同步"2024-07-22“新增或修改的数据, 为空全量同步，全量同步数据量比较大耗时较长，请谨慎使用。</font>点击同步按钮即可在公有云数据迁移列表中看到该数据的同步结果和同步信息。![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748915941672-0bba6365-e05b-40db-ad49-796701d204af.png)

还可以选择按单据同步数据，选中要同步数据的组织并点击”按单据同步“进入到报销单同步页面，输入该组织下的单据编号也可以同步。![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748915981255-17b995c9-e4bc-402d-9b94-61c0846c9ca4.png)

支持配置从AWS中不同步到星空进项全票池的字段，在开发平台-发票服务-系统管理-云应用参数配置-参数配置单据  增加配置项

 配置项key  ： rim_config_nonsync_fields  

 配置项值  ：发票主表中不从AWS同步的字段名，支持字段有：“entryAmount”,“ outputAmount”,“deductionFlag”，“outputReason”,不在范围内的字段不生效，配置多个字段时使用逗号分隔

####  进项定时同步设置
1. <font style="color:#000000;">初次使用请全量同步：系统上线做一次全量同步，选择对应的组织，并把“数据时间”清空，点击“同步”退出返回列表查看同步结果（此处企业不用新增，只要在费报处配置过授权id的企业都会显示）。</font>
2. <font style="color:#000000;">设置定时同步：在 【系统服务云】-->【调度中心】-->【调度计划】-->【发票服务】-->【收票管理】，找到“rim_InvoiceHisDataTask_SKDP_S”（ 定时下载发票历史数据）-每天增量同步当天数据，注意：“rim_InvoiceHisDataFailJob_SKDP_S”（</font> <font style="color:#000000;">历史发票同步失败重试）-增量同步失败，第二天会再次同步失败的组织，自动重试3次，3次仍然失败，请手工同步或检查网络或配置是否正确。</font>

![](https://cdn.nlark.com/yuque/0/2025/png/56650036/1748916011055-687601f3-ec7c-405f-b997-0b1111a49101.png)

3. <font style="color:#000000;">公有数据与下载数据不一致情况：收票管理配置-预览，检查以下配置：“全票池显示未查验发票”为是，“全票池不展示未用发票”为是，“同步未用发票”为是，星空收票管理票池数据才会和AWS商家平台台账数量保持一致。</font>

![](https://cdn.nlark.com/yuque/0/2023/png/26098688/1683872957054-2420d809-b39f-4a32-8594-3bac1acac029.png)

4. <font style="color:#000000;">同步不成功排查思路：</font>

<font style="color:#000000;">1）在费用核算-发票服务配置 配置号组织对应的clientid正确，且切换为正确的组织。</font>

<font style="color:#000000;">2）先看下是否全部发票同步，日期为空是同步所有发票，有日期的是同步期间内AWS采集的发票。         
</font><font style="color:#000000;">	3）开发平台搜索：收票管理配置-预览，检查“同步公有云数据”栏目（一般不需要检查，默认可同步）。</font>

#### 同步AWS票夹数据至个人票夹
全局配置【同步AWS票夹数据至个人票夹】默认为关闭；开启后，当进行AWS数据同步时，一起将小程序的票夹数据同步至星空对应用户的个人票夹中（需在星空用户信息维护与微信授权一致的手机号）

路径：开发平台预览 rim_config 表单

![](https://cdn.nlark.com/yuque/0/2025/png/47254879/1750820847030-5ac5b956-2b8c-42da-aed1-d1c3f8008dad.png?x-oss-process=image%2Fformat%2Cwebp)

<font style="color:rgb(64, 64, 64);">（1）公有云同步AWS数据时，AWS返回用户信息（手机号）</font>

+ <font style="color:rgb(64, 64, 64);">根据手机号校验用户是否在星空存在</font>
+ <font style="color:rgb(64, 64, 64);">如果存在校验用户是否有对应组织权限</font>

校验通过并成功入库后建立用户和发票/附件的关联关系，进入用户的个人票夹/个人附件

<font style="color:rgb(64, 64, 64);">（2）单张发票可关联多个用户（1:N关系），同一发票更新关联用户时只做追加不做覆盖</font>

（3）数据覆盖规则：当星空的发票修改状态为未修改时，同步后以aws的发票数据为准；如果星空的发票修改状态为已改，同步后不更新发票的票面数据。

（4）<font style="color:rgb(33, 33, 33);">公有云数据同步列表记录日志，</font>未找到关联用户不视为同步失败

（5）目前调用的接口AWS只返回发票关联的附件，附件入库后绑定和发票的关系，星空对应的附件没和用户绑定，就绑定第一个用户；已关联用户则不覆盖。

![](https://cdn.nlark.com/yuque/0/2025/png/22190160/1745166391502-4b55bcf5-1465-4771-8070-582bcaada6b4.png)

#### 星瀚回写发票状态至AWS
1.  rim_config 增加全局参数 【是否回写发票状态至AWS】默认关闭

![](https://cdn.nlark.com/yuque/0/2025/png/35533825/1760595203277-f74339d6-7b36-4338-ac4d-ca1da19b937b.png)

2. 开启后，当星空新增或删除单据信息后，如果该发票的AWS发票流水号字段有值，异步调用AWS<font style="color:rgb(52, 64, 84);">单据接口</font>

调用星空保存单据接口<font style="color:rgba(147, 115, 238, 0.75);">：</font>调用AWS[保存单据](https://open-standard.piaozone.com/api-188848228)接口并调用更新 [单据状态](https://open-standard.piaozone.com/api-189125717)接口 ,如果有多个单据，调用时让AWS强制写入  
调用星空删除单据接口：调用AWS删除单据接口

页面操作发票解绑：调用AWS[保存单据](https://open-standard.piaozone.com/api-188848228)接口删除发票

（1）clientId使用单据调用星空收票保存单据接口传的组织,如果没传则使用token里的登录组织 找对应的发票服务授权

（2）调用时使用AWS发票流水号

![](https://cdn.nlark.com/yuque/0/2025/png/22190160/1754907693138-8d8133f7-08ce-45a1-8bcc-272b4d28eabf.png?x-oss-process=image%2Fformat%2Cwebp)

（3）调用时，单据编号、单据ID、发票流水号、用户ID、单据状态、数据来源必传，其他非必填项置空

3. 调用记录保存至报销单日志列表中，操作类型为同步单据至AWS

## 公有云数据迁移相关配置说明【暂无配置】
## 公有云数据迁移相关接口说明【暂无接口】
| 编号 | 接口名称 | 接口用途 | 接口链接 |
| --- | --- | --- | --- |
| | | | |
| | | | |


## 
