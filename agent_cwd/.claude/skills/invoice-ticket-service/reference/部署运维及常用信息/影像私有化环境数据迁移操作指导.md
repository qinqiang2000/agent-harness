| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建/更新时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **标准版影像** | **公开** | 创建 | **2025-11-18** | **欧浩斌** |


# 文档说明
本文档适用于私有化影像系统的数据迁移操作指南。本文详细介绍了 MySQL 数据迁移和 MinIO 数据迁移的全过程。根据项目需求，可能仅涉及其中一种数据迁移任务，用户可以根据实际情况选择相关部分进行操作。

# 新环境搭建
## mysql环境部署
mysql部署包下载地址：

 [http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz](http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip)

**账号：fpy**

**密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**

部署包的mysql版本为： 8.0.31

影像sql版本为： v5.9.1

如果用户原环境影像版本低于v5.9.1，可在部署mysql后，将其中的数据库删除，再进行数据迁移

删除库包括：archive、invoice、scan、scan_alarm、tenant_cms、tenant_invoice、xxl_job



部署操作：

```shell
#将安装包上传到mysql服务器的/data目录下
#解压安装：
tar xvf sql_install.tar.gz
#切换到解压目录，执行：
mysql主服务器：
sh install-mysql.sh master 安装目录 master-ip
mysql从服务器：
sh install-mysql.sh slave 安装目录 master-ip
#单机部署：
sh install-mysql.sh single 安装目录 本机ip
```

## minio环境部署
### minio部署包下载地址：
    - **集群版：**

[http://dl.piaozone.com:18025/download/image-archive/minio_install_cluster.tar.gz](http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip)

        * **账号：fpy**
        * **密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**
    - **单机版：**

[http://dl.piaozone.com:18025/download/image-archive/minio_install_single.tar.gz](http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip)

        * **账号：fpy**
        * **密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**

#minio分为集群模式和单机模式，可根据项目需求选择对应的部署包

### 集群版部署操作：
```shell
#将部署包上传到四台服务器的/data/目录下
#解压安装包，进入解压目录
cd /data
tar xf minio_install_cluster.tar.gz
cd minio_install_cluster
#编辑config_install文件，将4个机器的ip填入（四台机器都要写）
vim config_install
#执行脚本安装：
sh  minio_install.sh 安装目录本节点IP
#如：sh minio_install.sh /data 192.168.178.45
```

### 单机版部署操作：
```shell
#解压安装包，进入解压目录
cd /data
tar xf minio_install_single.tar.gz
cd minio_install_single
#执行脚本安装：
sh minio_install.sh 安装目录
```

## 应用部署
应用部署包下载地址：

[http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip](http://dl.piaozone.com:18025/download/image-archive/update-image-archive.zip)

        * **账号：fpy**
        * **密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**

应用部署操作：

```shell
#把部署包上传到应用服务器的/data 目录下、解压
tar xvf install_imgarchive_docker.tar.gz
cd install_imgarchive_docker
#编辑config_install文件，将新环境信息填入
#主节点安装：
sh install_imgarchive.sh master 
#从节点安装：
sh install_imgarchive.sh slave
#单节点安装：
sh install_imgarchive.sh single 本机ip 安装目录
```

# 数据迁移
#数据迁移时，需停服操作，避免迁移过程中数据写入，造成新旧环境数据不一致。

## 停止应用服务
#新旧环境中的应用服务都先停止

```shell
cd /安装目录/kingdee/script
sh stop.sh
```

## mysql数据迁移
```shell
#原环境导出全量数据：
mysql  -h old_master-ip -uuser  -ppassword –all-databases –set-gtid-purged=OFF > all_data.sql
#全量数据导入到新环境：
mysql -h new_master.ip -uuser  -ppassword < all_data.sql
```

## minio数据迁移
数据迁移前，需要先再新环境中创建存储桶，操作如下：

```shell
#配置新环境minio别名
mc alias set minio_local http://127.0.0.1:9000 admin Kd@Archive2022Minio --api s3v4
#参数说明：
# minio_local ：设置的minio别名，可自定义
# http://127.0.0.1:9000 ： 新环境minio连接地址
# admin： minio用户名
# Kd@Archive2022Minio： minio密码
# --api s3v4： 指定
```

