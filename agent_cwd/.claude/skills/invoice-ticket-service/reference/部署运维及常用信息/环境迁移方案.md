| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0及以上** | **公开** | **创建** | **2025-10-15** | **欧浩斌** |


# 文档说明
本文适用于客户将星瀚环境数据全量迁移至私有云环境

# 数据文件获取
## 集团公有云环境
    1. appstore应用包
    2. PG数据库文件
    3. fileserver文件

## 发票云IDC环境获取
联系发票云运维人员申请获取，[客服入口](https://tax.piaozone.com/sobot-web/home)

## 私有化环境获取
    1. appstore应用包
    2. PG数据库文件
    3. fileserver文件

# 数据库恢复（pgsql）
pgsql备份数据dump文件中，不包含建库语句，在数据恢复前需要先建库，建库语句参考：

```sql
create database 库名 with owner=用户名 encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
#库名一般以 租户_库  的命名方式，如：tenant_fi、tenant_wfs、tenant_eip、tenant_sys、tenant_scm
#owner=： 数据库所有者
#ENCODING =： 数据库字符编码
#TABLESPACE = ： 数据库表空间
#LC_COLLATE = ： 数据库排序规则
#LC_CTYPE = ： 数据库字符分类规则
#CONNECTION LIMIT = ： 数据库最大连接限制，-1代表无限制

#示例：
create database tenant_wfs with owner=cosmic encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
create database tenant_eip with owner=cosmic encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
create database tenant_fi with owner=cosmic encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
create database tenant_sys with owner=cosmic encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
create database tenant_scm with owner=cosmic encoding='UTF8' tablespace=pg_default LC_COLLATE='en_US.UTF-8' LC_CTYPE='en_US.UTF-8' CONNECTION LIMIT=-1 TEMPLATE template0;
```

导入数据：

```shell
pg_restore -U postgres --no-owner --role cosmic -d 库名 -v dump文件;
#-U ：参数指定连接 PostgreSQL 数据库的用户名
#--role cosmic ：指定恢复时使用的角色（即数据库中的权限角色）
#库名后缀与dump文件一致，dump文件一般会包含库名后缀
#示例
pg_restore -U postgres --no-owner --role cosmic -d tenant_wfs -v 10.199.142.85_5432_prod_yixue24_wfs.dump;
pg_restore -U postgres --no-owner --role cosmic -d tenant_eip -v 10.199.142.85_5432_prod_yixue24_eip.dump;
pg_restore -U postgres --no-owner --role cosmic -d tenant_fi -v 10.199.142.85_5432_prod_yixue24_fi.dump;
pg_restore -U postgres --no-owner --role cosmic -d tenant_sys -v 10.199.142.85_5432_prod_yixue24_sys.dump;
pg_restore -U postgres --no-owner --role cosmic -d tenant_scm -v 10.199.142.85_5432_prod_yixue24_scm.dump;
```

# 新增租户+数据中心
## 新增租户：
1. 登录mc，选择： 租户列表——>新增
2. 根据提示填写对应信息：租户id、租户名称、所属集群、企业名称、统一社会信用代码
3. 保存退出

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1760578931880-9d117587-c46e-48d3-9741-90d66ad51177.png)

## 新增数据中心：
1. 进入刚刚新增的租户页面，点击增加数据中心
2. 填写对应信息：数据中心名称、编码、管理员电话、管理员邮箱
3. 分库信息参照天梯导出：

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1760512509805-241c686f-44fb-4d04-8e00-6f6382f3d943.png)

#实例名参照数据库恢复是创建的库名。

# fileserver数据恢复
把备份的fileserver数据恢复到 共享存储中。

在共享存储目录下，创建租户名目录，将备份数据解压到租户名目录下，然后修改解压后目录为数据中心id

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1760514566711-dcc02c3a-7a90-4d5f-bd18-8183f436f8b1.png)

# 发布版本补丁包
+ 获取私有云星瀚版本josn文件：[版本记录导出](https://vip.kingdee.com/knowledge/502217102992660224?productLineId=29&isKnowledge=2&lang=zh-CN)
+ 将版本号发给发票云技术支持，申请最新版本补丁包
+ mc发布版本补丁包：[星瀚标品包发包操作指导](https://jdpiaozone.yuque.com/nbklz3/tadboa/tg0610gycded4rw6)





