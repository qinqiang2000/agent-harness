| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建（修改）时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **7.0以上** | **公开** | **创建** | **2025-09-28** | **欧浩斌** |


# 文档说明
本文档适用于在未部署金蝶苍穹环境的服务器上完整部署星瀚发票云系统（包含苍穹平台）。本文档提供生产环境部署全流程指导。

# 获取部署包
部署包下载地址：[https://download.kdcloud.com/](https://download.kdcloud.com/)

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047237886-995b5cd2-a269-481e-bf68-6a7006325454.png)

<font style="color:#DF2A3F;background-color:#FBDE28;">#根据系统架构选择对应的部署包</font>

# 环境检查
## 操作系统要求
支持以下操作系统版本：

+ CentOS 7.9
+ Ubuntu 22.04.3 LTS、22.04.4 LTS
+ Redhat 8.5、8.8 LTS
+ 麒麟V10 SP1(Build04/20200711)、SP2(Build09/20210524)、SP3(Build23/20230324)
+ openEuler 22.03 LTS SP3

## 硬件配置要求
+ **生产环境标准版：**

| 服务器名称 | 操作系统 | CentOS【7.9】，Ubuntu【22.04.3，22.04.4】，Redhat【8.5，8.8】，<br/>麒麟V10 【SP1_Build04/20200711, SP2_Build09/20210524, SP3_Build23/20230324, SP3_Build20/20240426】<br/>openEuler【22.03 LTS SP3】 | | | | |
| :---: | :---: | --- | --- | --- | --- | --- |
| | cpu | 内存 | 系统盘 | 数据盘 | 备注 | 安装组件 |
| 应用服务器1 | 8 | 32 | 100 | 300 | K8S:1.19.12，Docker:20.10.7，mc控制容器，mservice容器，fileserver容器，web容器<br/>K8S为三个master需要一个VIP做高可用 | 苍穹应用 K8s Master |
| 应用服务器2 | 8 | 32 | 100 | 300 | | 苍穹应用 K8s Master |
| 应用服务器3 | 8 | 32 | 100 | 300 | | 苍穹应用 K8s Master |
| 数据库服务器1 | 8 | 32 | 100 | 500 | 默认为postgre12.8数据库，做主从 | PostgreSQL数据库 |
| 数据库服务器2 | 8 | 32 | 100 | 500 | | PostgreSQL数据库 |
| 中间件服务器1 | 4 | 16 | 50 | 300 | <br/>Redis 5.0.13 、zookeeper 3.5.9 、RabbitMQ  3.8.18 <br/> | Zookeeper、RabbitMQ、Redis |
| 中间件服务器1 | 4 | 16 | 50 | 300 | | Zookeeper、RabbitMQ、Redis |
| 中间件服务器1 | 4 | 16 | 50 | 300 | | Zookeeper、RabbitMQ、Redis、PostgreSQL Monitor插件 |
| 系统日志服务器 | 4 | 16 | 50 | 300 | elasticsearch 6.8.18、Logstash 6.8.18、kafka 2.12-3.2.0  | Elasticsearch、Logstash、Kafka |
| nginx服务器1 | 4 | 8 | 50 | 200 | nginx+keepalive+vip做高可用 | nginx |
| nginx服务器2 | 4 | 8 | 50 | 200 | | nginx |
| nfs共享服务器 |  |  |  | 1024 | 共享存储设备，需挂载三个应用服务器和ng入口机器 | / |
| 总计 | 64 | 240 | 800 | 4524 |  |  |




+ **生产环境紧凑版：**

| 服务器名称 | 操作系统 | CentOS【7.9】，Ubuntu【22.04.3，22.04.4】，Redhat【8.5，8.8】，<br/>麒麟V10 【SP1_Build04/20200711, SP2_Build09/20210524, SP3_Build23/20230324, SP3_Build20/20240426】<br/>openEuler【22.03 LTS SP3】 | | | | |
| :---: | :---: | --- | --- | --- | --- | --- |
| | cpu | 内存 | 系统盘 | 数据盘 | 备注 | 安装组件 |
| 应用服务器1 | 8 | 32 | 100 | 300 | 1，K8S:1.19.12，Docker:20.10.7，mc控制容器，mservice容器，fileserver容器，web容器<br/>2，K8S为三个master需要一个VIP做高可用<br/>3，Redis 5.0.13 、zookeeper 3.5.9 、RabbitMQ  3.8.18  | 苍穹应用 K8s Master、Zookeeper、RabbitMQ、Redis |
| 应用服务器2 | 8 | 32 | 100 | 300 | | 苍穹应用 K8s Master、Zookeeper、RabbitMQ、Redis |
| 应用服务器3 | 8 | 32 | 100 | 300 | | 苍穹应用 K8s Master、Zookeeper、RabbitMQ、Redis、PostgreSQL Monitor插件 |
| 数据库服务器1 | 8 | 32 | 100 | 500 | 1，默认为postgre12.8数据库，做主从<br/>2，从机器安装ELK日志系统：elasticsearch 6.8.18、Logstash 6.8.18、kafka 2.12-3.2.0  | PostgreSQL数据库 |
| 数据库服务器2 | 8 | 32 | 100 | 500 | | PostgreSQL数据库、Elasticsearch、Logstash、Kafka |
| nginx服务器1 | 4 | 8 | 50 | 200 | nginx+keepalive+vip做高可用 | nginx |
| nginx服务器2 | 4 | 8 | 50 | 200 | | nginx |
| nfs共享服务器 |  |  |  | 1024 | 共享存储设备，需挂载三个应用服务器和ng入口机器 | / |
| 总计 | 48 | 176 | 600 | 3848 |  |  |




+ **生产环境非高可用版：**

| 服务器名称 | 操作系统 | CentOS【7.9】，Ubuntu【22.04.3，22.04.4】，Redhat【8.5，8.8】，<br/>麒麟V10 【SP1_Build04/20200711, SP2_Build09/20210524, SP3_Build23/20230324, SP3_Build20/20240426】<br/>openEuler【22.03 LTS SP3】 | | | | |
| :---: | :---: | --- | --- | --- | --- | --- |
| | cpu | 内存 | 系统盘 | 数据盘 | 备注 | 安装组件 |
| 应用服务器1 | 8 | 48 | 100 | 1024 | 1，K8S:1.19.12，Docker:20.10.7，mc控制容器，mservice容器，fileserver容器，web容器<br/>2，中间件：Redis 5.0.13 、zookeeper 3.5.9 、RabbitMQ  3.8.18  | 苍穹应用 K8s Master、Zookeeper、RabbitMQ、Redis |
| 数据库服务器1 | 8 | 32 | 100 | 500 | 默认为postgre12.8数据库 | PostgreSQL数据库 |
| nginx服务器1 | 8 | 32 | 50 | 500 | 1，nginx单机<br/>2，ELK日志系统：elasticsearch 6.8.18、Logstash 6.8.18、kafka 2.12-3.2.0  | nginx、Elasticsearch、Logstash、Kafka |
| 总计 | 24 | 112 | 250 | 2024 |  |  |


## 环境检查命令
根据上述要求检查服务器配置，常用检查命令如下：

检测命令：

```shell
# 操作系统检测
cat /etc/os-release
# 麒麟系统专用命令
nkvers

# CPU检测
nproc

# 内存检测
free -h

# 磁盘空间检测
df -h

# 磁盘设备检测
lsblk

```

## 磁盘初始化（可选）
如果磁盘未分区和格式化，可参考以下步骤创建LVM卷：

```shell
#!/bin/bash
#查看未分区的磁盘
lsblk

#创建pv
pvcreate /dev/sdb			#/dev/sdb 替换为实际的磁盘名

#创建vg
vgcreate vg01 /dev/sdb		#vg01 vg名，自定义；/dev/sdb 替换为实际的磁盘名

#创建lv
lvcreate -l +100%free vg01	#+100%free 把vg所有的空间都给当前lv卷，vg01 vg名

#格式化
mkfs.xfs /dev/vg01/lvol0  #/dev/vg01/lvol0 lv逻辑卷名，替换成实际lv卷名

#创建挂载目录
mkdir /data

#挂载
mount /dev/vg01/lvol0  /data

#永久挂载
echo "/dev/vg01/lvol0  /data xfs defaults 0 0 ">> /etc/fstab
mount -a
```

# 部署安装器
## 上传并解压部署包
将下载的部署包上传到应用服务器1 的/data目录下，并解压：

```shell
# 上传部署包到/data目录后执行
unzip xxx.zip		#xxx.zip： 上传的部署包名

```

## 执行安装脚本
脚本执行过程中会检测系统内核、操作系统等环境，请根据提示进行操作。

```shell
# 切换到脚本目录
cd /data/singularity/bin

# 执行部署脚本
sh startup.sh

```

## 访问安装器
脚本执行完成后，会输出安装器的访问地址：

+ 需要开放服务器7618端口权限
+ 使用浏览器访问输出的地址
+ 登录密码为执行脚本时设置的密码

# 部署苍穹平台
登录安装器后，根据提示，填写对应信息

## 自主安装
![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047599580-663ea060-ed9d-4b1d-a7d0-96238ac59995.png)

## 填写服务器信息，选择安装组件(k8s-master、pgsql、中间件)
根据 **<font style="color:#DF2A3F;">步骤2.2</font>**  要求，选择安装对应的组件

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047599619-6cb127e5-ed89-4a6b-a522-391712ab5b38.png)

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047599645-ec8af644-128f-4eb0-8bd5-da5a532f7dee.png)

## 填写安装目录、苍穹应用信息，设置密码
![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047599703-0b322b43-f532-4703-a86c-f29c351f4779.png)

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047599653-fddd1a79-dad0-4df3-a490-4bc2f5f85e53.png)

产品配置完成后，点击下一步——>开始安装

等待安装完成

# fileserver容器配置持久化
标准版和紧凑版环境采用nfs共享存储持久化方式；

非高可用版，采用本地持久化方式，操作参照测试环境的 fileserver容器持久化。

```shell
# 查看容器状态（将name-space替换为实际的命名空间）
kubectl get pods -n name-space

# 创建持久化目录
mkdir /data/fileserver

# 导出fileserver的yaml文件
cd /opt
kubectl get deploy -n name-space fileserver -o yaml > /opt/fileserver.yaml

# 修改yaml文件，添加持久化配置
vim fileserver.yaml

```

在yaml文件中添加以下内容：

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759052800479-c4fa64f7-facf-407d-b2b3-0e77fde62380.png)

```shell
# 重启fileserver服务
kubectl delete -f /opt/fileserver.yaml
kubectl apply -f /opt/fileserver.yaml
```

# 系统配置
## 重置登录密码
根据安装器最后输出的网址、登录账号密码信息，登录对应的网页，根据提示修改以下系统的密码：

+ iERP系统
+ MC管理控制台
+ Monitor监控系统

## 配置monitor数据源
1.    登录Monitor系统（地址查看安装器安装完成后的输出）
2.    进入"系统配置" → "存储库配置" → "添加数据源"
3.    数据库选择PostgreSQL，IP地址和端口填写测试服务器的IP:5432
4.    数据库名可以登录数据库查看，选择带有secd的库

```shell
# 登录数据库服务器
su - postgres
psql
# 查看数据库列表
\l
```

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047898280-cc377a74-baa7-4704-b55d-2125ede50c46.png)

# 发布发票云全量包
## 最新全量包获取
联系相关技术人员获取最新的发票云全量包。

## 发布全量包
1.    登录MC管理控制台（地址参照第4步完成后输出的MC地址）
2.    进入"集群管理" → 选择对应集群 → "上传升级包"

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047974714-e11fcf79-bd41-4c2c-9f40-928aef1915c1.png)

3.    选择7.1节获取的全量包，点击上传
4.    上传完成后，点击"升级"

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759047993468-90b0a39b-dfdb-460d-b0fb-25d0b23fdf62.png)

5.    选择刚刚上传的包，点击"下一步"
6.    通过环境校验后，执行升级操作

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759048014134-12d7d642-839d-4410-a5d5-f615a32cc431.png)

7.    升级完成后，在集群管理列表节点点击"发布"

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759048030072-c1b76d0c-8e90-4c4f-bef9-45ae67c62cb3.png)

8.    登录服务器，重启以下容器服务：

```shell
# 重启相关容器（将name-space替换为实际的命名空间）
kubectl rollout restart deploy -n name-space mservice
kubectl rollout restart deploy -n name-space web
kubectl rollout restart deploy -n name-space mservice-qing
```

# 导入许可
1.    登录MC管理控制台
2.    选择"租户列表" → 选择对应租户ID → "许可信息" → "导入许可"
3.    选择许可文件并导入

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759048086086-5bfd702f-682f-4c12-8067-0c19ecde55bc.png)

# 部署验证
完成以上所有步骤后，请进行以下验证：  
1.	访问系统各功能模块，确认正常使用  
2.	检查日志系统，确认无异常错误  
3.	验证发票相关功能正常运行  
4.	确认监控系统数据采集正常

# 附录A：常见问题排查
## 安装器无法访问
+ 检查应用服务器1的7618端口是否开放
+ 检查防火墙设置
+ 确认安装器进程正常运行

## 容器启动失败
+ 检查资源是否充足
+ 查看容器日志定位问题：**kubectl logs -n <namespace> <pod-name>**

## 数据库连接失败
+ 检查数据库服务是否正常启动
+ 确认连接参数是否正确
+ 验证网络连通性





