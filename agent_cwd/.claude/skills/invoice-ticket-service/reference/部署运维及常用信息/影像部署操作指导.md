| **文档编号** | **适用产品版本** | **使用范围** | **更新内容** | **创建/更新时间** | **责任人** |
| :---: | :---: | :---: | :---: | :---: | :---: |
| **v25.0.01** | **标准版影像** | **公开** | 创建 | **2025-09-24** | **欧浩斌** |
| **v25.0.02** | **标准版影像** | **公开** | 新增对接云厂商对象存储 | **2025-11-20** | **欧浩斌** |


# 文档说明
本文档适用于私有化影像系统部署，文档包含测试环境部署以及三种生产环境部署方案。

本文档介绍的部署方案均为标准部署方案，客户可根据实际需求自行选择，如以下方案无法满足客户需求，可协商定制化部署方案。

# 测试环境部署方案
## 系统架构
单机部署，应用服务、数据库服务都部署在同一台服务器上

## 环境准备
服务器要求：

| 类别 | 操作系统 | CentOS7.X、麒麟v10x86、Redhat7.X | | | |
| :---: | :---: | --- | --- | --- | --- |
| | 主机名 | cpu（核） | 内存（G） | 系统盘（G） | 数据盘（G） |
| 应用服务器 | {IP} | 8 | 32 | 100 | 1024 |
| 合计 | 1 | 8 | 32 | 100 | 1024 |


#建议系统盘与数据盘分区管理

tips：如何创建lvm逻辑卷

```shell
#!/bin/bash
#查看未分区的磁盘
lsblk

#创建pv
pvcreate /dev/sdb			#/dev/sdb 替换为实际的磁盘名

#创建vg
vgcreate vg01 /dev/sdb		#vg01 vg名，自定义；/dev/sdb 替换为实际的磁盘名

#创建lv
lvcreate -l +100%free vg01	#+100%free 把vg所有的空间都给当前lv卷，vg01 vg名

#格式化
mkfs.xfs /dev/vg01/lvol0  #/dev/vg01/lvol0 lv逻辑卷名，替换成实际lv卷名

#创建挂载目录
mkdir /data

#挂载
mount /dev/vg01/lvol0  /data

#永久挂载
echo "/dev/vg01/lvol0  /data xfs defaults 0 0 ">> /etc/fstab
mount -a
```

部署安装包获取：

[http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz](http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz)

**账号：fpy**

**密码：Fpy@piaonzone2025#$****<font style="color:#8A8F8D;">（不定期修改，可联系发票云获取）</font>**

如何下载部署安装包：

a. 直接访问url地址，输入账号密码即可

b. 服务器可以访问公网的情况下，执行以下命令下载：

```shell
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz
```

#建议将安装包放在数据盘中，以下操作均以 /data 目录为例，请替换为实际目录。

##  部署操作流程
```shell
#!/bin/bash
#解压部署安装包
cd /data
tar xf install_imgarchive_docker.tar.gz

#执行部署安装脚本
cd /data/install_imgarchive_docker/
sh  install_imgarchive.sh single  本机IP  安装目录

#查看本机ip
hostname -I
```

## 检查部署是否完成
登录影像地址显示许可导入页面即安装完成

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707174823-1abdaef8-320e-4b32-a361-52c650668e40.png)

## 许可获取
获取发票云授权：<font style="color:#117CEE;">云之家——智能审批——搜索发票云</font>

产品选择： 电子影像服务_5.0  

其他信息根据实际情况填写

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707284823-e455683d-1888-4b6b-b2dd-a76cd7af17aa.png)

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707374213-de384638-5378-4993-9e1d-8a0ed8ef09c1.png)

# 2台服务器部署：1应用1数据库
## 系统架构


![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759023211710-e54de633-c2f0-4352-bedf-d4eb1bcd4da4.png)

## 环境准备
服务器要求：

| 类别 | 操作系统 | CentOS7.X、麒麟v10x86、Redhat7.X | | | |
| :---: | :---: | --- | --- | --- | --- |
| | 主机名 | cpu（核） | 内存（G） | 系统盘（G） | 数据盘（G） |
| 应用服务器1 | {IP} | 8 | 32 | 100 | 300 |
| 数据库服务器1 | {IP} | 4 | 16 | 50 | 1024 |
| 合计 | 2 | 12 | 48 | 150 | 1324 |


#建议系统盘与数据盘分区管理

tips：如何创建lvm逻辑卷

```shell
#!/bin/bash
#查看未分区的磁盘
lsblk

#创建pv
pvcreate /dev/sdb			#/dev/sdb 替换为实际的磁盘名

#创建vg
vgcreate vg01 /dev/sdb		#vg01 vg名，自定义；/dev/sdb 替换为实际的磁盘名

#创建lv
lvcreate -l +100%free vg01	#+100%free 把vg所有的空间都给当前lv卷，vg01 vg名

#格式化
mkfs.xfs /dev/vg01/lvol0  #/dev/vg01/lvol0 lv逻辑卷名，替换成实际lv卷名

#创建挂载目录
mkdir /data

#挂载
mount /dev/vg01/lvol0  /data

#永久挂载
echo "/dev/vg01/lvol0  /data xfs defaults 0 0 ">> /etc/fstab
mount -a
```

部署安装包获取：

[http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz](http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz)

账号密码：fpy   Fpy@piaonzone2025#$ 

#将部署包上传到两台服务器

如何下载部署安装包：

a. 直接访问url地址，输入账号密码即可

b. 服务器可以访问公网的情况下，执行以下命令下载：

```shell
#服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz
```

#建议将安装包放在数据盘中，以下操作均以 /data 目录为例，请替换为实际目录。

## 部署操作流程
```shell
#!/bin/bash
#数据库操作步骤
cd /data
tar xf install_imgarchive_docker.tar.gz
cd install_imgarchive_docker
vim config_install		#编写配置文件，只需填写以下内容
        #是否生产环境、是：true  否:false  默认为false
        isPro=false			#根据实际情况填写
        
        #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
        installPath=/data				#根据实际情况填写
        
        #port: 内网登录统一端口，默认为80
        port=18080			#根据实际情况填写
        ==================一台应用机器一台数据机器安装须填写======================================
        #根据部署架构填对应机器IP
        ###ArchiveApp：应用服务器本地IP
        ###ArchiveDB:  数据服务器本地ip
        ArchiveApp=应用服务器IP
        ArchiveDB=数据库服务器IP
        
sh install_imgarchive.sh dbinstall

#应用服务器操作步骤
cd /data
tar xf install_imgarchive_docker.tar.gz
cd install_imgarchive_docker
vim config_install		#编写配置文件，只需填写以下内容
      #是否生产环境、是：true  否:false  默认为false
      isPro=false
      
      #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
      installPath=/data
      
      #port: 内网登录统一端口，默认为80
      port=18080
      ==================一台应用机器一台数据机器安装须填写======================================
      #根据部署架构填对应机器IP
      ###ArchiveApp：应用服务器本地IP
      ###ArchiveDB:  数据服务器本地ip
      ArchiveApp=应用服务器IP
      ArchiveDB=数据库服务器IP

sh install_imgarchive.sh appinstall

```

# 4台服务器部署：2应用2数据库
## 系统架构
![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707843840-d89c38a9-332c-4106-b791-1c40ebacb4fe.png)

## 环境准备
服务器要求：

| 类别 | 操作系统 | CentOS7.X、麒麟v10x86、Redhat7.X | | | |
| :---: | :---: | --- | --- | --- | --- |
| | 主机名 | cpu（核） | 内存（G） | 系统盘（G） | 数据盘（G） |
| 应用服务器1 | {IP} | 8 | 32 | 100 | 300 |
| 应用服务器2 | {IP} | 8 | 32 | 100 | 300 |
| 数据库服务器1 | {IP} | 4 | 16 | 50 | 1024 |
| 数据库服务器2 | {IP} | 4 | 16 | 50 | 1024 |
| 合计 | 4 | 24 | 96 | 300 | 2648 |


#建议系统盘与数据盘分区管理

tips：如何创建lvm逻辑卷

```shell
#!/bin/bash
#查看未分区的磁盘
lsblk

#创建pv
pvcreate /dev/sdb			#/dev/sdb 替换为实际的磁盘名

#创建vg
vgcreate vg01 /dev/sdb		#vg01 vg名，自定义；/dev/sdb 替换为实际的磁盘名

#创建lv
lvcreate -l +100%free vg01	#+100%free 把vg所有的空间都给当前lv卷，vg01 vg名

#格式化
mkfs.xfs /dev/vg01/lvol0  #/dev/vg01/lvol0 lv逻辑卷名，替换成实际lv卷名

#创建挂载目录
mkdir /data

#挂载
mount /dev/vg01/lvol0  /data

#永久挂载
echo "/dev/vg01/lvol0  /data xfs defaults 0 0 ">> /etc/fstab
mount -a
```

部署安装包获取：

应用服务器：

[http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz](http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz)

数据库服务器：

[http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz](http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz)

[http://dl.piaozone.com:18025/download/image-archive/minio_install_single.tar.gz](http://dl.piaozone.com:18025/download/image-archive/minio_install_single.tar.gz)

账号密码：fpy   Fpy@piaonzone2025#$ 

#将部署包上传到对应的服务器

如何下载部署安装包：

a. 直接访问url地址，输入账号密码即可

b. 服务器可以访问公网的情况下，执行以下命令下载：

```shell
#应用服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz

#数据库服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/minio_install_single.tar.gz
```

#建议将安装包放在数据盘中，以下操作均以 /data 目录为例，请替换为实际目录。

## 部署操作流程
```shell
#!/bin/bash
#数据库1操作步骤——mysql安装
cd /data
tar xf sql_install.tar.gz
cd sql_install
sh install_mysql.sh master /data 数据库1-ip		#master：主节点  /data ：安装目录

#数据库1操作步骤——minio安装
cd /data
tar xf minio_install_single.tar.gz
cd minio_install_single
sh minio_install.sh /data			#/data：安装目录

#数据库2操作步骤——mysql安装
cd /data
tar xf sql_install.tar.gz
cd sql_install
sh install_mysql.sh slave /data 数据库1-ip		#slave：从节点  /data ：安装目录 ip写数据库1-IP

#数据库1操作步骤——minio安装
cd /data
tar xf minio_install_single.tar.gz
cd minio_install_single
sh minio_install.sh /data			#/data：安装目录

#应用服务器1操作步骤
cd /data
tar xf install_imgarchive_docker.tar.gz
cd install_imgarchive_docker
vim config_install		#编写配置文件，只需填写以下内容
      #是否生产环境、是：true  否:false  默认为false
      isPro=false
      
      #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
      installPath=/data
      
      #port: 内网登录统一端口，默认为80
      port=18080
      
      #根据部署架构填对应机器IP
      #ArchiveApp1：主节点应用服务器本地IP; ArchiveApp2:从节点应用服务器本地IP;
      #ArchiveDB1:mysql数据库主节点ip;ArchiveDB2:mysql数据库从节点ip
      #ArchiveMinio1、2、3、4:minio集群节点ip,只有两台都填一个ip
      ArchiveApp1=应用服务器1-IP
      ArchiveApp2=应用服务器2-IP
      ArchiveDB1=数据库服务器1-IP
      ArchiveDB2=数据库服务器2-IP
      ArchiveMinio1=数据库服务器1-IP
      ArchiveMinio2=数据库服务器1-IP
      ArchiveMinio3=数据库服务器1-IP
      ArchiveMinio4=数据库服务器1-IP
sh install_imgarchive.sh master

#应用服务器2操作步骤
cd /data
tar xf install_imgarchive_docker.tar.gz
cd install_imgarchive_docker
vim config_install		#编写配置文件，只需填写以下内容
      #是否生产环境、是：true  否:false  默认为false
      isPro=false
      
      #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
      installPath=/data
      
      #port: 内网登录统一端口，默认为80
      port=18080
      
      #根据部署架构填对应机器IP
      #ArchiveApp1：主节点应用服务器本地IP; ArchiveApp2:从节点应用服务器本地IP;
      #ArchiveDB1:mysql数据库主节点ip;ArchiveDB2:mysql数据库从节点ip
      #ArchiveMinio1、2、3、4:minio集群节点ip,只有两台都填一个ip
      ArchiveApp1=应用服务器1-IP
      ArchiveApp2=应用服务器2-IP
      ArchiveDB1=数据库服务器1-IP
      ArchiveDB2=数据库服务器2-IP
      ArchiveMinio1=数据库服务器1-IP
      ArchiveMinio2=数据库服务器1-IP
      ArchiveMinio3=数据库服务器1-IP
      ArchiveMinio4=数据库服务器1-IP
sh install_imgarchive.sh slave

```

## 检查部署是否完成
登录影像地址显示许可导入页面即安装完成

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707174823-1abdaef8-320e-4b32-a361-52c650668e40.png)

## 许可获取
生产许可由商务下单获取

# 8台服务器部署：2应用2数据库4文件存储
## 系统架构
![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1759023061414-44827123-4c1f-4bad-8e62-e05dde8dea19.png)

## 环境准备
服务器要求：

| 类别 | 操作系统 | CentOS7.X、麒麟v10x86、Redhat7.X | | | |
| :---: | :---: | --- | --- | --- | --- |
| | 主机名 | cpu（核） | 内存（G） | 系统盘（G） | 数据盘（G） |
| 应用服务器1 | {IP} | 8 | 32 | 100 | 300 |
| 应用服务器2 | {IP} | 8 | 32 | 100 | 300 |
| 数据库服务器1 | {IP} | 4 | 16 | 50 | 300 |
| 数据库服务器2 | {IP} | 4 | 16 | 50 | 300 |
| 文件服务器1 | {IP} | 4 | 8 | 50 | 1024 |
| 文件服务器2 | {IP} | 4 | 8 | 50 | 1024 |
| 文件服务器3 | {IP} | 4 | 8 | 50 | 1024 |
| 文件服务器4 | {IP} | 4 | 8 | 50 | 1024 |
| 合计 | 8 | 40 | 128 | 500 | 5296 |


#建议系统盘与数据盘分区管理

tips：如何创建lvm逻辑卷

```shell
#!/bin/bash
#查看未分区的磁盘
lsblk

#创建pv
pvcreate /dev/sdb			#/dev/sdb 替换为实际的磁盘名

#创建vg
vgcreate vg01 /dev/sdb		#vg01 vg名，自定义；/dev/sdb 替换为实际的磁盘名

#创建lv
lvcreate -l +100%free vg01	#+100%free 把vg所有的空间都给当前lv卷，vg01 vg名

#格式化
mkfs.xfs /dev/vg01/lvol0  #/dev/vg01/lvol0 lv逻辑卷名，替换成实际lv卷名

#创建挂载目录
mkdir /data

#挂载
mount /dev/vg01/lvol0  /data

#永久挂载
echo "/dev/vg01/lvol0  /data xfs defaults 0 0 ">> /etc/fstab
mount -a
```

部署安装包获取：

应用服务器：

[http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz](http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz)

数据库服务器：

[http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz](http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz)

文件服务器：

[http://dl.piaozone.com:18025/download/image-archive/minio_install_cluster.tar.gz](http://dl.piaozone.com:18025/download/image-archive/minio_install_single.tar.gz)

账号密码：fpy   Fpy@piaonzone2025#$ 

#将部署包上传到对应的服务器

如何下载部署安装包：

a. 直接访问url地址，输入账号密码即可

b. 服务器可以访问公网的情况下，执行以下命令下载：

```shell
#应用服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/install_imgarchive_docker.tar.gz

#数据库服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/sql_install.tar.gz

#文件服务器
wget --http-user=fpy --http-password=Fpy@piaonzone2025#$ http://dl.piaozone.com:18025/download/image-archive/minio_install_cluster.tar.gz
```

#建议将安装包放在数据盘中，以下操作均以 /data 目录为例，请替换为实际目录。

## 部署操作流程
```shell
#!/bin/bash
#数据库服务器1-部署操作
cd /data		#切换工作目录
tar xf sql_install.tar.gz			#解压部署包
cd sql_install		#进入解压目录
sh install_mysql.sh master /data 数据库服务器1-IP		#执行部署脚本

#数据库服务器2-部署操作
cd /data		#切换工作目录
tar xf sql_install.tar.gz			#解压部署包
cd sql_install		#进入解压目录
sh install_mysql.sh salve /data 数据库服务器1-IP		#注意：此处IP需要填写数据库1-IP

#文件服务器-操作流程   四台操作流程一致
cd /data			#切换工作目录
tar xf minio_install_cluster.tar.gz			#解压部署包
cd minio_install_cluster		#进入解压目录
vim config_install		#编写配置文件，内容如下
    # 安装目录默认为/data
    instll_path=/data
    
    # minio四个机器ip，四个机器配置一样
    minio1_ip=
    minio2_ip=
    minio3_ip=
    minio4_ip=
sh minio_install.sh /data/ 本机IP   #执行部署脚本，/data/:安装目录  

#应用服务器1-部署操作
cd /data		#切换工作目录
tar xf install_imgarchive_docker.tar.gz			#解压部署包
cd install_imgarchive_docker		#进入解压目录
vim /config_install		#编写配置文件，内容如下
    #是否生产环境、是：true  否:false  默认为false
    isPro=false
    
    #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
    installPath=/data
    
    #port: 内网登录统一端口，默认为80
    port=18080
    
    #根据部署架构填对应机器IP
    #ArchiveApp1：主节点应用服务器本地IP; ArchiveApp2:从节点应用服务器本地IP;
    #ArchiveDB1:mysql数据库主节点ip;ArchiveDB2:mysql数据库从节点ip
    #ArchiveMinio1、2、3、4:minio集群节点ip,只有两台都填一个ip
    ArchiveApp1=应用服务器1-IP
    ArchiveApp2=应用服务器2-IP
    ArchiveDB1=数据库服务器1-IP
    ArchiveDB2=数据库服务器2-IP
    ArchiveMinio1=文件服务器1-IP
    ArchiveMinio2=文件服务器2-IP
    ArchiveMinio3=文件服务器3-IP
    ArchiveMinio4=文件服务器4-IP
sh install_imgarchive.sh master		#执行部署脚本

#应用服务器2-部署操作
cd /data		#切换工作目录
tar xf install_imgarchive_docker.tar.gz			#解压部署包
cd install_imgarchive_docker			#进入解压目录
vim config_install		#编写配置文件，内容如下
    #是否生产环境、是：true  否:false  默认为false
    isPro=false
    
    #安装目录，应用程序安装所在路径，非/root目录下最大磁盘,结尾不能带/
    installPath=/data
    
    #port: 内网登录统一端口，默认为80
    port=18080
    
    #根据部署架构填对应机器IP
    #ArchiveApp1：主节点应用服务器本地IP; ArchiveApp2:从节点应用服务器本地IP;
    #ArchiveDB1:mysql数据库主节点ip;ArchiveDB2:mysql数据库从节点ip
    #ArchiveMinio1、2、3、4:minio集群节点ip,只有两台都填一个ip
    ArchiveApp1=应用服务器1-IP
    ArchiveApp2=应用服务器2-IP
    ArchiveDB1=数据库服务器1-IP
    ArchiveDB2=数据库服务器2-IP
    ArchiveMinio1=文件服务器1-IP
    ArchiveMinio2=文件服务器2-IP
    ArchiveMinio3=文件服务器3-IP
    ArchiveMinio4=文件服务器4-IP
sh install_imgarchive.sh slave		#执行部署脚本


```

## 检查部署是否完成
影像地址显示许可导入页面即安装完成

![](https://cdn.nlark.com/yuque/0/2025/png/21778712/1758707174823-1abdaef8-320e-4b32-a361-52c650668e40.png)

## 许可获取
生产许可由商务下单获取

#  对接云厂商对象存储
目前支持的云厂商对象存储包括： 亚马逊云aws、华为云obs、阿里云oss

需提供如下云存储信息：

        * 对象存储连接地址
        * 连接AK、SK
        * 存储桶名

根据部署方案部署好系统后，修改zk连接配置即可，修改&新增内容如下：

其中，storeType代表对接不同对象存储，<font style="color:black;background-color:#FFFFFF;">1-aws、2-minio、3-obs、4-oss</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=storeType=3 </font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=ACCESS_KEY_ID=对象存储AK</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=SECRET_KEY_ID=对象存储SK</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=ERP_ARCHIVE_BUCKET_NAME=存储桶名</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=SCAN_BUCKET_NAME=存储桶名</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive/pri=endPoint=连接地址</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=storeType=3 </font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=ACCESS_KEY_ID=对象存储AK</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=SECRET_KEY_ID=对象存储SK</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=ERP_ARCHIVE_BUCKET_NAME=存储桶名</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=SCAN_BUCKET_NAME=存储桶名</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-scan/pri=endPoint=连接地址</font>

<font style="color:black;background-color:#FFFFFF;">/api-archive-invoice/pri=BUCKET_NAME=存储桶名</font>

<font style="color:black;background-color:#FFFFFF;"></font>

<font style="color:black;background-color:#FFFFFF;">修改zk配置后，需重启应用服务后生效。</font>









