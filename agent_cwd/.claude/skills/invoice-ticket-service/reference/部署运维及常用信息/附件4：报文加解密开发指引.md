 

 

 

 

 

 

 

 

乐企数字开放平台 

接入单位安全加解密指南 

 

 

 

 

 

 

<font style="color:#333333;">2024年03月22日 </font>

 

 

 

 

 

 

 

修改说明<sub> </sub>

| **版本**  | **章节编号**  | **修订内容简述**  | **生效日期**  |
| --- | --- | --- | --- |
| V1.000  | 全部  | 新建文档  | 2024-3-22  |


 

 

[<font style="color:#2E74B5;">目录 </font>**一、接入单位密钥**	1 ](#_Toc10650)

[**二、报文加解密规则**	1 ](#_Toc10651)

[**三、加解密示例代码**	1 ](#_Toc10652)

[**1.openssl**	2 ](#_Toc10653)

[**2.Java**	4 ](#_Toc10654)



 

 



<font style="color:#1A1A1A;">一、接入单位密钥</font> 

<font style="color:#333333;">接入单位登录乐企数字开放平台-准入管理-安全密钥模块申请安全密钥。</font> 

# 二、报文加解密规则 
1. <font style="color:#333333;">请求加密</font> 

<font style="color:#333333;">请求需要对 http 请求中的 body报文进行整体加密，header中的数据无需加密。 </font>

1. <font style="color:#333333;">返回解密</font> 

<font style="color:#333333;">返回的报文中，如果是失败的或者异常的请求会返回原始报文。正常返回情况下，只对 Data 中的业务报文进行加密，客户端只需要解密 Data 中的内容即可。 </font>

# 三、加解密示例代码 
<font style="color:#333333;">示例密钥（16 进制）：0900*************************5d21</font> 

<font style="color:#FF0000;">说明：此处仅作为代码示例，真实环境请使用获取的 SM4 密钥。 </font>

## 1.openssl 
#### （1）加密<font style="color:#000000;"> </font>
 

<font style="color:#669900;">echo "加密原文 original text" </font><font style="color:#9A6E3A;">> </font>a.txt openssl enc -e -in a.txt -out b.txt --base64 -sm4-ecb -K 

0900**************************5d21 <font style="color:#DD4A68;">cat </font>b.txt 

 

<font style="color:#333333;">控制台输出：SzLrbxnqCXgRE0JT/V603Kr+hkctNf2lTZFzejcIJdA=</font>

 

<font style="color:#4D4D4D;">命令行解释：</font> 

<font style="color:#C7254E;">-e  </font><font style="color:#4D4D4D;">表示 加密</font> 

<font style="color:#C7254E;">-in  </font><font style="color:#4D4D4D;">指定的文件进行加密处理</font>

 

<font style="color:#C7254E;">-out </font><font style="color:#4D4D4D;">指定加密后内容的输出文件</font> 

<font style="color:#C7254E;">-K  </font><font style="color:#4D4D4D;">指定 16 进制编码的密码</font> 

<font style="color:#C7254E;">--base64  </font><font style="color:#4D4D4D;">指定密文按照 base64 进行编码 </font>

#### （2）解密<font style="color:#000000;"> </font>
 

openssl enc -in b.txt -out c.txt --base64 -d -sm4-ecb -K 

0900*************************5d21 <font style="color:#DD4A68;">cat </font>c.txt 

 

<font style="color:#4D4D4D;">命令行解释：</font>

 

<font style="color:#C7254E;">-d  </font><font style="color:#4D4D4D;">表示解密</font> 

<font style="color:#C7254E;">-in  </font><font style="color:#4D4D4D;">指定的文件进行解密处理</font>

 

<font style="color:#C7254E;">-out </font><font style="color:#4D4D4D;">指定解密后内容的输出文件</font> 

<font style="color:#C7254E;">-K  </font><font style="color:#4D4D4D;">指定 16 进制编码的密码</font> 

<font style="color:#C7254E;">--base64  </font><font style="color:#4D4D4D;">指定密文按照 base64 进行编码</font> 

#### （3）比较加密解密<font style="color:#000000;"> </font>
md5sum a.txt c.txt 

 

<font style="color:#333333;">输出</font> 

<font style="color:#333333;">5f1575274904b0821dca69410848022d    a.txt </font>

<font style="color:#333333;">5f1575274904b0821dca69410848022d    c.txt</font> 

## 2.Java<font style="color:#000000;"> </font>
<font style="color:#333333;">通过 java 加解密需要增加以下依赖</font> 

 

<font style="color:#990055;"><dependency></font> 

<font style="color:#990055;"><groupId></font>org.bouncycastle<font style="color:#990055;"></groupId></font> 

<font style="color:#990055;"><artifactId></font>bcprov-jdk15to18<font style="color:#990055;"></artifactId></font> 

<font style="color:#990055;"><version></font>1.71<font style="color:#990055;"></version></font> 

<font style="color:#990055;"></dependency></font> 

 

#### （1）示例代码<font style="color:#000000;"> </font>
<font style="color:#0077AA;">import </font>org .bouncycastle .j ce .provider.<font style="color:#DD4A68;">BouncyCastleProvider</font><font style="color:#999999;">; </font><font style="color:#0077AA;">import </font>org .bouncycastle .pqc .math.linearalgebra.<font style="color:#DD4A68;">ByteUtils</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>org .bouncycastle .util.encoders .<font style="color:#DD4A68;">Hex</font><font style="color:#999999;">;</font> 

 

 

<font style="color:#0077AA;">import </font>javax .crypto .<font style="color:#DD4A68;">Cipher</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>javax .crypto .<font style="color:#DD4A68;">KeyGenerator</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>javax .crypto .spec.<font style="color:#DD4A68;">SecretKeySpec</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.nio.charset .<font style="color:#DD4A68;">Charset</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.nio.charset .<font style="color:#DD4A68;">StandardCharsets</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.security.<font style="color:#DD4A68;">Key</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.security.<font style="color:#DD4A68;">SecureRandom</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.security.<font style="color:#DD4A68;">Security</font><font style="color:#999999;">;</font> <font style="color:#0077AA;">import </font>java.util .<font style="color:#DD4A68;">Base64</font><font style="color:#999999;">;</font> 

 

 

<font style="color:#0077AA;">public class </font><font style="color:#DD4A68;">SM4Util </font><font style="color:#999999;">{</font> 

 

 

<font style="color:#0077AA;">static </font><font style="color:#999999;">{</font> 

<font style="color:#DD4A68;">Security </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">addProvider </font><font style="color:#999999;">(</font><font style="color:#0077AA;">new </font><font style="color:#DD4A68;">BouncyCastleProvider </font><font style="color:#999999;">());</font> 

<font style="color:#999999;">}</font> 

 

<font style="color:#0077AA;">private static final </font><font style="color:#DD4A68;">Charset </font>ENCODING <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">StandardCharsets </font><font style="color:#999999;">.</font>UTF_8<font style="color:#999999;">;</font> 

<font style="color:#0077AA;">public static final </font><font style="color:#DD4A68;">String </font>ALGORITHM_NAME <font style="color:#9A6E3A;">= </font><font style="color:#669900;">"SM4"</font><font style="color:#999999;">;</font>

 

<font style="color:#708090;">// 加密算法/分组加密模式/分组填充方式</font> 

<font style="color:#708090;">// PKCS5Padding-以 8 个字节为一组进行分组加密</font> <font style="color:#708090;">// 定义分组加密模式使用：PKCS5Padding</font> 

<font style="color:#0077AA;">public static final </font><font style="color:#DD4A68;">String </font>ALGORITHM_NAME_ECB_PADDING <font style="color:#9A6E3A;">=</font>

 <font style="color:#669900;">"SM4/ECB/PKCS5Padding"</font><font style="color:#999999;">;</font> 

 

 

<font style="color:#708090;">/**</font> 

+ <font style="color:#708090;">生成 ECB 暗号</font> 

<font style="color:#708090;">*</font> 

+ <font style="color:#708090;">@param algorithmName 算法名称</font> 
+ <font style="color:#708090;">@param mode 模式</font> 
+ <font style="color:#708090;">@param key 密码</font> 
+ <font style="color:#708090;">@explain ECB 模式（电子密码本模式：Electronic codebook） </font>

<font style="color:#708090;">*/</font> <font style="color:#0077AA;">private static </font><font style="color:#DD4A68;">Cipher generateEcbCipher </font><font style="color:#999999;">(</font><font style="color:#DD4A68;">String </font>algorithmName<font style="color:#999999;">, </font><font style="color:#0077AA;">int </font>mode<font style="color:#999999;">,</font> <font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>key<font style="color:#999999;">) </font><font style="color:#0077AA;">throws </font><font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#DD4A68;">Cipher </font>cipher <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">Cipher </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">getInstance </font><font style="color:#999999;">(</font>algorithmName<font style="color:#999999;">,</font>

 

<font style="color:#DD4A68;">BouncyCastleProvider </font><font style="color:#999999;">.</font>PROVIDER_NAME<font style="color:#999999;">);</font> 

<font style="color:#DD4A68;">Key </font>sm4Key <font style="color:#9A6E3A;">= </font><font style="color:#0077AA;">new </font><font style="color:#DD4A68;">SecretKeySpec </font><font style="color:#999999;">(</font>key<font style="color:#999999;">, </font>ALGORITHM_NAME<font style="color:#999999;">);</font> cipher <font style="color:#999999;">.</font><font style="color:#DD4A68;">init</font><font style="color:#999999;">(</font>mode<font style="color:#999999;">, </font>sm4Key<font style="color:#999999;">);</font> <font style="color:#0077AA;">return </font>cipher<font style="color:#999999;">;</font> 

<font style="color:#999999;">}</font> 

 

 

<font style="color:#708090;">/**</font> 

+ <font style="color:#708090;">sm4 加密</font> 

<font style="color:#708090;">*</font> 

+ <font style="color:#708090;">@param hexKey 16 进制密钥（忽略大小写）</font> 
+ <font style="color:#708090;">@param paramStr 待加密字符串</font> 
+ <font style="color:#708090;">@return 返回 Base64 后加密字符串</font> 
+ <font style="color:#708090;">@explain 加密模式：ECB </font>

<font style="color:#708090;">*/</font> <font style="color:#0077AA;">public static </font><font style="color:#DD4A68;">String encryptEcb</font><font style="color:#999999;">(</font><font style="color:#DD4A68;">String </font>hexKey<font style="color:#999999;">, </font><font style="color:#DD4A68;">String </font>paramStr<font style="color:#999999;">) </font><font style="color:#0077AA;">throws</font> 

<font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#708090;">// 16 进制字符串-->byte []</font> 

<font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>keyData <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">ByteUtils </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">fromHexString</font><font style="color:#999999;">(</font>hexKey<font style="color:#999999;">);</font>

 

<font style="color:#708090;">// String-->byte []</font> 

<font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>srcData <font style="color:#9A6E3A;">= </font>paramStr <font style="color:#999999;">.</font><font style="color:#DD4A68;">getBytes </font><font style="color:#999999;">(</font>ENCODING<font style="color:#999999;">);</font>

 

<font style="color:#708090;">// 加密后的数组</font> 

<font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>cipherArray <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">encrypt_Ecb_Padding</font><font style="color:#999999;">(</font>keyData<font style="color:#999999;">, </font>srcData<font style="color:#999999;">); </font><font style="color:#708090;">// byte []-->hexString</font> 

<font style="color:#DD4A68;">String </font>cipherText <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">Base64 </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">getEncoder </font><font style="color:#999999;">().</font><font style="color:#DD4A68;">encodeToString</font><font style="color:#999999;">(</font>cipherArray<font style="color:#999999;">);</font> <font style="color:#0077AA;">return </font>cipherText<font style="color:#999999;">;</font> 

<font style="color:#999999;">}</font> 

 

 

<font style="color:#708090;">/**</font> 

+ <font style="color:#708090;">加密模式为 ECB</font> 

<font style="color:#708090;">*</font> 

+ <font style="color:#708090;">@param key 2 进制密钥</font> 
+ <font style="color:#708090;">@param data 2 进制原文</font> 
+ <font style="color:#708090;">@return 二进制密文</font> 

<font style="color:#708090;">*/</font> <font style="color:#0077AA;">public static byte </font><font style="color:#999999;">[] </font><font style="color:#DD4A68;">encrypt_Ecb_Padding</font><font style="color:#999999;">(</font><font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>key<font style="color:#999999;">, </font><font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>data<font style="color:#999999;">) </font><font style="color:#0077AA;">throws</font> 

<font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#DD4A68;">Cipher </font>cipher <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">generateEcbCipher </font><font style="color:#999999;">(</font>ALGORITHM_NAME_ECB_PADDING<font style="color:#999999;">,</font> <font style="color:#DD4A68;">Cipher </font><font style="color:#999999;">.</font>ENCRYPT_MODE<font style="color:#999999;">, </font>key<font style="color:#999999;">);</font> <font style="color:#0077AA;">return </font>cipher <font style="color:#999999;">.</font><font style="color:#DD4A68;">doFinal</font><font style="color:#999999;">(</font>data<font style="color:#999999;">);</font> 

<font style="color:#999999;">}</font> 

 

 

<font style="color:#708090;">/**</font> 

+ <font style="color:#708090;">sm4 解密</font> 

<font style="color:#708090;">*</font> 

+ <font style="color:#708090;">@param hexKey 16 进制密钥</font> 
+ <font style="color:#708090;">@param cipherText 16 进制的加密字符串（忽略大小写）</font> 
+ <font style="color:#708090;">@return 解密后的字符串</font> 
+ <font style="color:#708090;">@explain 解密模式：采用 ECB </font>

<font style="color:#708090;">*/</font> 

@SuppressWarnings <font style="color:#999999;">(</font><font style="color:#669900;">"UnnecessaryLocalVariable"</font><font style="color:#999999;">)</font> <font style="color:#0077AA;">public static </font><font style="color:#DD4A68;">String decryptEcb</font><font style="color:#999999;">(</font><font style="color:#DD4A68;">String </font>hexKey<font style="color:#999999;">, </font><font style="color:#DD4A68;">String </font>cipherText<font style="color:#999999;">) </font><font style="color:#0077AA;">throws</font> 

<font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#708090;">// hexString-->byte []</font>

<font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>keyData <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">ByteUtils </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">fromHexString</font><font style="color:#999999;">(</font>hexKey<font style="color:#999999;">);</font>

 

<font style="color:#708090;">// hexString-->byte []</font> <font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>cipherData <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">Base64 </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">getDecoder </font><font style="color:#999999;">().</font><font style="color:#DD4A68;">decode </font><font style="color:#999999;">(</font>cipherText<font style="color:#999999;">); </font>

<font style="color:#708090;">// 解密</font> 

<font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>srcData <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">decrypt_Ecb_Padding</font><font style="color:#999999;">(</font>keyData<font style="color:#999999;">, </font>cipherData<font style="color:#999999;">); </font>

<font style="color:#708090;">// 接收解密后的字符串 byte []-->String</font> 

<font style="color:#DD4A68;">String </font>decryptStr <font style="color:#9A6E3A;">= </font><font style="color:#0077AA;">new </font><font style="color:#DD4A68;">String</font><font style="color:#999999;">(</font>srcData<font style="color:#999999;">, </font>ENCODING<font style="color:#999999;">);</font> <font style="color:#0077AA;">return </font>decryptStr<font style="color:#999999;">;</font> 

<font style="color:#999999;">}</font> 

 

 

<font style="color:#708090;">/**</font> 

+ <font style="color:#708090;">sm4 解密</font> 

<font style="color:#708090;">*</font> 

+ <font style="color:#708090;">@param key 2 进制密钥</font> 
+ <font style="color:#708090;">@param cipherText 2 进制密文</font> 
+ <font style="color:#708090;">@return 解密后的 2 进制原文</font> 

<font style="color:#708090;">*/</font> <font style="color:#0077AA;">public static byte </font><font style="color:#999999;">[] </font><font style="color:#DD4A68;">decrypt_Ecb_Padding</font><font style="color:#999999;">(</font><font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>key<font style="color:#999999;">, </font><font style="color:#0077AA;">byte </font><font style="color:#999999;">[] </font>cipherText<font style="color:#999999;">) </font><font style="color:#0077AA;">throws </font><font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#DD4A68;">Cipher </font>cipher <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">generateEcbCipher </font><font style="color:#999999;">(</font>ALGORITHM_NAME_ECB_PADDING<font style="color:#999999;">,</font> <font style="color:#DD4A68;">Cipher </font><font style="color:#999999;">.</font>DECRYPT_MODE<font style="color:#999999;">, </font>key<font style="color:#999999;">);</font> <font style="color:#0077AA;">return </font>cipher <font style="color:#999999;">.</font><font style="color:#DD4A68;">doFinal</font><font style="color:#999999;">(</font>cipherText<font style="color:#999999;">);</font> 

<font style="color:#999999;">}</font> 

<font style="color:#999999;">}</font> 

  

#### （2）测试片段<font style="color:#000000;"> </font>
<font style="color:#333333;">以下示例中数据使用 openssl 中生成结果进行比对</font> 

@Test 

<font style="color:#0077AA;">void </font><font style="color:#DD4A68;">testFromOpenSSL</font><font style="color:#999999;">() </font><font style="color:#0077AA;">throws </font><font style="color:#DD4A68;">Exception </font><font style="color:#999999;">{</font> 

<font style="color:#DD4A68;">String </font>source <font style="color:#9A6E3A;">= </font><font style="color:#669900;">"加密原文 original text\n"</font><font style="color:#999999;">;</font> 

<font style="color:#DD4A68;">String </font>key <font style="color:#9A6E3A;">= </font>"0900*************************5d21"<font style="color:#999999;">; </font><font style="color:#DD4A68;">String </font>cipher <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">SM4Util</font><font style="color:#999999;">.</font><font style="color:#DD4A68;"> encryptEcb</font><font style="color:#999999;">(</font>key<font style="color:#999999;">, </font>source<font style="color:#999999;">);</font>

<font style="color:#DD4A68;">assertThat</font><font style="color:#999999;">(</font>cipher<font style="color:#999999;">)</font> 

<font style="color:#999999;">.</font><font style="color:#DD4A68;">isEqualTo </font><font style="color:#999999;">(</font><font style="color:#669900;">"SzLrbxnqCXgRE0JT/V603Kr+hkctNf2lTZF zejc IJdA=" </font><font style="color:#999999;">);</font> 

<font style="color:#DD4A68;">String </font>res <font style="color:#9A6E3A;">= </font><font style="color:#DD4A68;">SM4Util </font><font style="color:#999999;">.</font><font style="color:#DD4A68;">decryptEcb</font><font style="color:#999999;">(</font>key<font style="color:#999999;">,</font> 

<font style="color:#669900;">"SzLrbxnqCXgRE0JT/V603Kr+hkctNf2lTZF zejc IJdA="</font><font style="color:#999999;">);</font> 

<font style="color:#DD4A68;">assertThat</font><font style="color:#999999;">(</font>res<font style="color:#999999;">).</font><font style="color:#DD4A68;">isEqualTo </font><font style="color:#999999;">(</font>source<font style="color:#999999;">);</font>

 <font style="color:#999999;">}</font> 

